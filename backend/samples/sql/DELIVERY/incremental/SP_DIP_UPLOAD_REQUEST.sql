CREATE OR REPLACE PROCEDURE SP_DIP_UPLOAD_REQUEST(IN P_CREUSR_CF CHARACTER(4) DEFAULT 'GE21',
IN P_LSTUPDUSR_CF CHARACTER(4) DEFAULT 'GE21',
IN P_FILE_NAME VARCHAR(128),
IN P_BUSINESS_UNIT_ID VARCHAR(64),
IN P_TYPE_OF_DATA_ID VARCHAR(64),
IN P_STATUS_ID VARCHAR(64),
IN P_MODELLING_REGION_ID INTEGER DEFAULT NULL,
IN P_YEAR_ID INTEGER DEFAULT NULL,
IN P_QUARTER_ID INTEGER DEFAULT NULL,
IN P_TYPE_OF_PROJECTION_ID INTEGER DEFAULT NULL,
IN P_RDWH_B SMALLINT DEFAULT NULL,
IN P_SOURCE_SYSTEM_ID INTEGER DEFAULT NULL,
IN P_UPLOAD_TYPE_ID INTEGER DEFAULT NULL)
SPECIFIC SP_DIP_UPLOAD_REQUEST RESULT SETS 1
MODIFIES SQL DATA
NOT
DETERMINISTIC NULL CALL
LANGUAGE SQL EXTERNAL ACTION
INHERIT SPECIAL REGISTERS
BEGIN
DECLARE v_BUId BIGINT;

DECLARE v_TODId BIGINT;

DECLARE v_StatusId BIGINT;


SELECT
   REFCODVAL_ID
INTO    v_BUId
FROM    REFCODVAL
WHERE    UPPER(TRIM(REFERENCE_CODE_VALUE)) = UPPER(TRIM(P_BUSINESS_UNIT_ID));


SELECT
   REFCODVAL_ID
INTO    v_TODId
FROM    REFCODVAL
WHERE    UPPER(TRIM(REFERENCE_CODE_VALUE)) = UPPER(TRIM(P_TYPE_OF_DATA_ID));


SELECT
   REFCODVAL_ID
INTO    v_StatusId
FROM    REFCODVAL
WHERE    UPPER(TRIM(REFERENCE_CODE_VALUE)) = UPPER(TRIM(P_STATUS_ID));

BEGIN
INSERT
   INTO    UPLOAD_REQUEST( CREUSR_CF ,
   LSTUPDUSR_CF ,
   FILE_NAME ,
   REQUEST_DATE ,
   UPLOAD_DATE ,
   BUSINESS_UNIT_ID ,
   TYPE_OF_DATA_ID ,
   STATUS_ID ,
   MODELLING_REGION_ID ,
   YEAR_ID ,
   QUARTER_ID ,
   TYPE_OF_PROJECTION_ID ,
   RDWH_B ,
   SOURCE_SYSTEM_ID ,
   UPLOAD_TYPE_ID ,
   INSERT_DATE ,
   PROCESSED_DATE ,
   VALIDATION_STATUS_ID ,
   BUSINESS_VALIDATION_STATUS_ID ,
   VALIDATION_DATE ,
   BUSINESS_USER_ID ,
   MAIN_REQUEST_ID )
SELECT
   'GE21' AS CREUSR_CF ,
   'GE21' AS LSTUPDUSR_CF ,
   P_FILE_NAME AS FILE_NAME ,
   CURRENT_TIMESTAMP AS REQUEST_DATE ,
   CURRENT_TIMESTAMP AS UPLOAD_DATE ,
   COALESCE(v_BUId,
   NULL) AS BUSINESS_UNIT_ID ,
   COALESCE(v_TODId,
   NULL) AS TYPE_OF_DATA_ID ,
   COALESCE(v_StatusId,
   NULL) AS STATUS_ID ,
   COALESCE(P_MODELLING_REGION_ID,
   NULL) AS MODELLING_REGION_ID ,
   COALESCE(P_YEAR_ID,
   NULL) AS YEAR_ID ,
   COALESCE(P_QUARTER_ID,
   NULL) AS QUARTER_ID ,
   COALESCE(P_TYPE_OF_PROJECTION_ID,
   NULL) AS TYPE_OF_PROJECTION_ID ,
   COALESCE(P_RDWH_B,
   NULL) AS RDWH_B ,
   COALESCE(P_SOURCE_SYSTEM_ID,
   NULL) AS SOURCE_SYSTEM_ID ,
   COALESCE(P_UPLOAD_TYPE_ID,
   NULL) AS UPLOAD_TYPE_ID ,
   NULL AS INSERT_DATE ,
   NULL AS PROCESSED_DATE ,
   NULL AS VALIDATION_STATUS_ID ,
   NULL AS BUSINESS_VALIDATION_STATUS_ID ,
   NULL AS VALIDATION_DATE ,
   NULL AS BUSINESS_USER_ID ,
   NULL AS MAIN_REQUEST_ID
FROM    SYSIBM.SYSDUMMY1;


COMMIT;

END;

BEGIN
DECLARE C1 CURSOR WITH RETURN FOR
SELECT
   MAX(REQUEST_ID) AS REQUEST_ID
FROM    UPLOAD_REQUEST;


OPEN C1;

END;

END;