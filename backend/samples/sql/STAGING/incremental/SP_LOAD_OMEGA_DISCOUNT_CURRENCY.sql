SET SCHEMA STAGING_<env>;

DROP PROCEDURE SP_LOAD_OMEGA_DISCOUNT_CURRENCY;

CREATE OR REPLACE PROCEDURE SP_LOAD_OMEGA_DISCOUNT_CURRENCY(
	BIGINT,
	CHARACTER VARYING(64),
	CHARACTER VARYING(64)
) 
RETURNS INTEGER
language nzplsql
AS
BEGIN_PROC

DECLARE
	P_REQUEST_ID	ALIAS FOR $1;
    P_TRG_SCHEMA	ALIAS FOR $2;
    P_TRG_TABLE		ALIAS FOR $3;
	V_INS_DC		VARCHAR(ANY);
	L_ERR_CD		CHAR(5);
	L_ERR_MSG		VARCHAR(32000);

BEGIN
	SET ISOLATION TO UR;

	V_INS_DC := 'INSERT INTO ' || P_TRG_SCHEMA || '.' || P_TRG_TABLE || ' (
		CURRENCY_CODE,
		DISCOUNT_CURRENCY_CODE,
		LOB_CODE,
		REQUEST_ID
	)
	SELECT
		CURRENCY_CODE,
		DISCOUNT_CURRENCY_CODE,
		NULL AS LOB_CODE,
		REQUEST_ID
	FROM
		(
			SELECT
				CUR_CF AS CURRENCY_CODE,
				GRPCUR_CF AS DISCOUNT_CURRENCY_CODE,
				RANK() OVER (PARTITION BY CUR_CF ORDER BY CRE_D DESC) AS LATEST,
				' || P_REQUEST_ID || ' AS REQUEST_ID
			FROM
				BI_<env>.TCURSII
		)
	WHERE
		LATEST = 1
	UNION ALL
	SELECT
		CURRENCY_CODE,
		DISCOUNT_CURRENCY_CODE,
		''30'' AS LOB_CODE,
		REQUEST_ID
	FROM
		(
			SELECT
				CUR_CF AS CURRENCY_CODE,
				GRPCUR_CF AS DISCOUNT_CURRENCY_CODE,
				RANK() OVER (PARTITION BY CUR_CF ORDER BY CRE_D DESC) AS LATEST,
				' || P_REQUEST_ID || ' AS REQUEST_ID
			FROM
				BI_<env>.TCURSIILIFE
		)
	WHERE
		LATEST = 1';
	
	EXECUTE IMMEDIATE 'DELETE FROM ' || P_TRG_SCHEMA || '.' || P_TRG_TABLE || ' WHERE REQUEST_ID = ' || P_REQUEST_ID;

	RAISE NOTICE 'Executing V_INS_DC: ''%''', V_INS_DC;

	EXECUTE IMMEDIATE V_INS_DC;

EXCEPTION 
	WHEN OTHERS THEN 
		L_ERR_CD := SUBSTR(SQLERRM, 8, 5); 
		L_ERR_MSG := SQLERRM; 
		RAISE EXCEPTION '% Error while executing SQL statement', L_ERR_MSG; 
		RETURN L_ERR_CD;

END;

END_PROC;