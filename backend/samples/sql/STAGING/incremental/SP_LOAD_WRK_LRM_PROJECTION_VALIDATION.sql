SET SCHEMA STAGING_<env>;

DROP PROCEDURE SP_LOAD_WRK_LRM_PROJECTION_VALIDATION;

CREATE OR REPLACE PROCEDURE SP_LOAD_WRK_LRM_PROJECTION_VALIDATION (BIGINT,CHARACTER VARYING(64),CHARACTER VARYING(64),CHARACTER VARYING(64),CHARACTER VARYING(64)) RETURNS INTEGER 
LANGUAGE nzplsql AS 
BEGIN_PROC 

DECLARE 
    P_REQUEST_ID	        ALIAS FOR $1;
    P_SRC_SCHEMA			ALIAS FOR $2;
    P_SRC_TABLE				ALIAS FOR $3;
    P_TRG_SCHEMA			ALIAS FOR $4;
    P_TRG_TABLE				ALIAS FOR $5;
    L_ERR_CD				CHAR(5);
    L_ERR_MSG				VARCHAR(32000);
    V_REC					RECORD;
    V_DELETE_QUERY			VARCHAR(32000);
    V_INSERT_QUERY			VARCHAR(32000);
	V_TEMP_QUERY			VARCHAR(32000);

BEGIN
SET ISOLATION TO UR;

V_DELETE_QUERY := 'DELETE FROM ' || P_TRG_SCHEMA || '.' || P_TRG_TABLE || ' WHERE REQUEST_ID = ' || P_REQUEST_ID || '';

V_INSERT_QUERY := 'INSERT INTO 	' || P_TRG_SCHEMA || '.' || P_TRG_TABLE || ' (
    CONTRACT_NUMBER,
    SECTION_NUMBER,
    ASSUMED_CONTRACT_NUMBER,
    ASSUMED_SECTION_NUMBER,
    UNDERWRITING_ORDER,
    ENDORSEMENT_NUMBER,
    AOC_STEP,
    LEVEL_OF_ANALYSIS_ID,
    SENSITIVITY_TYPE,
    SCENARIO_TYPE_ID,
    SENSITIVITY_VALUE,
    SCENARIO_PARAMETER,
    POLICY_UW_YEAR,
	P_TIME,
    UNDERWRITING_YEAR,
    BUSINESS_MATURITY,
    BUSINESS_MATURITY_ID,
    POSITION,
    POSITION_ID,
    CURRENCY_CODE,
    BASIS,
    REPORTING_BASIS_ID,
    CLOSING_DATE,
    HISTORIZATION_MODE,
    PROJECTION_MONTH,
    PROJECTION_YEAR,
    PROJECTION_DATE,
    PERIOD_TYPE_ID,
    PERIOD_DESCRIPTION,
    AMOUNT,
    CREATED_BY,
    CREATED_DATE,
    LINE_NUMBER,
    REQUEST_ID,
    SOURCE_REF_NAME
)
SELECT
    CONTRACT_NUMBER,
    SECTION_NUMBER,
    ASSUMED_CONTRACT_NUMBER,
    ASSUMED_SECTION_NUMBER,
    UNDERWRITING_ORDER,
    ENDORSEMENT_NUMBER,
    AOC_STEP,
    LEVEL_OF_ANALYSIS_ID,
    SENSITIVITY_TYPE,
    SCENARIO_TYPE_ID,
    SENSITIVITY_VALUE,
    SCENARIO_PARAMETER,
    POLICY_UW_YEAR,
	P_TIME,
    UNDERWRITING_YEAR,
    BUSINESS_MATURITY,
    BUSINESS_MATURITY_ID,
    POSITION,
    POSITION_ID,
    CURRENCY_CODE,
    BASIS,
    REPORTING_BASIS_ID,
    CLOSING_DATE,
    HISTORIZATION_MODE,
    PROJECTION_MONTH,
    PROJECTION_YEAR,
    PROJECTION_DATE,
    PERIOD_TYPE_ID,
    PERIOD_DESCRIPTION,
    AMOUNT,
    CREATED_BY,
    CREATED_DATE,
    LINE_NUMBER,
    REQUEST_ID,
    SOURCE_REF_NAME
FROM ' || P_SRC_SCHEMA || '.' || P_SRC_TABLE || '
WHERE REQUEST_ID = ' || P_REQUEST_ID || '
';

RAISE NOTICE 'Executing V_DELETE_QUERY : ''%''',V_DELETE_QUERY; 
EXECUTE IMMEDIATE V_DELETE_QUERY; 

RAISE NOTICE 'Executing V_INSERT_QUERY : ''%''',V_INSERT_QUERY;
EXECUTE IMMEDIATE V_INSERT_QUERY;

EXCEPTION WHEN OTHERS THEN L_ERR_CD := SUBSTR(SQLERRM, 8, 5); 
	L_ERR_MSG := SQLERRM; 
	RAISE EXCEPTION '% Error while executing SQL statement', L_ERR_MSG; 
	RETURN L_ERR_CD; 
 
END; 

END_PROC;