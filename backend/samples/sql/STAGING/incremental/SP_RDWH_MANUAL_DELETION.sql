SET SCHEMA STAGING_<env>; 

DROP PROCEDURE SP_RDWH_MANUAL_DELETION;

CREATE OR REPLACE PROCEDURE SP_RDWH_MANUAL_DELETION (
CHARACTER VARYING(50),
CHARACTER VARYING(50),
CHARACTER VARYING(50),
CHARACTER VARYING(50),
CHARACTER VARYING(50)
) 
RETURNS INTEGER
language nzplsql
AS
BEGIN_PROC

DECLARE

        P_REQUEST_ID    ALIAS FOR $1;
        P_STG_SCHEMA    ALIAS FOR $2;
        P_STG_WRK_SRC   ALIAS FOR $3;
        P_DWH_SCHEMA    ALIAS FOR $4;
        P_DWH_PRO_TRGT  ALIAS FOR $5;
        V_SQL1_UPD      VARCHAR(ANY);
        V_SQL2_DEL      VARCHAR(ANY);
        V_SQL3_UPD      VARCHAR(ANY);
        V_INFINITE_TS   TIMESTAMP;
        V_SUPP_TS       TIMESTAMP;
        L_ERR_CD        CHAR(5);
        L_ERR_MSG       VARCHAR(32000);

BEGIN
SET ISOLATION TO UR;

V_INFINITE_TS = '9999-12-31';
V_SUPP_TS = '9999-12-31';

V_SQL1_UPD='UPDATE ' || P_DWH_SCHEMA || '.' || P_DWH_PRO_TRGT || ' A 
SET A.DELETED_REQUEST_ID=' || P_REQUEST_ID || ',
    A.SUPP_DATE=CURRENT TIMESTAMP 
WHERE EXISTS (SELECT C.HASH_KEY_DELTA 
        FROM ' || P_STG_SCHEMA || '.' || P_STG_WRK_SRC || ' C
        WHERE C.HASH_KEY_DELTA = A.HASH_KEY_DELTA  AND  A.VALID_TO = ''' || V_INFINITE_TS || ''' AND A.SUPP_DATE= '''||V_SUPP_TS||'''
)';

RAISE NOTICE 'Executing V_SQL1_UPD: ''%''', V_SQL1_UPD;

EXECUTE IMMEDIATE V_SQL1_UPD;

V_SQL2_DEL='DELETE FROM ' || P_STG_SCHEMA || '.' || P_STG_WRK_SRC || ' WHERE REQUEST_ID=' || P_REQUEST_ID || '';

RAISE NOTICE 'Executing V_SQL2_DEL: ''%''', V_SQL2_DEL;

EXECUTE IMMEDIATE V_SQL2_DEL;

V_SQL3_UPD='UPDATE DELIVERY_<env>.UPLOAD_REQUEST  SET STATUS_ID=11 WHERE REQUEST_ID=' || P_REQUEST_ID || '' ;

RAISE NOTICE 'Executing V_SQL3_UPD: ''%''', V_SQL3_UPD;

EXECUTE IMMEDIATE V_SQL3_UPD;

EXCEPTION 
	WHEN OTHERS THEN 
		L_ERR_CD := SUBSTR(SQLERRM, 8, 5); 
		L_ERR_MSG := SQLERRM; 
		RAISE EXCEPTION '% Error while executing SQL statement', L_ERR_MSG; 
		RETURN L_ERR_CD;

END;

END_PROC;