SET SCHEMA STAGING_<env>;

DROP PROCEDURE SP_LOAD_OMEGA_LRA;

CREATE OR REPLACE PROCEDURE SP_LOAD_OMEGA_LRA (
	BIGINT,
	CHARACTER VARYING(64),
	CHARACTER VARYING(64)
) 
RETURNS INTEGER
language nzplsql
AS
BEGIN_PROC

DECLARE
	P_REQUEST_ID	ALIAS FOR $1;
    P_TRG_SCHEMA	ALIAS FOR $2;
    P_TRG_TABLE		ALIAS FOR $3;
	V_INS_LRA		VARCHAR(ANY);
	L_ERR_CD		CHAR(5);
	L_ERR_MSG		VARCHAR(32000);

BEGIN
	SET ISOLATION TO UR;
	   
	V_INS_LRA := 'INSERT INTO ' || P_TRG_SCHEMA || '.' || P_TRG_TABLE || ' (
	    REPORTING_BASIS_ID,
	    CLOSING_DATE,
	    PARAMETER_TYPE_ID,
	    SEGMENT_TYPE_ID,
	    SEGMENT_CODE,
	    CONTRACT_NATURE_CODE,
	    SUBSIDIARY_CODE,
	    SUBLEDGER_CODE,
	    LOB_CODE,
	    DOMAIN_CODE,
	    PLAN_CATEGORY_ID,
		UNDERWRITING_YEAR,
	    CURRENCY_CODE,
	    FACTOR_TYPE_ID,
		FACTOR,
	    REQUEST_ID
	)
	SELECT DISTINCT
		(SELECT ID FROM BI_<env>.REPORTING_BASIS WHERE code = ''I17G'') AS REPORTING_BASIS_ID,
		''9999-12-31-00.00.00'' AS CLOSING_DATE,
		1 AS PARAMETER_TYPE_ID,
		(SELECT ID FROM BI_<env>.SEGMENT_TYPE WHERE CODE = ''1'') AS SEGMENT_TYPE_ID,
		TRIM(b.SEG_NF) AS SEGMENT_CODE,
		NULL AS CONTRACT_NATURE_CODE,
		NULL AS SUBSIDIARY_CODE,
		NULL AS SUBLEDGER_CODE,
		NULL AS LOB_CODE,
		NULL AS DOMAIN_CODE,
		NULL AS PLAN_CATEGORY_ID,
		b.UWY_NF AS UNDERWRITING_YEAR,
		NULL AS CURRENCY_CODE,
		(SELECT ID FROM BI_<env>.ADJUSTMENT_FACTOR_TYPE WHERE code =''LOSS_RATIO_ADJUSTMENT_FACTOR'') AS FACTOR_TYPE_ID,
		CAST(b.LOSRAT_R AS DECFLOAT) AS FACTOR,
		' || P_REQUEST_ID || ' AS REQUEST_ID
	FROM 
		(
			SELECT
				b.SEG_NF, 
				b.UWY_NF, 
				MAX(v.LOADING_D) AS LastLoad
			FROM 
				BI_<env>.TSEGEST b
				INNER JOIN 
					BI_<env>.TVERSION v 
					ON v.VRS_NF = b.VRS_NF 
					AND v.SEGTYP_CT = b.SEGTYP_CT
			WHERE 
				b.LOSRAT_R IS NOT NULL
				AND b.SEGTYP_CT = ''A''
				AND b.UWY_NF >= 2019
				AND b.UWY_NF NOT IN (2050, 2052, 10003, 10001, 9999)
			GROUP BY 
				b.SEG_NF, 
				b.UWY_NF
		) lv
		INNER JOIN 
			BI_<env>.TVERSION v 
			ON v.Loading_D = lv.LastLoad 
			AND v.segtyp_ct = ''A''
		INNER JOIN 
			BI_<env>.TSEGEST b 
			ON b.seg_nf = lv.seg_nf 
			AND b.uwy_nf = lv.uwy_nf 
			AND b.vrs_nf = v.vrs_nf 
			AND b.losrat_r IS NOT NULL 
			AND b.segtyp_ct = ''A''';

	EXECUTE IMMEDIATE 'DELETE FROM ' || P_TRG_SCHEMA || '.' || P_TRG_TABLE || ' WHERE REQUEST_ID = ' || P_REQUEST_ID;

	RAISE NOTICE 'Executing V_INS_LRA: ''%''', V_INS_LRA;

	EXECUTE IMMEDIATE V_INS_LRA;

EXCEPTION 
	WHEN OTHERS THEN 
		L_ERR_CD := SUBSTR(SQLERRM, 8, 5); 
		L_ERR_MSG := SQLERRM; 
		RAISE EXCEPTION '% Error while executing SQL statement', L_ERR_MSG; 
		RETURN L_ERR_CD;

END;

END_PROC;