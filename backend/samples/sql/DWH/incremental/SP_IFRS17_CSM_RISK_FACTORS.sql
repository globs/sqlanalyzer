DROP PROCEDURE IFRS17_CSM_RISK_FACTORS;

CREATE OR REPLACE PROCEDURE IFRS17_CSM_RISK_FACTORS(VARCHAR(7),
VARCHAR(10),
VARCHAR(50), 
VARCHAR(50),
SMALLINT,
VARCHAR(36),
VARCHAR(7),
SMALLINT,
VARCHAR(9) ) RETURNS INTEGER
LANGUAGE nzplsql AS BEGIN_PROC
DECLARE  


P_CLOSING_QUARTER ALIAS FOR $1; 
P_REAL_CLOSING_DATE ALIAS FOR $2;
P_DWH_SCHEMA ALIAS FOR $3;
P_BI_SCHEMA ALIAS FOR $4;
P_SCENARIO_ID ALIAS FOR $5;
P_ENTITY_ID ALIAS FOR $6;
P_NORM_CODE ALIAS FOR $7;
P_RUN_ID ALIAS FOR $8;
P_INTERVAL ALIAS FOR $9;


V_CLEAR_DATA_QUERY VARCHAR(64000);
V_QUERY VARCHAR(64000);


L_ERR_CD CHAR(5);
L_ERR_MSG VARCHAR(32000);
V_CURRENT_TS TIMESTAMP;
 
BEGIN
RAISE NOTICE 'Inserting accept data';


V_CLEAR_DATA_QUERY = 'DELETE FROM ' || P_DWH_SCHEMA || '.TCSM_RA_RISK_FACTORS 
								WHERE REPORTING_DT = VARCHAR_FORMAT(''' || P_REAL_CLOSING_DATE || ''',''DD/MM/YYYY'')
									AND CLOSING_QUARTER_CODE = ''' || P_CLOSING_QUARTER || ''' 
									AND SCENARIO_ID = ' || P_SCENARIO_ID || ' 
									AND ENTITY_ID = ''' || P_ENTITY_ID || '''
									AND RUN_ID   = ' || P_RUN_ID || '
									AND NORM_CD  = ''' || P_NORM_CODE || ''' 
									AND INTERVAL =''' || P_INTERVAL || ''' ';


EXECUTE IMMEDIATE V_CLEAR_DATA_QUERY;


EXECUTE IMMEDIATE 'COMMIT;
';


V_QUERY = 'INSERT INTO  ' || P_DWH_SCHEMA || '.TCSM_RA_RISK_FACTORS 
' || 'WITH TRT AS (
' || '		SELECT CTR_NF,SEC_NF,SECUWY_NF,INSURANCE_CONTRACT_GROUP_ID,PCPCUR_CF,SSD_CF,ACCADMTYP_CT ,PROFIT_SIGN_FLG 
' || '			FROM ' || P_BI_SCHEMA || '.TCSM_TRT_CHARACS
' || '			WHERE REPORTING_DT = VARCHAR_FORMAT(''' || P_REAL_CLOSING_DATE || ''' , ''DD/MM/YYYY'') 
' || '				AND CLOSING_QUARTER_CODE = ''' || P_CLOSING_QUARTER || '''
' || '				AND SCENARIO_ID   = ' || P_SCENARIO_ID || ' 
' || '				AND ENTITY_ID =''' || P_ENTITY_ID || '''
' || '				AND INTERVAL =''' || P_INTERVAL || '''
' || '				AND RUN_ID   = ' || P_RUN_ID || ' 
' || '			GROUP BY CTR_NF,SEC_NF,SECUWY_NF,INSURANCE_CONTRACT_GROUP_ID,PCPCUR_CF,SSD_CF,ACCADMTYP_CT,PROFIT_SIGN_FLG )
' || 'SELECT ''' || P_CLOSING_QUARTER || ''',
' || '    REPORTING_DT,
' || '		' || P_SCENARIO_ID || ' AS SCENARIO_ID,		
' || '		''' || P_ENTITY_ID || ''' AS ENTITY_ID,	
' || '    INSURANCE_CONTRACT_GROUP_ID,
' || '    CASHFLOW_LEG_NM,
' || '    CASHFLOW_TYPE_CD,
' || '    CASHFLOW_DT,
' || '    RISK_FACTOR_RT,
' || '		''' || P_NORM_CODE || ''' AS NORM_CD,
' || '    DATA_TYPE,
' || '		' || P_RUN_ID || ' AS RUN_ID,
' || '		''' || P_INTERVAL || ''' AS INTERVAL,
' || '		TO_CHAR(SYSDATE, ''YYYYMMDD'') AS ASOFDAY
' || 'FROM (
' || '    SELECT
' || '        REPORTING_DT,
' || '        INSURANCE_CONTRACT_GROUP_ID,
' || '        CASHFLOW_LEG_NM,
' || '        CASHFLOW_TYPE_CD,
' || '        CASHFLOW_DT,
' || '        RISK_FACTOR_RT,
' || '        DATA_TYPE,
' || '        ROW_NUMBER() OVER (PARTITION BY REPORTING_DT,INSURANCE_CONTRACT_GROUP_ID, CASHFLOW_LEG_NM,CASHFLOW_TYPE_CD,CASHFLOW_DT,DATA_TYPE ORDER BY RISK_FACTOR_RT DESC) AS RN
' || '    FROM (
' || '        SELECT
' || '            MAX(RAF.REPORTING_DT) AS REPORTING_DT,
' || '            RAF.INSURANCE_CONTRACT_GROUP_ID AS INSURANCE_CONTRACT_GROUP_ID,
' || '            RAF.CASHFLOW_LEG_NM AS CASHFLOW_LEG_NM,
' || '            CAST(RAF.CASHFLOW_TYPE_CD AS VARCHAR(10)) AS CASHFLOW_TYPE_CD,
' || '            CAST(RAF.CASHFLOW_DT AS VARCHAR(10)) AS CASHFLOW_DT,
' || '            CAST(RAF.RISK_FACTOR_RT AS DECFLOAT) AS RISK_FACTOR_RT,
' || '            CAST(DATA_TYPE AS VARCHAR(9)) AS DATA_TYPE
' || '        FROM  (
' || '            SELECT
' || '                CAST(VARCHAR_FORMAT(A.CLOSING_DATE,''DD/MM/YYYY'') AS VARCHAR(10)) AS REPORTING_DT,
' || '                CAST(D.INSURANCE_CONTRACT_GROUP_ID AS VARCHAR(36)) AS INSURANCE_CONTRACT_GROUP_ID,
' || '                CAST(B.CODE AS VARCHAR(32)) AS CASHFLOW_LEG_NM,
' || '                CAST(C.LOC_CODE_CSM AS VARCHAR(32)) AS CASHFLOW_TYPE_CD,
' || '               VARCHAR_FORMAT(LAST_DAY(  RIGHT(''0'' || A.PROJECTION_PERIOD , 2) ||''/01/'' ||  A.PROJECTION_YEAR),''DD/MM/YYYY'') AS CASHFLOW_DT,
' || '                DEC(A.FACTOR,10,9)  AS RISK_FACTOR_RT,
' || '               DTYPE.DATA_TYPE 
' || '            FROM  ' || P_BI_SCHEMA || '.RD_FACTOR_PROJECTION A
' || '      	INNER JOIN  ' || P_BI_SCHEMA || '.POSITION B ON
' || '          	( A.CALCULATED_POSITION_ID = B.ID
' || '        		AND B.VALID_TO = ''9999-12-31''
' || '         		AND B.CSM_POSITION_TYPE_ID =5)
' || '            INNER JOIN ' || P_BI_SCHEMA || '.LEVEL_OF_ANALYSIS C ON
' || '                ( A.LEVEL_OF_ANALYSIS_ID = C.ID
' || '                AND C.VALID_TO = ''9999-12-31'')
' || '			  INNER JOIN TRT D ON
' || '                (A.CONTRACT_NUMBER = D.CTR_NF
' || '                AND A.SECTION_NUMBER = D.SEC_NF
' || '                AND A.VALID_TO = ''9999-12-31'')
' || '            INNER JOIN DELIVERY_<env>.CONF_DATATYPE DTYPE
' || '					ON NVL(D.PROFIT_SIGN_FLG,''N'')=DTYPE.PROFIT_SIGN_FLG
' || '					AND IS_INI=CASE WHEN C.LOC_CODE_CSM = ''INI'' THEN 1 ELSE 0 END 
' || '            WHERE  A.VALID_TO = ''9999-12-31''
' || '        		AND C.LOC_CODE_CSM IS NOT NULL
' || '        		AND A.CLOSING_DATE = ''' || P_REAL_CLOSING_DATE || ''') RAF
' || '		  WHERE  TO_DATE(REPORTING_DT,''DD/MM/YYYY'') <= TO_DATE(CASHFLOW_DT,''DD/MM/YYYY'')
' || '        GROUP BY
' || '            INSURANCE_CONTRACT_GROUP_ID,
' || '            CASHFLOW_LEG_NM,
' || '            CASHFLOW_TYPE_CD,
' || '            CASHFLOW_DT,
' || '            RISK_FACTOR_RT,
' || '            DATA_TYPE))
' || 'WHERE RN = 1';


EXECUTE IMMEDIATE V_QUERY;


EXECUTE IMMEDIATE 'COMMIT;';


EXCEPTION
WHEN OTHERS THEN L_ERR_CD := substr(SQLERRM,8,5);


L_ERR_MSG := SQLERRM;


RAISE EXCEPTION '% Error while executing SQL statement',L_ERR_MSG;


RETURN L_ERR_CD;

END;


END_PROC;