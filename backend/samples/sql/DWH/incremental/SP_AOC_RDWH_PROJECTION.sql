DROP PROCEDURE SP_AOC_RDWH_PROJECTION ;

CREATE OR REPLACE PROCEDURE SP_AOC_RDWH_PROJECTION (VARCHAR(64),VARCHAR(64),VARCHAR(10),VARCHAR(32)) 
RETURNS INTEGER
LANGUAGE nzplsql AS 
BEGIN_PROC

DECLARE 
    P_CLOSING_DATE      ALIAS FOR $1;
    P_REPORTING_BASIS   ALIAS FOR $2;
    P_SRC_SCHEMA        ALIAS FOR $3;
    P_SRC_TABLE         ALIAS FOR $4;
    L_ERR_CD            CHAR(5);
    L_ERR_MSG           VARCHAR(32000);
    V_SPLIT_REC09       RECORD;
    V_SPLIT_REC10       RECORD;
    SPLIT_VALUE         VARCHAR(10);
    V_SRC_TABLE         VARCHAR(32000);
    V_HIST_QUERY_AOC09  VARCHAR(32000);
    V_HIST_QUERY_AOC10  VARCHAR(32000);
    V_HIST_QUERY_1  VARCHAR(32000);

BEGIN

SET ISOLATION TO UR;

EXECUTE IMMEDIATE 'DELETE FROM ' || P_SRC_SCHEMA || '.' || P_SRC_TABLE || ' 
                    WHERE CREATED_REQUEST_ID = -1 
                      AND CREATED_BY= ''AUTOGENERATED AOC9'' AND CLOSING_DATE  = ''' || P_CLOSING_DATE || '''
                      AND REPORTING_BASIS_ID  IN (SELECT ID 
                                                  FROM ' || P_SRC_SCHEMA || '.DWH_REPORTING_BASIS
                                                  WHERE CODE =''' || P_REPORTING_BASIS || ''' )';
EXECUTE IMMEDIATE 'COMMIT';

V_SRC_TABLE = '
SELECT 
    * 
FROM ' || P_SRC_SCHEMA || '.' || P_SRC_TABLE || ' PR
INNER JOIN ' || P_SRC_SCHEMA || '.DWH_REPORTING_BASIS RB ON PR.REPORTING_BASIS_ID=RB.ID
WHERE VALID_TO=''9999-12-31'' AND SUPP_DATE=''9999-12-31'' AND SCENARIO_TYPE_ID = 1  AND SCENARIO_PARAMETER = 0
    AND CLOSING_DATE  = ''' || P_CLOSING_DATE || '''
    AND RB.CODE=''' || P_REPORTING_BASIS || ''' 
';


V_HIST_QUERY_AOC09 = 'INSERT INTO  ' || P_SRC_SCHEMA || '.' || P_SRC_TABLE || '(
    CONTRACT_NUMBER, 
    UNDERWRITING_YEAR, 
    SECTION_NUMBER, 
    UNDERWRITING_ORDER, 
    ENDORSEMENT_NUMBER, 
    POLICY_UW_YEAR, 
    CLOSING_DATE, 
    VALUATION_DATE, 
    BUSINESS_MATURITY_ID,
    REPORTING_BASIS_ID, 
    ASSUMED_CONTRACT_NUMBER, 
    ASSUMED_SECTION_NUMBER, 
    POSITION_ID, 
    LEVEL_OF_ANALYSIS_ID, 
    SCENARIO_TYPE_ID, 
    SCENARIO_PARAMETER, 
    SPLIT_TYPE_ID,
    CURRENCY_CODE, 
    PROJECTION_YEAR, 
    PROJECTION_MONTH, 
    PROJECTION_DATE, 
    HASH_KEY_FULL, 
    HASH_KEY_DELTA, 
    PIVOT_KEY, 
    VALID_FROM, 
    VALID_TO, 
    SUPP_DATE, 
    PERIOD_TYPE_ID,
    AMOUNT, 
    CREATED_BY, 
    CREATED_REQUEST_ID
)
WITH SOURCE_TABLE AS (' || V_SRC_TABLE || ' )
SELECT 
    PR.CONTRACT_NUMBER, 
    PR.UNDERWRITING_YEAR, 
    PR.SECTION_NUMBER, 
    PR.UNDERWRITING_ORDER, 
    PR.ENDORSEMENT_NUMBER, 
    PR.POLICY_UW_YEAR, 
    PR.CLOSING_DATE, 
    TO_DATE(''31/12/'' ||(YEAR(PR.CLOSING_DATE) -1),''DD/MM/YYYY''), 
    PR.BUSINESS_MATURITY_ID,
    PR.REPORTING_BASIS_ID, 
    PR.ASSUMED_CONTRACT_NUMBER, 
    PR.ASSUMED_SECTION_NUMBER, 
    PR.POSITION_ID, 
    16, 
    PR.SCENARIO_TYPE_ID, 
    PR.SCENARIO_PARAMETER, 
    PR.SPLIT_TYPE_ID,
    PR.CURRENCY_CODE, 
    PR.PROJECTION_YEAR, 
    PR.PROJECTION_MONTH, 
    PR.PROJECTION_DATE,
    HASH(NVL(NVL(PR.CONTRACT_NUMBER,''0'')||''-''||NVL(PR.SECTION_NUMBER,''0'')||''-''||NVL(VARCHAR_FORMAT(PR.CLOSING_DATE, ''YYYYMMDD''),''0'')||''-''||NVL(PR.BUSINESS_MATURITY_ID,''0'')||''-''||NVL(PR.REPORTING_BASIS_ID,''0'')||''-''||16||''-''||NVL(PR.SCENARIO_TYPE_ID,''0'')||''-''||NVL(PR.SCENARIO_PARAMETER,''0''),''''),2) HASH_KEY_FULL,
    HASH(NVL(NVL(PR.CONTRACT_NUMBER,''0'')||''-''||NVL(PR.UNDERWRITING_YEAR,''0'')||''-''||NVL(PR.SECTION_NUMBER,''0'')||''-''||NVL(PR.POLICY_UW_YEAR,''0'')||''-''||NVL(VARCHAR_FORMAT(PR.CLOSING_DATE, ''YYYYMMDD''),''0'')||''-''||NVL(PR.BUSINESS_MATURITY_ID,''0'')||''-''||NVL(PR.REPORTING_BASIS_ID,''0'')||''-''||NVL(PR.ASSUMED_CONTRACT_NUMBER,''0'')||''-''||NVL(PR.ASSUMED_SECTION_NUMBER,''0'')||''-''||NVL(PR.POSITION_ID,''0'')||''-''||16||''-''||NVL(PR.SCENARIO_TYPE_ID,''0'')||''-''||NVL(PR.SCENARIO_PARAMETER,''0'')||''-''||NVL(PR.CURRENCY_CODE,''0'')||''-''||NVL(PR.SPLIT_TYPE_ID,''0''),''''),2) HASH_KEY_DELTA,
    HASH(NVL(NVL(PR.PERIOD_TYPE_ID,''0'')||''-''||NVL(PR.AMOUNT,''0''),''''),2) PIVOT_KEY,
    PR.VALID_FROM, 
    PR.VALID_TO, 
    PR.SUPP_DATE,
    PR.PERIOD_TYPE_ID,
    PR.AMOUNT, 
    ''AUTOGENERATED AOC9'', 
    -1
FROM SOURCE_TABLE PR
INNER JOIN
  (SELECT  
      A.CONTRACT_NUMBER,  
      A.SECTION_NUMBER,  
      A.CLOSING_DATE,
      A.BUSINESS_MATURITY_ID,
      A.REPORTING_BASIS_ID, 
      CASE WHEN A.POSITION_ID =407 THEN 1 ELSE 0 END IS_RISK_ADJ_COC, 
      MAX(A.LEVEL_OF_ANALYSIS_ID) LEVEL_OF_ANALYSIS_ID, 
      A.SCENARIO_TYPE_ID,
      A.SCENARIO_PARAMETER
  FROM SOURCE_TABLE A
  LEFT JOIN 
      (SELECT CLOSING_DATE ,
            REPORTING_BASIS_ID ,
            CONTRACT_NUMBER ,
            SECTION_NUMBER , 
            BUSINESS_MATURITY_ID,
            CASE WHEN POSITION_ID =407 THEN 1 ELSE 0 END IS_RISK_ADJ_COC,
          1 SCENARIO_TYPE_ID,
          0 SCENARIO_PARAMETER
      FROM SOURCE_TABLE
      WHERE  LEVEL_OF_ANALYSIS_ID=16
      GROUP BY CLOSING_DATE ,REPORTING_BASIS_ID ,CONTRACT_NUMBER ,SECTION_NUMBER ,BUSINESS_MATURITY_ID,CASE WHEN POSITION_ID =407 THEN 1 ELSE 0 END 
      ) B
          ON A.CONTRACT_NUMBER  = B.CONTRACT_NUMBER
          AND A.SECTION_NUMBER  = B.SECTION_NUMBER
          AND A.CLOSING_DATE  = B.CLOSING_DATE
          AND A.BUSINESS_MATURITY_ID = B.BUSINESS_MATURITY_ID
          AND CASE WHEN A.POSITION_ID =407 THEN 1 ELSE 0 END = IS_RISK_ADJ_COC
          AND A.SCENARIO_TYPE_ID  = B.SCENARIO_TYPE_ID
          AND A.SCENARIO_PARAMETER  = B.SCENARIO_PARAMETER
      WHERE A.LEVEL_OF_ANALYSIS_ID<16 AND B.CONTRACT_NUMBER IS  NULL 
      GROUP BY A.CONTRACT_NUMBER, A.SECTION_NUMBER, A.CLOSING_DATE, A.REPORTING_BASIS_ID ,A.BUSINESS_MATURITY_ID, CASE WHEN A.POSITION_ID =407 THEN 1 ELSE 0 END, A.SCENARIO_TYPE_ID, A.SCENARIO_PARAMETER
  ) AOC9 ON PR.CONTRACT_NUMBER  = AOC9.CONTRACT_NUMBER
      AND PR.SECTION_NUMBER  = AOC9.SECTION_NUMBER
      AND PR.CLOSING_DATE  = AOC9.CLOSING_DATE
      AND PR.REPORTING_BASIS_ID = AOC9.REPORTING_BASIS_ID 
      AND PR.BUSINESS_MATURITY_ID  = AOC9.BUSINESS_MATURITY_ID
      AND CASE WHEN PR.POSITION_ID =407 THEN 1 ELSE 0 END  = AOC9.IS_RISK_ADJ_COC
      AND PR.LEVEL_OF_ANALYSIS_ID  = AOC9.LEVEL_OF_ANALYSIS_ID
      AND PR.SCENARIO_TYPE_ID  = AOC9.SCENARIO_TYPE_ID
      AND PR.SCENARIO_PARAMETER  = AOC9.SCENARIO_PARAMETER
';


V_HIST_QUERY_1 = V_HIST_QUERY_AOC09 ;

RAISE NOTICE 'Executing AOC09 V_HIST_QUERY_1: ''%''',
V_HIST_QUERY_1;

EXECUTE IMMEDIATE V_HIST_QUERY_1;

EXECUTE IMMEDIATE 'COMMIT';

EXECUTE IMMEDIATE 'DELETE FROM ' || P_SRC_SCHEMA || '.' || P_SRC_TABLE || ' 
                    WHERE CREATED_REQUEST_ID = -1 AND CREATED_BY= ''AUTOGENERATED AOC10'' 
                      AND CLOSING_DATE  = ''' || P_CLOSING_DATE || '''
                      AND REPORTING_BASIS_ID  IN (SELECT ID 
                                                FROM ' || P_SRC_SCHEMA || '.DWH_REPORTING_BASIS
                                                WHERE CODE =''' || P_REPORTING_BASIS || ''' )';

EXECUTE IMMEDIATE 'COMMIT';


V_HIST_QUERY_AOC10 = 'INSERT INTO  ' || P_SRC_SCHEMA || '.' || P_SRC_TABLE || '(
    CONTRACT_NUMBER, 
    UNDERWRITING_YEAR, 
    SECTION_NUMBER, 
    UNDERWRITING_ORDER, 
    ENDORSEMENT_NUMBER, 
    POLICY_UW_YEAR, 
    CLOSING_DATE, 
    VALUATION_DATE, 
    BUSINESS_MATURITY_ID,
    REPORTING_BASIS_ID, 
    ASSUMED_CONTRACT_NUMBER, 
    ASSUMED_SECTION_NUMBER, 
    POSITION_ID, 
    LEVEL_OF_ANALYSIS_ID, 
    SCENARIO_TYPE_ID, 
    SCENARIO_PARAMETER, 
    SPLIT_TYPE_ID,
    CURRENCY_CODE, 
    PROJECTION_YEAR, 
    PROJECTION_MONTH, 
    PROJECTION_DATE, 
    HASH_KEY_FULL, 
    HASH_KEY_DELTA, 
    PIVOT_KEY, 
    VALID_FROM, 
    VALID_TO, 
    SUPP_DATE, 
    PERIOD_TYPE_ID,
    AMOUNT, 
    CREATED_BY, 
    CREATED_REQUEST_ID
)
WITH SOURCE_TABLE AS (' || V_SRC_TABLE || ' )
SELECT 
    PR.CONTRACT_NUMBER, 
    PR.UNDERWRITING_YEAR, 
    PR.SECTION_NUMBER, 
    PR.UNDERWRITING_ORDER, 
    PR.ENDORSEMENT_NUMBER, 
    PR.POLICY_UW_YEAR, 
    PR.CLOSING_DATE,
    PR.CLOSING_DATE , 
    PR.BUSINESS_MATURITY_ID,
    PR.REPORTING_BASIS_ID, 
    PR.ASSUMED_CONTRACT_NUMBER, 
    PR.ASSUMED_SECTION_NUMBER, 
    PR.POSITION_ID, 
    17, 
    PR.SCENARIO_TYPE_ID, 
    PR.SCENARIO_PARAMETER, 
    PR.SPLIT_TYPE_ID,
    PR.CURRENCY_CODE, 
    PR.PROJECTION_YEAR, 
    PR.PROJECTION_MONTH, 
    PR.PROJECTION_DATE,
    HASH(NVL(NVL(PR.CONTRACT_NUMBER,''0'')||''-''||NVL(PR.SECTION_NUMBER,''0'')||''-''||NVL(VARCHAR_FORMAT(PR.CLOSING_DATE, ''YYYYMMDD''),''0'')||''-''||NVL(PR.BUSINESS_MATURITY_ID,''0'')||''-''||NVL(PR.REPORTING_BASIS_ID,''0'')||''-''||17||''-''||NVL(PR.SCENARIO_TYPE_ID,''0'')||''-''||NVL(PR.SCENARIO_PARAMETER,''0''),''''),2) HASH_KEY_FULL,
    HASH(NVL(NVL(PR.CONTRACT_NUMBER,''0'')||''-''||NVL(PR.UNDERWRITING_YEAR,''0'')||''-''||NVL(PR.SECTION_NUMBER,''0'')||''-''||NVL(PR.POLICY_UW_YEAR,''0'')||''-''||NVL(VARCHAR_FORMAT(PR.CLOSING_DATE, ''YYYYMMDD''),''0'')||''-''||NVL(PR.BUSINESS_MATURITY_ID,''0'')||''-''||NVL(PR.REPORTING_BASIS_ID,''0'')||''-''||NVL(PR.ASSUMED_CONTRACT_NUMBER,''0'')||''-''||NVL(PR.ASSUMED_SECTION_NUMBER,''0'')||''-''||NVL(PR.POSITION_ID,''0'')||''-''||17||''-''||NVL(PR.SCENARIO_TYPE_ID,''0'')||''-''||NVL(PR.SCENARIO_PARAMETER,''0'')||''-''||NVL(PR.CURRENCY_CODE,''0'')||''-''||NVL(PR.SPLIT_TYPE_ID,''0''),''''),2) HASH_KEY_DELTA,
    HASH(NVL(NVL(PR.PERIOD_TYPE_ID,''0'')||''-''||NVL(PR.AMOUNT,''0''),''''),2) PIVOT_KEY,
    PR.VALID_FROM, 
    PR.VALID_TO, 
    PR.SUPP_DATE,
    PR.PERIOD_TYPE_ID,
    PR.AMOUNT, 
    ''AUTOGENERATED AOC10'', 
    -1
FROM SOURCE_TABLE PR
LEFT JOIN 
  (SELECT 
      CONTRACT_NUMBER, 
       REPORTING_BASIS_ID ,
      SECTION_NUMBER,
      CLOSING_DATE,
      BUSINESS_MATURITY_ID, 
      CASE WHEN POSITION_ID =407 THEN 1 ELSE 0 END IS_RISK_ADJ_COC, 
      1 SCENARIO_TYPE_ID,
      0 SCENARIO_PARAMETER
  FROM SOURCE_TABLE
  WHERE  LEVEL_OF_ANALYSIS_ID=17 
  GROUP BY CLOSING_DATE ,REPORTING_BASIS_ID ,CONTRACT_NUMBER ,SECTION_NUMBER ,BUSINESS_MATURITY_ID,CASE WHEN POSITION_ID =407 THEN 1 ELSE 0 END 
  ) AOC10
      ON PR.CONTRACT_NUMBER  = AOC10.CONTRACT_NUMBER
      AND PR.SECTION_NUMBER  = AOC10.SECTION_NUMBER
      AND PR.CLOSING_DATE  = AOC10.CLOSING_DATE
      AND PR.BUSINESS_MATURITY_ID  = AOC10.BUSINESS_MATURITY_ID
      AND PR.REPORTING_BASIS_ID  = AOC10.REPORTING_BASIS_ID
      AND CASE WHEN PR.POSITION_ID =407 THEN 1 ELSE 0 END  = AOC10.IS_RISK_ADJ_COC
WHERE PR.LEVEL_OF_ANALYSIS_ID=16 AND AOC10.CONTRACT_NUMBER IS  NULL 
';

V_HIST_QUERY_1 = V_HIST_QUERY_AOC10 ;
RAISE NOTICE 'Executing AOC10 V_HIST_QUERY_1: ''%''',
V_HIST_QUERY_1;

EXECUTE IMMEDIATE V_HIST_QUERY_1;

EXECUTE IMMEDIATE 'COMMIT';

EXCEPTION WHEN OTHERS THEN L_ERR_CD := SUBSTR(SQLERRM, 8, 5); 
    L_ERR_MSG := SQLERRM; 
    RAISE EXCEPTION '% Error while executing SQL statement', L_ERR_MSG; 
    RETURN L_ERR_CD; 
 
END; 

END_PROC;
