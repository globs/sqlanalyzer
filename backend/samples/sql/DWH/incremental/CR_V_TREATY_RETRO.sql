SET SQL_COMPAT='NPS';

DROP VIEW V_TREATY_RETRO;

CREATE OR REPLACE VIEW V_TREATY_RETRO AS		
SELECT
        CASE
            WHEN (DAY(CURRENT TIMESTAMP) BETWEEN 1 AND 31)
            AND (MONTH(CURRENT TIMESTAMP) BETWEEN 1 AND 3) THEN '31/03/' || YEAR(CURRENT_DATE)
            WHEN (DAY(CURRENT TIMESTAMP) BETWEEN 1 AND 31)
            AND (MONTH(CURRENT TIMESTAMP) BETWEEN 4 AND 6) THEN '30/06/' || YEAR(CURRENT_DATE)
            WHEN (DAY(CURRENT TIMESTAMP) BETWEEN 1 AND 31)
            AND (MONTH(CURRENT TIMESTAMP) BETWEEN 7 AND 9) THEN '30/09/' || YEAR(CURRENT_DATE)
            WHEN (DAY(CURRENT TIMESTAMP) BETWEEN 1 AND 31)
            AND (MONTH(CURRENT TIMESTAMP) BETWEEN 10 AND 12)THEN '31/12/' || YEAR(CURRENT_DATE)
        END AS REPORTING_DT,
        NULL AS SCENARIO_ID,
        'SGL' AS ENTITY_ID_GRP,
        NULL AS ENTITY_ID_PAR,
        NULL AS ENTITY_ID_LOC,
        TUW.RETLEGENTITY_CF AS LEGALENTITY_CF,
        TUW.RETLEGENTITY_LL AS LEGALENTITY_LL,
        NULL AS PARTLEGENTITY_CF,
        NULL AS PARTLEGENTITY_LL,
        TUW.RETLEBRANCH_CF AS LEBRANCH_CF,
        TUW.RETLEBRANCH_LL AS LEBRANCH_LL,
        NULL AS PARTLEBRANCH_CF,
        NULL AS PARTLEBRANCH_LL,
        TSUB.PRDSIT_CF AS PRDSIT_CF,
        TUW.SSD_CF AS SSD_CF,
        TSUB.SSD_LL AS SSD_LS,
        RETRO.ESB_CF AS ESB_CF,
        TESB.ESB_LL AS ESB_LS,
        RETRO.RETCTR_NF AS CTR_NF,
        RETRO.CTRPCPNAM_LL AS CTRPCPNAM_LL,
        TUW.RETSEC_NF AS SEC_NF,
        NULL AS SECLAB_LM,
        'EUR' AS UOA_CUR,
        RETRO.RETPCPCUR_CF AS TRT_CUR,
        RETRO.RETPCPCUR_CF AS PCPCUR_CF,
        TSUB.SSDCUR_CF AS SSDCUR_CF,
        NULL AS UOA_GRP,
        NULL AS UOA_PAR,
        NULL AS UOA_LOC,
        NULL AS PROFIT_SIGN_GRP,
        NULL AS PROFIT_SIGN_PAR,
        NULL AS PROFIT_SIGN_LOC,
        NULL AS PROFIT_SIGN_FLG,
        RETRO.RETCTR_NF AS PROFIT_LVL_GRP,
        NULL AS PROFIT_LVL_PAR,
        NULL AS PROFIT_LVL_LOC,
        NULL AS SEG_PAR_CF,
        NULL AS SEG_PAR_LS,
        NULL AS SEG_LOC_CF,
        NULL AS SEG_LOC_LS,
        RETRO.RETCTR_NF AS SEG_GRP_CF,
        NULL AS SEG_GRP_LS,
        TUW.LOB_CF AS LOB_CF,
        TUW.LOB_HS AS LOB_HS,
        TUW.LIFPRDLINR_CF AS LIFPRDLIN_CF,
        TUW.LIFPRDLINR_LL AS LIFPRDLIN_LL,
        TUW.LIFLOBR_CF AS LIFLOB_CF,
        TUW.LIFLOBR_LL AS LIFLOB_LL,
        TUW.USGAAP_CT AS USGAAP_CT,
        TEC1.COLVAL_LM AS USGAAP_CT_LB,
        CASE
            WHEN TUW.BUSUNIT_CF IS NOT NULL THEN CAST(TUW.BUSUNIT_CF AS CHAR)
            WHEN TUW.BUSUNIT_CF IS NULL THEN TUW.RETCTR_NF
        END AS BUSUNIT_CF,
        TUW.BUSUNIT_LM AS BUSUNIT_LM,
        TUW.MRKUNT_NT AS MRKUNT_NT,
        TUW.MRKUNT_LS AS MRKUNT_LS,
        TUW.SUBMRK_NT AS SUBMRK_NT,
        TUW.SUBMRK_LS AS SUBMRK_LS,
        NULL AS CR_NF,
        NULL AS CR_LM,
        RETRO.RTY_NF AS ANNUAL_COHORT,
        TRE.RTY_NF AS FRSSECUWY_NF,
        TRE.RTY_NF AS CTRUWY_NF,
        TUW.RTY_NF AS SECUWY_NF,
        VARCHAR_FORMAT(RETRO.CTRINC_D,'DD/MM/YYYY') AS CTRINC_D,
        VARCHAR_FORMAT(RETRO.CTRINC_D,'DD/MM/YYYY') AS SECINC_D,
        VARCHAR_FORMAT(RETRO.CTRINC_D,'DD/MM/YYYY') AS CTRFRSINC_D,
        VARCHAR_FORMAT(RETRO.CTRINC_D,'DD/MM/YYYY') AS SECFRSINC_D,
        NULL AS CTRFRSPAYM_D,
        NULL AS SECFRSPAYM_D,
        NULL AS FRSPRICONER_D,
        NULL AS TERM_D,
        VARCHAR_FORMAT(TUW.CAN_DT,'DD/MM/YYYY') AS CANCTR_D,
        NULL AS SECCAN_D,
        NULL AS CTRNEW_CT,
        'Y' AS RETFLG_CF,
        CASE
            WHEN TUW.RETCTR_NF IN(SELECT RETCTR_NF FROM BI_<env>.TSSDACTR GROUP BY RETCTR_NF ) THEN 'Y' ELSE 'N' END AS INTOPEFL_CF,
        NULL AS TERMPERM_CF,
        'N' AS NEWORMODIF_CF,
        NULL AS MODTYP_CF,
        RETRO.RETCTRSTS_CT AS SECSTS_CT,
        TEC.COLVAL_LM AS SECSTS_LS,
        TRE.RETACCTYP_CT AS ACCADMTYP_CT,
        RETRO.RETCTRSTS_CT AS SECACCSTS_CT,
        TEC.COLVAL_LM AS SECACCSTS_LS,
        TUW.NAT_CF AS NAT_CF,
        TCT.CTRNATMNE_HD AS NAT_GD,
        NULL AS ACCFRQ_CT,
        TRE.LIFTRTTYP_CF AS LIFTRTTYP_CF,
        TBA.COLVAL_LM AS LIFTRTTYP_LS,
        NULL AS RETROTYP_CF,
        NULL AS RETRO_RA_LO_CF,
        NULL AS RENTYP_CT,
        NULL AS CTROLDNBR_LM,
        NULL AS PARSEC_NF,
        TRE.ESTCRB_CT AS ESTCRB_CT,
        TUW.RETCTR_NF || '_' || TUW.RETSEC_NF || '_' || TUW.RTY_NF AS INSURANCE_CONTRACT_GROUP_ID,
        TIF.GRPRATEINDEX_CT AS GRPRATEINDEX_CT,
        TIF.PARRATEINDEX_CT AS PARRATEINDEX_CT,
        TIF.LCLRATEINDEX_CT AS LOCRATEINDEX_CT,
        0.06 AS COV_RTO,
        2 AS COC_RTO,
		LIKS.RETCTR_NF_LVL1	AS	X_DIM_RETRO_PATH_ID,
	CASE WHEN TUW.RETCTR_NF IN (SELECT RETCTR_NF FROM BI_<env>.TSSDACTR GROUP BY RETCTR_NF) THEN 1 ELSE 0 END AS INTERNAL_RETRO_FLG, 
	CASE
		WHEN TIF.GRPIFRSTRA_CT= 1 THEN 'FRA'
		WHEN TIF.GRPIFRSTRA_CT= 2 THEN 'MRA'
		WHEN TIF.GRPIFRSTRA_CT= 3 THEN 'FV'
		WHEN TIF.GRPIFRSTRA_CT= 4 THEN 'OTHERS' END AS TRANSITION_APPROACH_CD_GRP,
	CASE 
		WHEN TIF.GRPIFRSTRA_CT IS NOT NULL THEN 1 ELSE 0 END AS	TRANSITION_FLG_GRP,
		NULL	AS	EXP_ADJ_PREM_CSM_ALLOC_RAT_GRP,
		NULL	AS	EXP_ADJ_RCOM_CSM_ALLOC_RAT_GRP,
		1 AS	EXP_ADJ_NDIC_CSM_ALLOC_RAT_GRP,
		NULL AS	TRANSITION_LOCKINDATE_GRP,
	CASE 
		WHEN TIF.PARIFRSTRA_CT=1 THEN 'FRA'
		WHEN TIF.PARIFRSTRA_CT=2 THEN 'MRA'
		WHEN TIF.PARIFRSTRA_CT=3 THEN 'FV'
		WHEN TIF.PARIFRSTRA_CT=4 THEN 'OTHERS'
							END AS TRANSITION_APPROACH_CD_PAR,
	CASE 
		WHEN TIF.PARIFRSTRA_CT IS NOT NULL THEN 1 ELSE 0 END AS	TRANSITION_FLG_PAR,
		NULL AS	EXP_ADJ_PREM_CSM_ALLOC_RAT_PAR,
		NULL AS	EXP_ADJ_RCOM_CSM_ALLOC_RAT_PAR,
		1 AS	EXP_ADJ_NDIC_CSM_ALLOC_RAT_PAR,
		NULL AS	TRANSITION_LOCKINDATE_PAR,
	CASE 
		WHEN TIF.LOCIFRSTRA_CT=1 THEN 'FRA'
		WHEN TIF.LOCIFRSTRA_CT=2 THEN 'MRA'
		WHEN TIF.LOCIFRSTRA_CT=3 THEN 'FV'
		WHEN TIF.LOCIFRSTRA_CT=4 THEN 'OTHERS'
							END AS TRANSITION_APPROACH_CD_LOC,
	CASE 
		WHEN TIF.LOCIFRSTRA_CT IS NOT NULL THEN 1 ELSE 0 END AS TRANSITION_FLG_LOC,
		NULL AS	EXP_ADJ_PREM_CSM_ALLOC_RAT_LOC,
		NULL AS	EXP_ADJ_RCOM_CSM_ALLOC_RAT_LOC,
		1 AS	EXP_ADJ_NDIC_CSM_ALLOC_RAT_LOC,
		NULL AS	TRANSITION_LOCKINDATE_LOC,
		NULL AS	NPR_CALCULATION_FLG,
		NULL AS	REINS_FIXED_RECOVER_PCT,
		NULL AS	TRANSITION_INPUT_CSM_AMT,
		NULL AS	DIRECT_TRANSITION_ACQ_COSTS_AMT
		
    FROM
        BI_<env>.TUWRETSEC TUW
    LEFT JOIN (
        SELECT
            RETCTR_NF,RTY_NF,RETSEC_NF,SSD_CF,RETCTRSTS_CT,CTRINCUWY_D,CTRINC_D,RETPCPCUR_CF,CTRPCPNAM_LL,ESB_CF
        FROM
            BI_<env>.TUWRETRO
        GROUP BY
            RETCTR_NF, RTY_NF,RETSEC_NF,SSD_CF,RETCTRSTS_CT,CTRINCUWY_D,CTRINC_D,RETPCPCUR_CF,CTRPCPNAM_LL,
            ESB_CF
			)RETRO ON
        TUW.RETCTR_NF = RETRO.RETCTR_NF
        AND TUW.RTY_NF = RETRO.RTY_NF
        AND TUW.RETSEC_NF = RETRO.RETSEC_NF
        AND TUW.SSD_CF = RETRO.SSD_CF
    INNER JOIN BI_<env>.TBANTECL TEC ON
        RETRO.RETCTRSTS_CT = TEC.COLVAL_CT
        AND TEC.COL_LS = 'RETCTRSTS_CT'
    INNER JOIN BI_<env>.TBANTECL TEC1 ON
        TUW.USGAAP_CT = TEC1.COLVAL_CT
        AND TEC1.COL_LS = 'USGAAP_CT'
    INNER JOIN BI_<env>.TCTRNATL TCT ON
        TCT.CTRNAT_CF = TUW.NAT_CF
    INNER JOIN BI_<env>.TESB TESB ON
        TESB.ESB_CF = TUW.ESB_CF
        AND TESB.SSD_CF = TUW.SSD_CF
    INNER JOIN BI_<env>.TSUBSID TSUB ON
        TSUB.SSD_CF = TUW.SSD_CF
    LEFT JOIN BI_<env>.TRETSEC TRT ON
        TRT.RETCTR_NF = TUW.RETCTR_NF
        AND TRT.RTY_NF = TUW.RTY_NF
        AND TRT.RETSEC_NF = TUW.RETSEC_NF
        AND TRT.SSD_CF = TUW.SSD_CF
        AND TRT.SUPP_D = TUW.SUPP_D
    LEFT JOIN BI_<env>.TRETCTR TRE ON
        TRE.RTY_NF = TRT.RTY_NF
        AND TRE.RETCTR_NF = TRT.RETCTR_NF
        AND TRE.SSD_CF = TRT.SSD_CF
    LEFT JOIN BI_<env>.TRETIFRS TIF ON
        TIF.RETCTR_NF = TRE.RETCTR_NF
        AND TIF.RTY_NF = TRE.RTY_NF
    INNER JOIN BI_<env>.TBANALL TBA ON
        TBA.COLVAL_CT = TRE.LIFTRTTYP_CF
	LEFT JOIN
		BI_<env>.TWRETRO_LINKS_FINAL LIKS ON
		LIKS.RSSD_CF_LVL1   = TUW.SSD_CF
	AND LIKS.RESB_CF_LVL1   = TUW.ESB_CF
	AND LIKS.RETCTR_NF_LVL1 = TUW.RETCTR_NF
	AND LIKS.RETSEC_NF_LVL1 = TUW.RETSEC_NF
	AND LIKS.RTY_NF_LVL1    = TUW.RTY_NF
	AND LIKS.RSSD_CF_LVL2   = TUW.SSD_CF
	AND LIKS.ESB_CF_LVL2    = TUW.ESB_CF
	AND LIKS.RETCTR_NF_LVL2 = TUW.RETCTR_NF
	AND LIKS.RETSEC_NF_LVL2 = TUW.RETSEC_NF
	AND LIKS.RTY_NF_LVL2    = TUW.RTY_NF
	AND LIKS.RSSD_CF_LVL3   = TUW.SSD_CF
	AND LIKS.ESB_CF_LVL3    = TUW.ESB_CF
	AND LIKS.RETCTR_NF_LVL3 = TUW.RETCTR_NF
	AND LIKS.RETSEC_NF_LVL3 = TUW.RETSEC_NF
	AND LIKS.RTY_NF_LVL3    = TUW.RTY_NF
	AND LIKS.RSSD_CF_LVL4   = TUW.SSD_CF
	AND LIKS.ESB_CF_LVL4    = TUW.ESB_CF
	AND LIKS.RETCTR_NF_LVL4 = TUW.RETCTR_NF
	AND LIKS.RETSEC_NF_LVL4 = TUW.RETSEC_NF
	AND LIKS.RTY_NF_LVL4    = TUW.RTY_NF

    WHERE
        TBA.COL_LS = 'LIFTRTTYP_CF'
        AND TBA.LAG_CF = 'E'
        AND TEC1.LAG_CF = 'E'
        AND TEC.LAG_CF = 'E'
        AND TCT.LAG_CF = 'E'
        AND TRT.SUPP_D = '9999-12-31'
        AND TRE.RETCTRSTS_CT IN (3,19)
        AND TUW.LOB_CF IN (30,31)
        AND TUW.LIFPRDLINR_LL IS NOT NULL
        AND TESB.LIFE_CF = 1
        AND TUW.SSD_CF NOT IN (14,25)
        AND TUW.END_D = '9999-12-31-00.00.00.000000'
        AND TUW.SUPP_D = '9999-12-31-00.00.00.000000';
