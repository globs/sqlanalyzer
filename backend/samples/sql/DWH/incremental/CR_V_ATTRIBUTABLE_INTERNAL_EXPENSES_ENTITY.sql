SET SQL_COMPAT='NPS';

DROP VIEW V_ATTRIBUTABLE_INTERNAL_EXPENSES_ENTITY;

CREATE OR REPLACE VIEW V_ATTRIBUTABLE_INTERNAL_EXPENSES_ENTITY (VALIDFROM, VALIDTO, SEGMENTTYPE, SEGMENTCODE, CONTRACTNATURECODE, SUBSIDIARYCODE, SUBLEDGERCODE, ACQUISITIONCOSTFACTOR, MAINTENANCECOSTFACTOR, CLOSINGDATE, NORM_CODE, EXPENSE_RATIO_ID, SEGMENT_TYPE_ID 
) AS
(
SELECT 
    ADJUSTEMENT_FACTOR.VALID_FROM               AS VALIDFROM,
    ADJUSTEMENT_FACTOR.VALID_TO                 AS VALIDTO,
    SEGMENT_TYPE.CODE                           AS SEGMENTTYPE,
    ADJUSTEMENT_FACTOR.SEGMENT_CODE             AS SEGMENTCODE,
    ADJUSTEMENT_FACTOR.CONTRACT_NATURE_CODE     AS CONTRACTNATURECODE,
    ADJUSTEMENT_FACTOR.SUBSIDIARY_CODE          AS SUBSIDIARYCODE,
    ADJUSTEMENT_FACTOR.SUBLEDGER_CODE           AS SUBLEDGERCODE,
    MAX(CASE WHEN ADJUSTMENT_FACTOR_TYPE.CODE = 'ACQUISITION_COST_FACTOR' THEN ADJUSTEMENT_FACTOR.FACTOR END) AS ACQUISITIONCOSTFACTOR,
    MAX(CASE WHEN ADJUSTMENT_FACTOR_TYPE.CODE = 'MAINTENANCE_COST_FACTOR' THEN ADJUSTEMENT_FACTOR.FACTOR END) AS MAINTENANCECOSTFACTOR,
    ADJUSTEMENT_FACTOR.CLOSING_DATE             AS CLOSINGDATE,
    REPORTING_BASIS.CODE                        AS NORM_CODE,
    ADJUSTEMENT_FACTOR.PARAMETER_TYPE_ID        AS EXPENSE_RATIO_ID,
    ADJUSTEMENT_FACTOR.SEGMENT_TYPE_ID          AS SEGMENT_TYPE_ID
FROM DWH_ADJUSTMENT_FACTOR ADJUSTEMENT_FACTOR
INNER JOIN DWH_PARAMETER_TYPE PARAMETER_TYPE ON ADJUSTEMENT_FACTOR.PARAMETER_TYPE_ID = PARAMETER_TYPE.ID 
INNER JOIN DWH_SEGMENT_TYPE SEGMENT_TYPE ON ADJUSTEMENT_FACTOR.SEGMENT_TYPE_ID = SEGMENT_TYPE.ID 
INNER JOIN DWH_REPORTING_BASIS REPORTING_BASIS ON REPORTING_BASIS.ID = ADJUSTEMENT_FACTOR.REPORTING_BASIS_ID 
INNER JOIN DWH_ADJUSTMENT_FACTOR_TYPE ADJUSTMENT_FACTOR_TYPE ON ADJUSTEMENT_FACTOR.FACTOR_TYPE_ID = ADJUSTMENT_FACTOR_TYPE.ID 
WHERE PARAMETER_TYPE.CODE = 'AIE'
GROUP BY VALIDFROM,VALIDTO,SEGMENTTYPE,SEGMENTCODE,CONTRACTNATURECODE,SUBSIDIARYCODE,SUBLEDGERCODE,CLOSINGDATE,NORM_CODE,EXPENSE_RATIO_ID,SEGMENT_TYPE_ID
);