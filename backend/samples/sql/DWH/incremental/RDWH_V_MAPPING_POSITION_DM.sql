DROP VIEW V_MAPPING_POSITION_DM;

CREATE OR REPLACE VIEW V_MAPPING_POSITION_DM AS(
SELECT
    POSITIONS_MAPPING.POSITION_ID AS SOURCE_POSITION_ID
  , POSITION.NAME                 AS SOURCE_POSITION_NAME
  , POSITION.POSITION_TYPE_ID     AS SOURCE_POSITION_TYPE_ID
  , CASE
        WHEN POSITION.IS_IPDS is TRUE THEN 'IPDS'
        WHEN POSITION.IS_CSM is TRUE THEN 'CSM'
        WHEN POSITION.IS_COMPOSITE is TRUE THEN 'COMPOSITE'
        WHEN POSITION.IS_DELTA is TRUE THEN 'DELTA'
    END AS SOURCE_POSITION_TYPE
  , POSITIONS_MAPPING.MAPPING_POSITION_ID
  , P1.Name             AS MAP_POSITION_NAME
  , P1.POSITION_TYPE_ID AS MAP_POSITION_TYPE_ID
  , CASE
        WHEN P1.IS_IPDS is TRUE THEN 'IPDS'
        WHEN P1.IS_CSM is TRUE THEN 'CSM'
        WHEN P1.IS_COMPOSITE is TRUE THEN 'COMPOSITE'
        WHEN P1.IS_DELTA is TRUE THEN 'DELTA'
    END AS MAP_POSITION_TYPE
  , CASE WHEN POSITIONS_MAPPING.POSITION_ID = POSITIONS_MAPPING.MAPPING_POSITION_ID THEN NULL ELSE POSITIONS_MAPPING.MATH_OPERATOR END AS MATH_OPERATOR
  , POSITION.IS_CASH_FLOW
  , P1.IS_CASH_FLOW AS MAP_IS_CASH_FLOW
  , POSITION.VALID_FROM
  , POSITION.VALID_TO
FROM (
        SELECT
            POSITION_ID
          , MAPPING_POSITION_ID
          , MATH_OPERATOR
        FROM
            BI_<env>.POSITION_MAPPING
        UNION
        SELECT
            MAPPING_POSITION_ID AS POSITION_ID
          , MAPPING_POSITION_ID
          , MATH_OPERATOR
        FROM BI_<env>.POSITION_MAPPING
    ) POSITIONS_MAPPING
    INNER JOIN BI_<env>.POSITION POSITION ON POSITIONS_MAPPING.POSITION_ID=POSITION.ID AND DATE('9999-12-31 00:00:00') between DATE(POSITION.VALID_FROM) and DATE(POSITION.VALID_TO)
    INNER JOIN BI_<env>.POSITION AS P1 ON POSITIONS_MAPPING.MAPPING_POSITION_ID=P1.ID AND P1.IS_LOCAL IS FALSE AND DATE('9999-12-31 00:00:00') between DATE(P1.VALID_FROM) and DATE(P1.VALID_TO)
UNION
SELECT
    ID               AS SOURCE_POSITION_ID
  , NAME             AS SOURCE_POSITION_NAME
  , POSITION_TYPE_ID AS SOURCE_POSITION_TYPE_ID
  , CASE
        WHEN IS_IPDS is TRUE THEN 'IPDS'
        WHEN IS_CSM is TRUE THEN 'CSM' 
        WHEN IS_COMPOSITE is TRUE THEN 'COMPOSITE'
        WHEN IS_DELTA is TRUE THEN 'DELTA'
    END              AS SOURCE_POSITION_TYPE
  , ID               AS MAPPING_POSITION_ID
  , NAME             AS MAP_POSITION_NAME
  , POSITION_TYPE_ID AS MAP_POSITION_TYPE_ID
  , CASE
        WHEN IS_IPDS is TRUE THEN 'IPDS'
        WHEN IS_CSM is TRUE THEN 'CSM'
        WHEN IS_COMPOSITE is TRUE THEN 'COMPOSITE'
        WHEN IS_DELTA is TRUE THEN 'DELTA'
    END  AS MAP_POSITION_TYPE
  , NULL AS MATH_OPERATOR
  , IS_CASH_FLOW
  , IS_CASH_FLOW AS MAP_IS_CASH_FLOW
  , VALID_FROM
  , VALID_TO
FROM BI_<env>.POSITION POSITION
WHERE IS_IPDS IS TRUE
    AND POSITION_TYPE_ID = 1
    AND DATE('9999-12-31 00:00:00') between DATE(POSITION.VALID_FROM) and DATE(POSITION.VALID_TO)
);