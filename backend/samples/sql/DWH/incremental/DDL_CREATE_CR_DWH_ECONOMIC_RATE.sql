DROP TABLE DWH_ECONOMIC_RATE IF EXISTS;

CREATE TABLE DWH_ECONOMIC_RATE (
	REPORTING_BASIS_ID   		SMALLINT,
	CLOSING_DATE         		DATE			NOT NULL,
	ORIGIN_CLOSING_DATE  		DATE,
	PARAMETER_TYPE_ID    		SMALLINT		NOT NULL,
	SEGMENT_TYPE_ID      		SMALLINT,
	SEGMENT_CODE         		VARCHAR(16),
	SUBSIDIARY_CODE      		SMALLINT,
	SUBLEDGER_CODE       		SMALLINT,
	LOB_CODE             		CHAR(2),
	DOMAIN_CODE          		VARCHAR(16),
	ECONOMIC_DATA_AS_OF_DATE	DATE,
	BASE_CURRENCY_CODE   		CHAR(3),
	CURRENCY_CODE				   CHAR(3)			NOT NULL DEFAULT 'ZZZ',
	MATURITY_TYPE_ID     		SMALLINT,
	MATURITY             		SMALLINT		NOT NULL,
	USAGE_TYPE_ID        		SMALLINT,
	SCENARIO_TYPE_ID     		INTEGER,
	RATE                 		DECFLOAT		NOT NULL,
	DISCOUNT_FACTOR      		DECFLOAT,
	DISCOUNT_FACTOR_MYCF 		DECFLOAT,
	DISCOUNT_FACTOR_PC_UND		DECFLOAT,
	SOURCE_IDENTIFIER    		VARCHAR(100),
	HASH_KEY             		VARBINARY(64)	NOT NULL,
	VALID_FROM					   TIMESTAMP		NOT NULL,
	VALID_TO					      TIMESTAMP		NOT NULL,
	PIVOT_KEY					   VARBINARY(64)	NOT NULL,
	SUPP_DATE					   TIMESTAMP,
	CREATED_REQUEST_ID			BIGINT,
	MODIFIED_REQUEST_ID			BIGINT,
	DELETED_REQUEST_ID			BIGINT,
	CONSTRAINT PK_DWH_ECONOMIC_RATE PRIMARY KEY (HASH_KEY, VALID_FROM)  
)
IN TBS_<env> DISTRIBUTE BY HASH(HASH_KEY);

COMMENT ON TABLE DWH_ECONOMIC_RATE IS
'Economic Rate';

COMMENT ON COLUMN DWH_ECONOMIC_RATE.SEGMENT_CODE IS
'Code of the segmentation is the short label of the segmenation';

COMMENT ON COLUMN DWH_ECONOMIC_RATE.SUBSIDIARY_CODE IS
'Code filiale';

COMMENT ON COLUMN DWH_ECONOMIC_RATE.SUBLEDGER_CODE IS
'Code Ã©tablissement';

COMMENT ON COLUMN DWH_ECONOMIC_RATE.ECONOMIC_DATA_AS_OF_DATE IS
'As of Date ';

COMMENT ON COLUMN DWH_ECONOMIC_RATE.BASE_CURRENCY_CODE IS
'Base Currency for a specific Parameter. Depending on the parameter type
 it has a different meaning. 
For example for the Economic data  the base currency is ''EUR'' and for 
Expense Ratio it''s  the currency for  the amount.';

COMMENT ON COLUMN DWH_ECONOMIC_RATE.CURRENCY_CODE IS
'ISO 4217 currency code';

COMMENT ON COLUMN DWH_ECONOMIC_RATE.MATURITY IS
'Maturity in month';

COMMENT ON COLUMN DWH_ECONOMIC_RATE.USAGE_TYPE_ID IS
'Usage Type (See domain)';

COMMENT ON COLUMN DWH_ECONOMIC_RATE.DISCOUNT_FACTOR IS
'(CASE WHEN POWER((1 + RATE),(DECFLOAT(MATURITY) / 12))  = 0 THEN 0 ELSE
 (1 /( POWER((1 + RATE),(DECFLOAT(MATURITY) / 12)) )) END),';

COMMENT ON COLUMN DWH_ECONOMIC_RATE.DISCOUNT_FACTOR_MYCF IS
'Discount Factor for Middle Year Cash Flow';

COMMENT ON COLUMN DWH_ECONOMIC_RATE.DISCOUNT_FACTOR_PC_UND IS
'Discount Factor for Undwind Calculation in Omega';

COMMENT ON COLUMN DWH_ECONOMIC_RATE.SOURCE_IDENTIFIER IS
'Identifier of the source system ( used for tracking)';

ALTER TABLE DWH_ECONOMIC_RATE
	ADD CONSTRAINT FK_ECONOMIC_PARAMETER_TYPE 
		FOREIGN KEY (PARAMETER_TYPE_ID)
		REFERENCES DWH_PARAMETER_TYPE (ID)
		ON DELETE RESTRICT
		NOT ENFORCED;

ALTER TABLE DWH_ECONOMIC_RATE
	ADD CONSTRAINT FK_ECONOMIC_RATE_MATURITY_TYPE 
		FOREIGN KEY (MATURITY_TYPE_ID)
		REFERENCES DWH_MATURITY_TYPE (ID)
		ON DELETE RESTRICT
		NOT ENFORCED;

ALTER TABLE DWH_ECONOMIC_RATE
	ADD CONSTRAINT FK_ECONOMIC_RATE_REPORTING_BASIS 
		FOREIGN KEY (REPORTING_BASIS_ID)
		REFERENCES DWH_REPORTING_BASIS (ID)
		ON DELETE RESTRICT
		NOT ENFORCED;

ALTER TABLE DWH_ECONOMIC_RATE
   ADD CONSTRAINT FK_ECONOMIC_RATE_RUNTYPE FOREIGN KEY (USAGE_TYPE_ID)
        REFERENCES DWH_USAGE_TYPE (ID)
        ON DELETE RESTRICT
        NOT ENFORCED;

ALTER TABLE DWH_ECONOMIC_RATE
	ADD CONSTRAINT FK_ECONOMIC_RATE_SEGMENT_TYPE 
		FOREIGN KEY (SEGMENT_TYPE_ID)
		REFERENCES DWH_SEGMENT_TYPE (ID)
		ON DELETE RESTRICT
		NOT ENFORCED;
	
ALTER TABLE DWH_ECONOMIC_RATE
	ADD CONSTRAINT FK_ECONOMIC_RATE_SCENARIO_TYPE 
		FOREIGN KEY (SCENARIO_TYPE_ID)
		REFERENCES DWH_SCENARIO_TYPE (ID)
		ON DELETE RESTRICT
		NOT ENFORCED;