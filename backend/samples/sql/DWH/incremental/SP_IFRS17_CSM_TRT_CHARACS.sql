DROP PROCEDURE IFRS17_CSM_TRT_CHARACS;

CREATE OR REPLACE PROCEDURE IFRS17_CSM_TRT_CHARACS(VARCHAR(7),
VARCHAR(10),
VARCHAR(50),
VARCHAR(50),
SMALLINT,
VARCHAR(36),
VARCHAR(7),
SMALLINT,
VARCHAR(9) ) RETURNS INTEGER
LANGUAGE nzplsql AS BEGIN_PROC

DECLARE 
P_CLOSING_QUARTER ALIAS FOR $1;
P_REAL_CLOSING_DATE ALIAS FOR $2;
P_DWH_SCHEMA ALIAS FOR $3;
P_BI_SCHEMA ALIAS FOR $4;
P_SCENARIO_ID ALIAS FOR $5;
P_ENTITY_ID ALIAS FOR $6;
P_NORM_CODE ALIAS FOR $7;
P_RUN_ID ALIAS FOR $8;
P_INTERVAL ALIAS FOR $9;
V_CLEAR_DATA_QUERY CHAR(64000);
V_ACCEPT_ICG_FLAG CHAR(64000);
V_RETRO_ICG_FLAG CHAR(64000);
V_ACCEPT_QUERY CHAR(64000);
V_RETRO_QUERY CHAR(64000);
V_PREFIX_NORM CHAR(3);
V_ENTITY_ID SMALLINT;
V_SUBLEDGER_ACCEPT CHAR(64000);
V_SUBLEDGER_RETRO CHAR(64000);
L_ERR_CD CHAR(5);
L_ERR_MSG CHAR(32000);
V_CURRENT_TS TIMESTAMP;

BEGIN
IF P_NORM_CODE = 'I17G' THEN V_PREFIX_NORM = 'GRP';
ELSEIF P_NORM_CODE = 'I17P' THEN V_PREFIX_NORM = 'PAR';
ELSEIF P_NORM_CODE = 'I17L' THEN V_PREFIX_NORM = 'LOC';
END IF;


RAISE NOTICE 'Inserting accept data';


V_CLEAR_DATA_QUERY = 'DELETE FROM ' || P_DWH_SCHEMA || '.TCSM_TRT_CHARACS a 
						WHERE a.REPORTING_DT = VARCHAR_FORMAT(''' || P_REAL_CLOSING_DATE || ''' , ''DD/MM/YYYY'') 
							AND CLOSING_QUARTER_CODE = ''' || P_CLOSING_QUARTER || '''
							AND SCENARIO_ID = ' || P_SCENARIO_ID || ' 
							AND ENTITY_ID = ''' || P_ENTITY_ID || '''
							AND RUN_ID   = ' || P_RUN_ID || '
							AND NORM_CD  = ''' || P_NORM_CODE || ''' 
							AND INTERVAL =''' || P_INTERVAL || ''' ';
EXECUTE IMMEDIATE V_CLEAR_DATA_QUERY;


EXECUTE IMMEDIATE 'COMMIT;';


DROP TABLE SESSION.IFRS17_CSM_TRT_CHARACS_FLAG IF EXISTS;


CREATE TEMP TABLE SESSION.IFRS17_CSM_TRT_CHARACS_FLAG (CTR_NF VARCHAR(9),
FLAG BOOLEAN) DISTRIBUTE ON
RANDOM;


SELECT
   IFRS17_TRT_SCOPE_RULES_ID
INTO    V_ENTITY_ID
FROM    BI_<env>.TCSM_REF_DATA_SCOPE_RULES T
WHERE    SAS_ENTITY = P_ENTITY_ID ;


IF V_ENTITY_ID = 1 THEN V_SUBLEDGER_ACCEPT = '';
						V_SUBLEDGER_RETRO = '';

ELSE V_SUBLEDGER_ACCEPT = 'INNER JOIN SUBLEDGER SB
					ON RIGHT(''0''||UWS.SSD_CF,2)||''-''||RIGHT(''0''||UWS.ACCESB_CF,2) = O2_SUBLEDGER
					AND SB.SAS_ENTITY = ''' || P_ENTITY_ID || ''' ';


V_SUBLEDGER_RETRO = 'INNER JOIN SUBLEDGER SB
					ON RIGHT(''0''||TUW.SSD_CF,2)||''-''||RIGHT(''0''||TUW.ESB_CF,2) = O2_SUBLEDGER
					AND SB.SAS_ENTITY = ''' || P_ENTITY_ID || ''' ';

END IF;


V_ACCEPT_ICG_FLAG = 'INSERT INTO SESSION.IFRS17_CSM_TRT_CHARACS_FLAG
' || ' WITH SUBLEDGER AS (SELECT O2_SUBLEDGER,DSC.SAS_ENTITY
' || ' 			FROM ' || P_BI_SCHEMA || '.TCSM_REF_DATA_SCOPE_RULES DSC
' || ' 			INNER JOIN ' || P_BI_SCHEMA || '.IFRS17_TRT_SCOPE_RULES TSR
' || ' 			 ON DSC.IFRS17_TRT_SCOPE_RULES_ID = TSR.ID
' || ' 			INNER JOIN ' || P_BI_SCHEMA || '.SCENARIO_TYPE ST
' || ' 			 ON DSC.CF_SCENARIO_TYPE_CODE = ST.CODE
' || ' 			WHERE ST.ID = ' || P_SCENARIO_ID || ' 
' || ' 			AND DSC.SAS_ENTITY = ''' || P_ENTITY_ID || ''')
' || ' SELECT CTR_NF, MIN(FLAG) AS FLAG
' || ' FROM (
' || ' 		SELECT 
' || ' 			UWS.CTR_NF,
' || ' 			UWS.SEC_NF,
' || ' 			CASE 
' || ' 				WHEN (UWS.ACCADMTYP_CT IN (1,3,4,5)) OR (UWS.ACCADMTYP_CT = 2 AND UWS.USGAAP_CT = 1 AND ''' || P_ENTITY_ID || ''' NOT LIKE ''%SGL_KOREA%'') THEN 0
' || ' 				ELSE 1
' || ' 			END AS FLAG
' || ' 		FROM ' || P_BI_SCHEMA || '.TUWSEC UWS
' || '		INNER JOIN ' || P_BI_SCHEMA || '.TCONTR CTR ON 
' || '			UWS.SSD_CF = CTR.SSD_CF 
' || '			AND UWS.CTR_NF = CTR.CTR_NF 
' || '			AND UWS.UWY_NF = CTR.UWY_NF 
' || '			AND UWS.END_NT = CTR.END_NT 
' || '			AND UWS.UW_NT = CTR.UW_NT 
' || '			AND UWS.SUPP_D = CTR.SUPP_D
' || '		' || V_SUBLEDGER_ACCEPT || '
' || ' 		WHERE (UWS.ACCADMTYP_CT IN (1,3) AND UWS.SECSTS_CT IN (14,16) 
' || ' 					OR UWS.ACCADMTYP_CT IN (4,5) AND UWS.SECSTS_CT = 19 
' || ' 					OR UWS.ACCADMTYP_CT = 2 AND UWS.USGAAP_CT = 1 AND UWS.SECSTS_CT IN (14,16,19)
' || ' 					OR UWS.ACCADMTYP_CT = 2 AND UWS.USGAAP_CT IN (2,3) AND UWS.SECSTS_CT IN (14,16,17,19))
' || ' 			AND UWS.LOB_CF IN (30,31) 
' || '        	AND CTR.ESTCRB_CT NOT IN (''D'',''S'',''U'',''R'')
' || ' 			AND UWS.END_D = ''9999-12-31-00.00.00.000000''
' || ' 			AND UWS.SUPP_D = ''9999-12-31-00.00.00.000000''
' || ' 			AND UWS.SSD_CF NOT IN (14,25,26)
' || '    		AND UWS.ASSFINANCE_CT<>2 )
' || ' GROUP BY CTR_NF';


EXECUTE IMMEDIATE V_ACCEPT_ICG_FLAG;


EXECUTE IMMEDIATE 'COMMIT;';


V_RETRO_ICG_FLAG = 'INSERT INTO SESSION.IFRS17_CSM_TRT_CHARACS_FLAG
' || ' WITH SUBLEDGER AS (SELECT O2_SUBLEDGER,DSC.SAS_ENTITY
' || ' 			FROM ' || P_BI_SCHEMA || '.TCSM_REF_DATA_SCOPE_RULES DSC
' || ' 			INNER JOIN ' || P_BI_SCHEMA || '.IFRS17_TRT_SCOPE_RULES TSR
' || ' 			 ON DSC.IFRS17_TRT_SCOPE_RULES_ID = TSR.ID
' || ' 			INNER JOIN ' || P_BI_SCHEMA || '.SCENARIO_TYPE ST
' || ' 			 ON DSC.CF_SCENARIO_TYPE_CODE = ST.CODE
' || ' 			WHERE ST.ID = ' || P_SCENARIO_ID || ' 
' || ' 			AND DSC.SAS_ENTITY = ''' || P_ENTITY_ID || ''')
' || '  SELECT RETCTR_NF, MIN(FLAG) AS FLAG
' || '  FROM (
' || '  	SELECT
' || '  		TUW.RETCTR_NF,
' || '  		TUW.RETSEC_NF,
' || '  		CASE 
' || '  			WHEN (TRE.RETACCTYP_CT IN (1,3,4,5)) OR (TRE.RETACCTYP_CT = 2 AND TUW.USGAAP_CT = 1 AND ''' || P_ENTITY_ID || ''' NOT LIKE ''%SGL_KOREA%'') THEN 0
' || ' 				ELSE 1
' || '  	END AS FLAG
' || '  	FROM ' || P_BI_SCHEMA || '.TUWRETSEC TUW
' || '  	INNER JOIN ' || P_BI_SCHEMA || '.TRETCTR TRE ON
' || '  		TRE.RTY_NF = TUW.RTY_NF
' || '  		AND TRE.RETCTR_NF = TUW.RETCTR_NF
' || '  		AND TRE.SSD_CF = TUW.SSD_CF
' || '  	INNER JOIN ' || P_BI_SCHEMA || '.TRETSEC TRT ON
' || '  		TRT.RETCTR_NF = TUW.RETCTR_NF
' || '  		AND TRT.RTY_NF = TUW.RTY_NF
' || '  		AND TRT.RETSEC_NF = TUW.RETSEC_NF
' || '  		AND TRT.SSD_CF = TUW.SSD_CF
' || '  		AND TRT.SUPP_D = TUW.SUPP_D
' || '		' || V_SUBLEDGER_RETRO || '
' || '  	WHERE TRE.RETCTRSTS_CT in (3,19) 
' || '  		AND TRT.SUPP_D = ''9999-12-31''
' || '  		AND TUW.LOB_CF IN (30,31)
' || '  		AND TUW.LIFPRDLINR_LL IS NOT NULL
' || '  		AND TUW.END_D = ''9999-12-31-00.00.00.000000''
' || '  		AND TUW.SUPP_D = ''9999-12-31-00.00.00.000000''
' || '    		AND TRE.ESTCRB_CT NOT IN (''D'',''S'',''U'',''R'')
' || '  	  	AND TRE.SSD_CF NOT IN (14,25,26)
' || '	    	AND TRT.ASSFINANCE_CT<>2 )
' || '  GROUP BY RETCTR_NF';


EXECUTE IMMEDIATE V_RETRO_ICG_FLAG;


EXECUTE IMMEDIATE 'COMMIT;';


V_ACCEPT_QUERY = 'INSERT INTO ' || P_DWH_SCHEMA || '.TCSM_TRT_CHARACS 
' || ' SELECT  ROW_NUMBER() OVER (ORDER BY REPORTING_DT) ,
' || ' CLOSING_QUARTER_CODE,
' || ' REPORTING_DT,
' || ' SCENARIO_ID,
' || ' ENTITY_ID,
' || ' TRIM(LEGALENTITY_CF) ,
' || ' TRIM(LEGALENTITY_LL) ,
' || ' TRIM(PARTLEGENTITY_CF) ,
' || ' TRIM(PARTLEGENTITY_CF) ,
' || ' TRIM(LEBRANCH_CF),
' || ' TRIM(LEBRANCH_LL),
' || ' TRIM(PARTLEBRANCH_CF),
' || ' TRIM(PARTLEBRANCH_LL), 
' || ' TRIM(PRDSIT_CF), 
' || ' TRIM(SSD_CF), 
' || ' TRIM(SSD_LS), 
' || ' TRIM(ESB_CF), 
' || ' TRIM(ESB_LS), 
' || ' TRIM(CTR_NF), 
' || ' TRIM(CTRPCPNAM_LL), 
' || ' TRIM(SEC_NF), 
' || ' TRIM(SECLAB_LM), 
' || ' TRIM(UOA_CUR), 
' || ' TRIM(TRT_CUR), 
' || ' TRIM(PCPCUR_CF), 
' || ' TRIM(SSDCUR_CF), 
' || ' TRIM(UOA_NAME), 
' || ' TRIM(PROFIT_SIGN), 
' || ' TRIM(PROFIT_SIGN_FLG), 
' || ' TRIM(PROFIT_LVL), 
' || ' TRIM(SEG_CODE), 
' || ' TRIM(SEG_LS), 
' || ' TRIM(LOB_CF), 
' || ' TRIM(LOB_HS), 
' || ' TRIM(LIFPRDLIN_CF), 
' || ' TRIM(LIFPRDLIN_LL), 
' || ' TRIM(LIFLOB_CF), 
' || ' TRIM(LIFLOB_LL), 
' || ' TRIM(USGAAP_CT), 
' || ' TRIM(USGAAP_CT_LB), 
' || ' TRIM(BUSUNIT_CF), 
' || ' TRIM(BUSUNIT_LM), 
' || ' TRIM(MRKUNT_NT), 
' || ' TRIM(MRKUNT_LS), 
' || ' TRIM(SUBMRK_NT), 
' || ' TRIM(SUBMRK_LS), 
' || ' TRIM(CR_NF), 
' || ' TRIM(CR_LM), 
' || ' TRIM(ANNUAL_COHORT), 
' || ' TRIM(FRSSECUWY_NF), 
' || ' TRIM(CTRUWY_NF), 
' || ' TRIM(SECUWY_NF), 
' || ' TRIM(CTRINC_D), 
' || ' TRIM(SECINC_D), 
' || ' TRIM(CTRFRSINC_D), 
' || ' TRIM(SECFRSINC_D), 
' || ' TRIM(CTRFRSPAYM_D), 
' || ' TRIM(SECFRSPAYM_D), 
' || ' TRIM(FRSPRICONER_D), 
' || ' TRIM(TERM_D), 
' || ' TRIM(CANCTR_D), 
' || ' TRIM(SECCAN_D), 
' || ' TRIM(CTRNEW_CT), 
' || ' TRIM(RETFLG_CF), 
' || ' TRIM(INTOPEFL_CF), 
' || ' TRIM(TERMPERM_CF), 
' || ' TRIM(NEWORMODIF_CF), 
' || ' TRIM(MODTYP_CF), 
' || ' TRIM(SECSTS_CT), 
' || ' TRIM(SECSTS_LS), 
' || ' TRIM(ACCADMTYP_CT), 
' || ' TRIM(SECACCSTS_CT), 
' || ' TRIM(SECACCSTS_LS), 
' || ' TRIM(NAT_CF), 
' || ' TRIM(NAT_GD), 
' || ' TRIM(ACCFRQ_CT), 
' || ' TRIM(LIFTRTTYP_CF), 
' || ' TRIM(LIFTRTTYP_LS), 
' || ' TRIM(RETROTYP_CF), 
' || ' TRIM(RETRO_RA_LO_CF), 
' || ' TRIM(RENTYP_CT), 
' || ' TRIM(CTROLDNBR_LM), 
' || ' TRIM(PARSEC_NF), 
' || ' TRIM(ESTCRB_CT), 
' || ' TRIM(INSURANCE_CONTRACT_GROUP_ID), 
' || ' TRIM(RATEINDEX_CT), 
' || ' TRIM(COV_RTO), 
' || ' TRIM(COC_RTO), 
' || ' TRIM(X_DIM_RETRO_PATH_ID), 
' || ' TRIM(INTERNAL_RETRO_FLG), 
' || ' TRIM(TRANSITION_APPROACH_CD), 
' || ' TRIM(TRANSITION_FLG), 
' || ' TRIM(TRANSITION_LOCKINDATE), 
' || ' TRIM(TRANSITION_INPUT_CSM_AMT), 
' || ' TRIM(DIRECT_TRANSITION_ACQ_COSTS_AMT), 
' || ' TRIM(NPR_DEFAULT_INI_RAT), 
' || ' TRIM(NPR_DEFAULT_CURRENT_RAT), 
' || ' TRIM(NPR_RECOVERY_INI_RAT), 
' || ' TRIM(NPR_RECOVERY_CURRENT_RAT), 
' || ' TRIM(NPR_CALCULATION_FLG), 
' || ' TRIM(EXP_ADJ_PREM_CSM_ALLOC_RAT), 
' || ' TRIM(EXP_ADJ_RCOM_CSM_ALLOC_RAT), 
' || ' TRIM(EXP_ADJ_NDIC_CSM_ALLOC_RAT), 
' || ' TRIM(RUN_ID), 
' || ' TRIM(NORM_CD), 
' || ' TRIM(INTERVAL), 
' || ' TRIM(ASOFDAY),
' || ' TRIM(ICG_FLAG),
' || ' TRIM(FK_CC),
' || ' TRIM(FK_CF)
' || '  FROM  
' || ' (SELECT ''' || P_CLOSING_QUARTER || ''' CLOSING_QUARTER_CODE,
' || '	CAST(REPORTING_DT AS VARCHAR(10)) AS REPORTING_DT,
' || '	CAST(SCENARIO_ID AS SMALLINT) AS SCENARIO_ID,
' || '	CAST(ENTITY_ID AS VARCHAR(36)) AS ENTITY_ID,
' || '	CAST(LEGALENTITY_CF AS VARCHAR(5)) AS LEGALENTITY_CF,
' || '	CAST(LEGALENTITY_LL AS VARCHAR(32)) AS LEGALENTITY_LL,
' || '	CAST(PARTLEGENTITY_CF AS VARCHAR(5)) AS PARTLEGENTITY_CF,
' || '	CAST(PARTLEGENTITY_LL AS VARCHAR(32)) AS PARTLEGENTITY_LL,
' || '	CAST(LEBRANCH_CF AS VARCHAR(5)) AS LEBRANCH_CF,
' || '	CAST(LEBRANCH_LL AS VARCHAR(32)) AS LEBRANCH_LL,
' || '	CAST(PARTLEBRANCH_CF AS VARCHAR(5)) AS PARTLEBRANCH_CF,
' || '	CAST(PARTLEBRANCH_LL AS VARCHAR(32)) AS PARTLEBRANCH_LL,
' || '	CAST(PRDSIT_CF AS VARCHAR(4)) AS PRDSIT_CF,
' || '	SSD_CF,
' || '	CAST(SSD_LS AS VARCHAR(16)) AS SSD_LS,
' || '	ESB_CF,
' || '	CAST(ESB_LS AS VARCHAR(16)) AS ESB_LS,
' || '	CAST(CTR_NF AS VARCHAR(9)) AS CTR_NF,
' || '	CAST(CTRPCPNAM_LL AS VARCHAR(64)) AS CTRPCPNAM_LL,
' || '	SEC_NF,
' || '	CAST(SECLAB_LM AS VARCHAR(32)) AS SECLAB_LM,
' || '	UOA_CUR,
' || '	CAST(TRT_CUR AS VARCHAR(3)) AS TRT_CUR,
' || '	CAST(PCPCUR_CF AS VARCHAR(3)) AS PCPCUR_CF,
' || '	CAST(SSDCUR_CF AS VARCHAR(3)) AS SSDCUR_CF,
' || '	CAST(UOA_NAME AS VARCHAR(36)) AS UOA_NAME,
' || '	CAST(PROFIT_SIGN AS VARCHAR(36))AS PROFIT_SIGN,
' || '	PROFIT_SIGN_FLG,
' || '	CAST(PROFIT_LVL AS VARCHAR(36)) AS PROFIT_LVL,
' || '	CAST(SEG_CODE AS VARCHAR(30)) AS SEG_CODE,
' || '	CAST(SEG_LS AS VARCHAR(64)) AS SEG_LS,
' || '	CAST(LOB_CF AS VARCHAR(2)) AS LOB_CF,
' || '	CAST(LOB_HS AS VARCHAR(20)) AS LOB_HS,
' || '	CAST(LIFPRDLIN_CF AS VARCHAR(5)) AS LIFPRDLIN_CF,
' || '	CAST(LIFPRDLIN_LL AS VARCHAR(32)) AS LIFPRDLIN_LL,
' || '	CAST(LIFLOB_CF AS VARCHAR(5)) AS LIFLOB_CF,
' || '	CAST(LIFLOB_LL AS VARCHAR(32)) AS LIFLOB_LL,
' || '	USGAAP_CT,
' || '	CAST(USGAAP_CT_LB AS VARCHAR(32)) AS USGAAP_CT_LB,
' || '	CAST(BUSUNIT_CF AS VARCHAR(8)) AS BUSUNIT_CF,
' || '	CAST(BUSUNIT_LM AS VARCHAR(32)) AS BUSUNIT_LM,
' || '	MRKUNT_NT,
' || '	CAST(MRKUNT_LS AS VARCHAR(32)) AS MRKUNT_LS,
' || '	SUBMRK_NT,
' || '	CAST(SUBMRK_LS AS VARCHAR(26)) AS SUBMRK_LS,
' || '	CAST(CR_NF AS VARCHAR(10)) AS CR_NF,
' || '	CAST(CR_LM AS VARCHAR(5)) AS CR_LM,
' || '	ANNUAL_COHORT,
' || '	FRSSECUWY_NF,
' || '	CTRUWY_NF,
' || '	CASE 
' || '		WHEN ACCADMTYP_CT IN (1,3) AND SECSTS_CT IN (14,16) THEN MAX(SECUWY_NF)
' || '		WHEN ACCADMTYP_CT IN (4,5) AND SECSTS_CT = 19 THEN MAX(SECUWY_NF)
' || '		WHEN ACCADMTYP_CT = 2 AND USGAAP_CT = 1 AND SECSTS_CT IN (14,16,19) THEN SECUWY_NF
' || '		WHEN ACCADMTYP_CT = 2 AND USGAAP_CT IN (2,3) AND SECSTS_CT IN (14,16,17,19) THEN SECUWY_NF
' || '	END AS SECUWY_NF,
' || '	CAST(CTRINC_D AS VARCHAR(10)) AS CTRINC_D,
' || '	CAST(SECINC_D AS VARCHAR(10)) AS SECINC_D,
' || '	CAST(CTRFRSINC_D AS VARCHAR(10)) AS CTRFRSINC_D,
' || '	CAST(SECFRSINC_D AS VARCHAR(10)) AS SECFRSINC_D,
' || '	CAST(CTRFRSPAYM_D AS VARCHAR(10)) AS CTRFRSPAYM_D,
' || '	CAST(SECFRSPAYM_D AS VARCHAR(10)) AS SECFRSPAYM_D,
' || '	CAST(FRSPRICONER_D AS VARCHAR(10))AS FRSPRICONER_D,
' || '	CAST(TERM_D AS VARCHAR(10)) AS TERM_D,
' || '	CAST(CANCTR_D AS VARCHAR(10)) AS CANCTR_D,
' || '	CAST(SECCAN_D AS VARCHAR(10)) AS SECCAN_D,
' || '	CAST(CTRNEW_CT AS VARCHAR(1)) AS CTRNEW_CT,
' || '	RETFLG_CF,
' || '	INTOPEFL_CF,
' || '	CAST(TERMPERM_CF AS VARCHAR(12)) AS TERMPERM_CF,
' || '	NEWORMODIF_CF,
' || '	MODTYP_CF,
' || '	SECSTS_CT,
' || '	CAST(SECSTS_LS AS VARCHAR(20)) AS SECSTS_LS,
' || '	ACCADMTYP_CT,
' || '	SECACCSTS_CT,
' || '	CAST(SECACCSTS_LS AS VARCHAR(16)) AS SECACCSTS_LS,
' || '	NAT_CF,
' || '	CAST(NAT_GD AS VARCHAR(4)) AS NAT_GD,
' || '	ACCFRQ_CT,
' || '	CAST(LIFTRTTYP_CF AS VARCHAR(2)) AS LIFTRTTYP_CF,
' || '	CAST(LIFTRTTYP_LS AS VARCHAR(20)) AS LIFTRTTYP_LS,
' || '	CAST(RETROTYP_CF AS VARCHAR(17)) AS RETROTYP_CF,
' || '	CAST(RETRO_RA_LO_CF AS VARCHAR(38))AS RETRO_RA_LO_CF,
' || '	RENTYP_CT,
' || '	CAST(CTROLDNBR_LM AS VARCHAR(32)) AS CTROLDNBR_LM,
' || '	PARSEC_NF,
' || '	CAST(ESTCRB_CT AS VARCHAR(1)) AS ESTCRB_CT,
' || '	CAST(INSURANCE_CONTRACT_GROUP_ID AS VARCHAR(36)) AS INSURANCE_CONTRACT_GROUP_ID,
' || '	CAST(RATEINDEX_CT AS VARCHAR(32)) AS RATEINDEX_CT,
' || '	CAST(COV_RTO AS DECIMAL(8,2)) AS COV_RTO,
' || '	CAST(COC_RTO AS DECIMAL(8,2)) AS COC_RTO,
' || '	CAST(X_DIM_RETRO_PATH_ID AS  VARCHAR(9)) X_DIM_RETRO_PATH_ID,
' || '	CAST(INTERNAL_RETRO_FLG AS CHAR(1)) INTERNAL_RETRO_FLG,
' || '	CAST(TRANSITION_APPROACH_CD  AS VARCHAR(6))TRANSITION_APPROACH_CD,
' || '	TRANSITION_FLG,
' || '	TRANSITION_LOCKINDATE,
' || '	TRANSITION_INPUT_CSM_AMT,
' || '	DIRECT_TRANSITION_ACQ_COSTS_AMT,
' || '	NPR_DEFAULT_INI_RAT,
' || '	NPR_DEFAULT_CURRENT_RAT,
' || '	NPR_RECOVERY_INI_RAT,
' || '	NPR_RECOVERY_CURRENT_RAT,
' || '	NPR_CALCULATION_FLG  ,
' || '	EXP_ADJ_PREM_CSM_ALLOC_RAT ,
' || '	EXP_ADJ_RCOM_CSM_ALLOC_RAT ,
' || '	EXP_ADJ_NDIC_CSM_ALLOC_RAT ,
' || '	RUN_ID,
' || '	CAST(Norm_CD  AS  VARCHAR(7)) Norm_CD,
' || '	CAST(INTERVAL AS  VARCHAR(9)) INTERVAL,
' || '	TO_CHAR(SYSDATE, ''YYYYMMDD'') ASOFDAY,
' || '	CAST(ICG_FLAG AS CHAR(1)) ICG_FLAG,
' || '	CAST(FK_CC AS VARCHAR(40)) FK_CC,
' || '	CAST(FK_CF AS VARCHAR(40)) FK_CF
' || 'FROM 
' || '	(SELECT 
' || '		 VARCHAR_FORMAT(''' || P_REAL_CLOSING_DATE || ''',''DD/MM/YYYY'')  REPORTING_DT, 
' || '		 ' || P_SCENARIO_ID || ' AS SCENARIO_ID, 
' || '		 ''' || P_ENTITY_ID || ''' AS ENTITY_ID, 
' || '		 a.LEGALENTITY_CF AS LEGALENTITY_CF, 
' || '		 a.LEGALENTITY_LL AS LEGALENTITY_LL, 
' || '		 a.PARTLEGENTITY_CF AS PARTLEGENTITY_CF, 
' || '		 a.PARTLEGENTITY_LL AS PARTLEGENTITY_LL, 
' || '		 a.LEBRANCH_CF AS LEBRANCH_CF, 
' || '		 a.LEBRANCH_LL AS LEBRANCH_LL, 
' || '		 a.PARTLEBRANCH_CF AS PARTLEBRANCH_CF, 
' || '		 a.PARTLEBRANCH_LL AS PARTLEBRANCH_LL, 
' || '		 c.PRDSIT_CF AS PRDSIT_CF, 
' || '		 a.SSD_CF AS SSD_CF, 
' || '		 c.SSD_LL AS SSD_LS, 
' || '		 a.ACCESB_CF AS ESB_CF, 
' || '		 d.ESB_LL AS ESB_LS, 
' || '		 a.CTR_NF AS CTR_NF, 
' || '		 b.CTRPCPNAM_LL AS CTRPCPNAM_LL, 
' || '		 a.SEC_NF AS SEC_NF, 
' || '		 a.SECLAB_LM AS SECLAB_LM, 
' || '		 ''EUR'' AS UOA_CUR, 
' || '		 c.SSDCUR_CF AS TRT_CUR, 
' || '		 a.PCPCUR_CF AS PCPCUR_CF, 
' || '		 c.SSDCUR_CF AS SSDCUR_CF, 
' || '		 NULL AS UOA_NAME, 
' || '		CASE	WHEN e.' || V_PREFIX_NORM || 'FIRCLO_D IS NULL THEN NULL
' || '				ELSE 
' || '					CASE 
' || '						WHEN TRIM(e.' || V_PREFIX_NORM || 'INIPRO_CF)= ''1'' THEN ''ONEROUS'' 
' || '						WHEN TRIM(e.' || V_PREFIX_NORM || 'INIPRO_CF)= ''2'' THEN ''REMAINING'' 
' || '						WHEN TRIM(e.' || V_PREFIX_NORM || 'INIPRO_CF)= ''3'' THEN ''NOT_ONEROUS'' 
' || '						ELSE '''' 
' || '					END
' || '		 END AS PROFIT_SIGN, 
' || '		 CASE	WHEN TRIM(e.' || V_PREFIX_NORM || 'INIPRO_CF) IN (''1'',''2'',''3'') AND e.' || V_PREFIX_NORM || 'FIRCLO_D IS NOT NULL 
' || '		 			THEN ''Y''
' || '		 		ELSE ''N'' 
' || '		 	END AS PROFIT_SIGN_FLG, 
' || '		 COALESCE(j.CR_NF,b.CTR_NF) AS PROFIT_LVL, 
' || '		 e.' || V_PREFIX_NORM || 'IFRSSEG1_CT AS SEG_CODE, 
' || '		 e.' || V_PREFIX_NORM || 'IFRSSEG1_LL AS SEG_LS, 
' || '		 a.LOB_CF AS LOB_CF, 
' || '		 a.LOB_HS AS LOB_HS, 
' || '		 a.LIFPRDLINA_CF AS LIFPRDLIN_CF, 
' || '		 a.LIFPRDLINA_LL AS LIFPRDLIN_LL, 
' || '		 a.LIFLOBA_CF AS LIFLOB_CF, 
' || '		 a.LIFLOBA_LL AS LIFLOB_LL, 
' || '		 a.USGAAP_CT AS USGAAP_CT, 
' || '		 i.COLVAL_LM AS USGAAP_CT_LB, 
' || '		 CASE 	WHEN a.BUSUNIT_CF IS NOT NULL THEN CAST(a.BUSUNIT_CF AS CHAR) 
' || '				WHEN a.BUSUNIT_CF IS NULL THEN a.CTR_NF 
' || '		 END AS BUSUNIT_CF, 
' || '		 a.BUSUNIT_LM AS BUSUNIT_LM, 
' || '		 a.MRKUNT_NT AS MRKUNT_NT, 
' || '		 a.MRKUNT_LS AS MRKUNT_LS, 
' || '		 a.SUBMRK_NT AS SUBMRK_NT, 
' || '		 a.SUBMRK_LS AS SUBMRK_LS, 
' || '		 j.CR_NF AS CR_NF, 
' || '		 NULL AS CR_LM, 
' || '		 ISNULL(e.' || V_PREFIX_NORM || 'ANCO_NF, CASE  WHEN f.FLAG =0 THEN a.FRSSECUWY_NF
' || '		   		   		   		   		   		   		WHEN f.FLAG =1 THEN a.UWY_NF
' || '		  											END) AS ANNUAL_COHORT, 
' || '		 a.FRSSECUWY_NF AS FRSSECUWY_NF, 
' || '		 b.UWY_NF AS CTRUWY_NF, 
' || '		 a.UWY_NF AS SECUWY_NF, 
' || '		 VARCHAR_FORMAT(b.CTRINC_D,''DD/MM/YYYY'') AS CTRINC_D, 
' || '		 VARCHAR_FORMAT(a.SECINC_D,''DD/MM/YYYY'') AS SECINC_D, 
' || '		 VARCHAR_FORMAT(b.FRSINC_D,''DD/MM/YYYY'') AS CTRFRSINC_D, 
' || '		 VARCHAR_FORMAT(INCEP_DATE.SECINC_D,''DD/MM/YYYY'') AS SECFRSINC_D, 
' || '		 NULL AS CTRFRSPAYM_D, 
' || '		 NULL AS SECFRSPAYM_D, 
' || '		 NULL AS FRSPRICONER_D, 
' || '		 NULL AS TERM_D, 
' || '		 VARCHAR_FORMAT(l.CAN_DT,''DD/MM/YYYY'') AS CANCTR_D, 
' || '		 VARCHAR_FORMAT(a.SECCAN_D,''DD/MM/YYYY'') AS SECCAN_D, 
' || '		 b.CTRNEW_CT AS CTRNEW_CT, 
' || '		 ''N'' AS RETFLG_CF, 
' || '		 NULL AS INTOPEFL_CF, 
' || '		 NULL AS TERMPERM_CF, 
' || '		 ''N'' AS NEWORMODIF_CF, 
' || '		 l.DATATYP_CT AS MODTYP_CF, 
' || '		 a.SECSTS_CT AS SECSTS_CT, 
' || '		 a.SECSTS_LS AS SECSTS_LS, 
' || '		 a.ACCADMTYP_CT AS ACCADMTYP_CT, 
' || '		 a.SECACCSTS_CT AS SECACCSTS_CT, 
' || '		 a.SECACCSTS_LS AS SECACCSTS_LS, 
' || '		 CAST (a.NAT_CF AS SMALLINT) AS NAT_CF, 
' || '		 a.NAT_GD AS NAT_GD, 
' || '		 b.ACCFRQ_CT AS ACCFRQ_CT, 
' || '		 a.LIFTRTTYP_CF AS LIFTRTTYP_CF, 
' || '		 a.LIFTRTTYP_LS AS LIFTRTTYP_LS, 
' || '		 NULL AS RETROTYP_CF, 
' || '		 NULL AS RETRO_RA_LO_CF, 
' || '		 b.RENTYP_CT AS RENTYP_CT, 
' || '		 b.CTROLDNBR_LM AS CTROLDNBR_LM, 
' || '		 a.PARSEC_NF AS PARSEC_NF, 
' || '		 l.ESTCRB_CT AS ESTCRB_CT, 
' || '		a.CTR_NF || ''_'' || a.SEC_NF || ''_'' ||
' || '		ISNULL(e.' || V_PREFIX_NORM || 'ANCO_NF, CASE  WHEN f.FLAG =0 THEN a.FRSSECUWY_NF
' || '		   		   		   		   		   		   		WHEN f.FLAG =1 THEN a.UWY_NF
' || '		  											END) AS INSURANCE_CONTRACT_GROUP_ID,
' || '		DSCT.DISCOUNT_CURRENCY_CODE||''_''|| TRIM(sr.I17ILLBUCK' || V_PREFIX_NORM || '_CT) 
' || '			||''_Q''||CAST(QUARTER(LAST_DAY(RECOD_D -3 MONTH))*10000+YEAR(LAST_DAY(RECOD_D -3 MONTH)) AS VARCHAR(5)) RATEINDEX_CT, 
' || '		 2 AS COV_RTO, 
' || '		 0.04 AS COC_RTO ,
' || '        LIKS.RETCTR_NF_LVL1 AS X_DIM_RETRO_PATH_ID,
' || '        CASE WHEN RO.REPORTING_BASIS_ID = ''I17L'' THEN ''N''
' || '        	WHEN E.CTR_NF IN (SELECT CTR_NF FROM  ' || P_BI_SCHEMA || '.TSSDACTR) THEN ''Y''
' || '            ELSE ''N''
' || '        END AS INTERNAL_RETRO_FLG,
' || '        CASE
' || '            WHEN TRIM(E.' || V_PREFIX_NORM || 'IFRSTRA_CT) = ''1'' THEN ''FRA''
' || '            WHEN TRIM(E.' || V_PREFIX_NORM || 'IFRSTRA_CT) = ''2'' THEN ''MRA''
' || '            WHEN TRIM(E.' || V_PREFIX_NORM || 'IFRSTRA_CT) = ''3'' THEN ''FV''
' || '            WHEN TRIM(E.' || V_PREFIX_NORM || 'IFRSTRA_CT) = ''4'' THEN ''OTHERS''
' || '        END AS TRANSITION_APPROACH_CD,
' || '        ISNULL(g.TRANSITION_FLG,RT_9999.TRANSITION_FLG) AS TRANSITION_FLG,
' || '        ISNULL(g.TRANSITION_LOCKINDATE,RT_9999.TRANSITION_LOCKINDATE) AS TRANSITION_LOCKINDATE,
' || '        ISNULL(g.TRANSITION_INPUT_CSM_AMT,RT_9999.TRANSITION_INPUT_CSM_AMT) TRANSITION_INPUT_CSM_AMT,
' || '        ISNULL(g.DIRECT_TRANSITION_ACQ_COSTS_AMT,RT_9999.DIRECT_TRANSITION_ACQ_COSTS_AMT) DIRECT_TRANSITION_ACQ_COSTS_AMT,
' || '        NULL AS NPR_DEFAULT_INI_RAT,
' || '        NULL AS NPR_DEFAULT_CURRENT_RAT,
' || '        NULL AS NPR_RECOVERY_INI_RAT,
' || '        NULL AS NPR_RECOVERY_CURRENT_RAT,
' || '        NULL AS NPR_CALCULATION_FLG,
' || '        NULL AS EXP_ADJ_PREM_CSM_ALLOC_RAT,
' || '        NULL AS EXP_ADJ_RCOM_CSM_ALLOC_RAT,
' || '        NULL AS EXP_ADJ_NDIC_CSM_ALLOC_RAT,
' || '		' || P_RUN_ID || ' AS RUN_ID,
' || '		''' || P_NORM_CODE || ''' AS NORM_CD,
' || '		''' || P_INTERVAL || ''' AS INTERVAL,
' || '        CASE
' || '            WHEN f.FLAG = 0 THEN ''N''
' || '            WHEN f.FLAG = 1 THEN ''Y''
' || '        END AS ICG_FLAG,
' || '		DSCT.DISCOUNT_CURRENCY_CODE||''_''|| TRIM(sr.I17ILLBUCK' || V_PREFIX_NORM || '_CT) 
' || '			||''_Q''||QUARTER(''' || P_REAL_CLOSING_DATE || ''')||YEAR(''' || P_REAL_CLOSING_DATE || ''') FK_CC,
' || '		DSCT.DISCOUNT_CURRENCY_CODE||''_''||TRIM(sr.I17ILLBUCK' || V_PREFIX_NORM || '_CT) 
' || '			||''_Q''||CAST(QUARTER(LAST_DAY(RECOD_D -3 MONTH))*10000+YEAR(LAST_DAY(RECOD_D -3 MONTH)) AS VARCHAR(5))
' || '			||''_Q''||QUARTER(''' || P_REAL_CLOSING_DATE || ''')||YEAR(''' || P_REAL_CLOSING_DATE || ''') FK_CF
' || '	FROM 
' || '		' || P_BI_SCHEMA || '.TUWSEC a 
' || ' 		INNER JOIN ' || P_BI_SCHEMA || '.TCSM_REF_ORCHESTRATION RO
' || ' 			 ON RO.SAS_ENTITY = ''' || P_ENTITY_ID || '''
' || '		INNER JOIN  
' || '			(SELECT *  FROM 
' || '				(SELECT 
' || '					tmp.CTR_NF , 
' || '					tmp.UW_NT , 
' || '					tmp.END_NT , 
' || '					tmp.SEC_NF , 
' || '					tmp.UWY_NF , 
' || '					tmp.END_D , 
' || '					tmp.SUPP_D , 
' || '					tmp.SECINC_D , 
' || '					ROW_NUMBER() OVER ( PARTITION BY tmp.CTR_NF,tmp.UW_NT, tmp.END_NT,tmp.SEC_NF ORDER BY tmp.SECINC_D DESC) AS RANK_NM 
' || '				FROM 
' || '					' || P_BI_SCHEMA || '.TUWSEC tmp
' || '				INNER JOIN ' || P_BI_SCHEMA || '.TCONTR CTR ON 
' || '					tmp.SSD_CF = CTR.SSD_CF 
' || '					AND tmp.CTR_NF = CTR.CTR_NF 
' || '					AND tmp.UWY_NF = CTR.UWY_NF 
' || '					AND tmp.END_NT = CTR.END_NT 
' || '					AND tmp.UW_NT = CTR.UW_NT 
' || '					AND tmp.SUPP_D = CTR.SUPP_D
' || '				WHERE tmp.LOB_CF IN (30,31) 
' || '					AND tmp.END_D = ''9999-12-31-00.00.00.000000'' 
' || '					AND tmp.SUPP_D = ''9999-12-31-00.00.00.000000'' 
' || '					AND tmp.SSD_CF NOT IN (14,25,26)
' || '    				AND tmp.ASSFINANCE_CT<>2
' || '        			AND CTR.ESTCRB_CT NOT IN (''D'',''S'',''U'',''R'')
' || '					AND (tmp.ACCADMTYP_CT IN (1,3) AND tmp.SECSTS_CT IN (14,16)
' || '						OR tmp.ACCADMTYP_CT IN (4,5) AND tmp.SECSTS_CT = 19
' || '						OR tmp.ACCADMTYP_CT = 2 AND tmp.USGAAP_CT = 1 AND tmp.SECSTS_CT IN (14,16,19)
' || '						OR tmp.ACCADMTYP_CT = 2 AND tmp.USGAAP_CT IN (2,3) AND tmp.SECSTS_CT IN (14,16,17,19))
' || '				)
' || '			WHERE RANK_NM = 1
' || '			) INCEP_DATE ON 
' || '				(a.CTR_NF = INCEP_DATE.CTR_NF 
' || '				AND a.UW_NT = INCEP_DATE.UW_NT
' || '				AND a.END_NT = INCEP_DATE.END_NT 
' || '				AND a.SEC_NF = INCEP_DATE.SEC_NF 
' || '				AND a.SUPP_D = INCEP_DATE.SUPP_D) 
' || '		LEFT OUTER JOIN ' || P_BI_SCHEMA || '.TUWCTR b ON 
' || '				(a.SSD_CF = b.SSD_CF 
' || '				AND a.CTR_NF = b.CTR_NF 
' || '				AND a.UWY_NF = b.UWY_NF 
' || '				AND a.END_NT = b.END_NT 
' || '				AND a.UW_NT = b.UW_NT 
' || '				AND a.END_D = b.END_D 
' || '				AND a.SUPP_D = b.SUPP_D) 
' || '		LEFT OUTER JOIN ' || P_BI_SCHEMA || '.TSUBSID c ON 
' || '				(a.ssd_CF = c.ssd_CF) 
' || '		LEFT OUTER JOIN ' || P_BI_SCHEMA || '.TESB d ON 
' || '				(a.SSD_CF = d.SSD_CF 
' || '				AND a.ACCESB_CF = d.ESB_CF) 
' || '		LEFT OUTER JOIN ' || P_BI_SCHEMA || '.TSECIFRS  e ON 
' || '				( a.SSD_CF = e.SSD_CF 
' || '				AND a.CTR_NF = e.CTR_NF 
' || '				AND a.UWY_NF = e.UWY_NF 
' || '				AND a.END_NT = e.END_NT 
' || '				AND a.UW_NT = e.UW_NT 
' || '				AND a.SEC_NF = e.SEC_NF )
' || '		  INNER JOIN SESSION.IFRS17_CSM_TRT_CHARACS_FLAG f ON
' || '			a.CTR_NF = f.CTR_NF
' || '		  INNER JOIN (SELECT CTR_NF, SEC_NF,UWY_NF,I17ILLBUCK' || V_PREFIX_NORM || '_CT
' || '		  				FROM ' || P_BI_SCHEMA || '.TUWSECRA 
' || '		  				WHERE SUPP_D = ''9999-12-31'' AND END_D = ''9999-12-31''
' || '		  				GROUP BY CTR_NF, SEC_NF,UWY_NF,I17ILLBUCK' || V_PREFIX_NORM || '_CT) sr ON 
' || '		  		sr.CTR_NF = a.CTR_NF  
' || '		  		AND sr.SEC_NF = a.SEC_NF 
' || '		  		AND sr.UWY_NF = a.UWY_NF
' || '		LEFT OUTER JOIN ' || P_BI_SCHEMA || '.TCSM_REF_TRANSITION g ON
' || '				g.INSURANCE_CONTRACT_GROUP = a.CTR_NF || ''_'' || a.SEC_NF 
' || '				|| ''_'' || ISNULL(e.' || V_PREFIX_NORM || 'ANCO_NF,CASE
' || '																		WHEN f.FLAG = 0 THEN  a.FRSSECUWY_NF
' || '																		WHEN f.FLAG = 1 THEN   a.UWY_NF 
' || '																	END)
' || '				AND g.REPORTING_DATE= VARCHAR_FORMAT(''' || P_REAL_CLOSING_DATE || ''',''DD/MM/YYYY'')
' || '		LEFT OUTER JOIN ' || P_BI_SCHEMA || '.TCSM_REF_TRANSITION RT_9999 
' || '		    ON RT_9999.INSURANCE_CONTRACT_GROUP = a.CTR_NF || ''_'' || a.SEC_NF 
' || '				|| ''_'' || ISNULL(e.' || V_PREFIX_NORM || 'ANCO_NF,CASE
' || '																		WHEN f.FLAG = 0 THEN  a.FRSSECUWY_NF
' || '																		WHEN f.FLAG = 1 THEN   a.UWY_NF 
' || '																	END)
' || '		    AND RT_9999.REPORTING_DATE=''31/12/9999''
' || '		LEFT OUTER JOIN ' || P_BI_SCHEMA || '.TBANTECL i ON 
' || '				i.COLVAL_CT = a.USGAAP_CT
' || '				AND i.LAG_CF = ''E''	
' || '				AND i.COL_LS = ''USGAAP_CT''
' || '		LEFT OUTER JOIN ' || P_BI_SCHEMA || '.TCRCONTR j ON 
' || '				( a.SSD_CF = j.SSD_CF 
' || '				AND a.CTR_NF = j.CTR_NF 
' || '				AND a.UWY_NF = j.UWY_NF 
' || '				AND a.END_NT = j.END_NT 
' || '				AND a.UW_NT = j.UW_NT) 
' || '		LEFT OUTER JOIN ' || P_BI_SCHEMA || '.TCONTR l ON 
' || '			( b.SSD_CF = l.SSD_CF 
' || '			AND b.CTR_NF = l.CTR_NF 
' || '			AND b.UWY_NF = l.UWY_NF 
' || '			AND b.END_NT = l.END_NT 
' || '			AND b.UW_NT = l.UW_NT 
' || '			AND b.SUPP_D = l.SUPP_D)
' || '		LEFT OUTER JOIN ' || P_BI_SCHEMA || '.DISCOUNT_CURRENCY_MAPPING DSCT ON 
' || '			(DSCT.CURRENCY_CODE = a.PCPCUR_CF
' || '			AND DSCT.VALID_TO=''9999-12-31''
' || '			AND DSCT.SUPP_DATE=''9999-12-31''
' || '			AND DSCT.LOB_CODE = 30)
' || '        LEFT OUTER JOIN ' || P_BI_SCHEMA || '.TWRETRO_LINKS_FINAL LIKS ON
' || '            ( LIKS.AC0SSD = A.SSD_CF
' || '            AND LIKS.AC0CTR = A.CTR_NF
' || '            AND LIKS.AC0SEC = A.SEC_NF
' || '            AND LIKS.AC0UWY = A.UWY_NF
' || '            AND LIKS.ASSD_CF_LVL1 = A.SSD_CF
' || '            AND LIKS.ACCESB_CF_LVL1 = A.ACCESB_CF
' || '            AND LIKS.CTR_NF_LVL1 = A.CTR_NF
' || '            AND LIKS.SEC_NF_LVL1 = A.SEC_NF
' || '            AND LIKS.UWY_NF_LVL1 = A.UWY_NF
' || '            AND LIKS.ASSD_CF_LVL2 = A.SSD_CF
' || '            AND LIKS.ACCESB_CF_LVL2 = A.ACCESB_CF
' || '            AND LIKS.CTR_NF_LVL2 = A.CTR_NF
' || '            AND LIKS.SEC_NF_LVL2 = A.SEC_NF
' || '            AND LIKS.UWY_NF_LVL2 = A.UWY_NF
' || '            AND LIKS.ASSD_CF_LVL3 = A.SSD_CF
' || '            AND LIKS.ACCESB_CF_LVL3 = A.ACCESB_CF
' || '            AND LIKS.CTR_NF_LVL3 = A.CTR_NF
' || '            AND LIKS.SEC_NF_LVL3 = A.SEC_NF
' || '            AND LIKS.UWY_NF_LVL3 = A.UWY_NF
' || '            AND LIKS.ASSD_CF_LVL4 = A.SSD_CF
' || '            AND LIKS.ACCESB_CF_LVL4 = A.ACCESB_CF
' || '            AND LIKS.CTR_NF_LVL4 = A.CTR_NF
' || '            AND LIKS.SEC_NF_LVL4 = A.SEC_NF
' || '            AND LIKS.UWY_NF_LVL4 = A.UWY_NF) 
' || '    WHERE a.LOB_CF IN (30,31) 
' || '        AND a.SSD_CF NOT IN (14,25,26) 
' || '    	  AND a.ASSFINANCE_CT<>2
' || '        AND a.SECACCSTS_CT NOT IN (8,9) 
' || '        AND a.END_D = ''9999-12-31-00.00.00.000000'' 
' || '        AND a.SUPP_D = ''9999-12-31-00.00.00.000000'' 
' || '        AND d.LIFE_CF = 1
' || '        AND l.ESTCRB_CT NOT IN(''D'',''S'',''U'',''R'')
' || '        AND ((a.UWY_NF = INCEP_DATE.UWY_NF AND f.FLAG = 1) OR f.FLAG = 0))
' || 'GROUP BY 
' || ' REPORTING_DT, 
' || ' SCENARIO_ID, 
' || ' ENTITY_ID, 
' || ' LEGALENTITY_CF, 
' || ' LEGALENTITY_LL, 
' || ' PARTLEGENTITY_CF, 
' || ' PARTLEGENTITY_LL, 
' || ' LEBRANCH_CF, 
' || ' LEBRANCH_LL, 
' || ' PARTLEBRANCH_CF, 
' || ' PARTLEBRANCH_LL, 
' || ' PRDSIT_CF, 
' || ' SSD_CF, 
' || ' SSD_LS, 
' || ' ESB_CF, 
' || ' ESB_LS, 
' || ' CTR_NF, 
' || ' CTRPCPNAM_LL, 
' || ' SEC_NF, 
' || ' SECLAB_LM, 
' || ' UOA_CUR, 
' || ' TRT_CUR, 
' || ' PCPCUR_CF, 
' || ' SSDCUR_CF, 
' || ' UOA_NAME, 
' || ' PROFIT_SIGN, 
' || ' PROFIT_SIGN_FLG, 
' || ' PROFIT_LVL, 
' || ' SEG_CODE, 
' || ' SEG_LS, 
' || ' LOB_CF, 
' || ' LOB_HS, 
' || ' LIFPRDLIN_CF, 
' || ' LIFPRDLIN_LL, 
' || ' LIFLOB_CF, 
' || ' LIFLOB_LL, 
' || ' USGAAP_CT, 
' || ' USGAAP_CT_LB, 
' || ' BUSUNIT_CF, 
' || ' BUSUNIT_LM, 
' || ' MRKUNT_NT, 
' || ' MRKUNT_LS, 
' || ' SUBMRK_NT, 
' || ' SUBMRK_LS, 
' || ' CR_NF, 
' || ' CR_LM, 
' || ' ANNUAL_COHORT, 
' || ' FRSSECUWY_NF, 
' || ' CTRUWY_NF, 
' || ' SECUWY_NF, 
' || ' CTRINC_D, 
' || ' SECINC_D, 
' || ' CTRFRSINC_D, 
' || ' SECFRSINC_D, 
' || ' CTRFRSPAYM_D, 
' || ' SECFRSPAYM_D, 
' || ' FRSPRICONER_D, 
' || ' TERM_D, 
' || ' CANCTR_D, 
' || ' SECCAN_D, 
' || ' CTRNEW_CT, 
' || ' RETFLG_CF, 
' || ' INTOPEFL_CF, 
' || ' TERMPERM_CF, 
' || ' NEWORMODIF_CF, 
' || ' MODTYP_CF, 
' || ' SECSTS_CT, 
' || ' SECSTS_LS, 
' || ' ACCADMTYP_CT, 
' || ' SECACCSTS_CT, 
' || ' SECACCSTS_LS, 
' || ' NAT_CF, 
' || ' NAT_GD, 
' || ' ACCFRQ_CT, 
' || ' LIFTRTTYP_CF, 
' || ' LIFTRTTYP_LS, 
' || ' RETROTYP_CF, 
' || ' RETRO_RA_LO_CF, 
' || ' RENTYP_CT, 
' || ' CTROLDNBR_LM, 
' || ' PARSEC_NF, 
' || ' ESTCRB_CT, 
' || ' INSURANCE_CONTRACT_GROUP_ID, 
' || ' RATEINDEX_CT,  
' || ' COV_RTO, 
' || ' COC_RTO,
' || ' X_DIM_RETRO_PATH_ID,
' || ' INTERNAL_RETRO_FLG,
' || ' TRANSITION_APPROACH_CD,
' || ' TRANSITION_FLG,
' || ' TRANSITION_LOCKINDATE,
' || ' TRANSITION_INPUT_CSM_AMT,
' || ' DIRECT_TRANSITION_ACQ_COSTS_AMT,
' || ' NPR_DEFAULT_INI_RAT,
' || ' NPR_DEFAULT_CURRENT_RAT,
' || ' NPR_RECOVERY_INI_RAT,
' || ' NPR_RECOVERY_CURRENT_RAT,
' || ' NPR_CALCULATION_FLG,
' || ' EXP_ADJ_PREM_CSM_ALLOC_RAT,
' || ' EXP_ADJ_RCOM_CSM_ALLOC_RAT,
' || ' EXP_ADJ_NDIC_CSM_ALLOC_RAT,
' || ' RUN_ID,
' || ' NORM_CD,
' || ' INTERVAL,
' || ' ICG_FLAG,
' || ' FK_CC,
' || ' FK_CF) 
' || 'WHERE SECUWY_NF IS NOT NULL';


EXECUTE IMMEDIATE V_ACCEPT_QUERY;


EXECUTE IMMEDIATE 'COMMIT;';



V_CURRENT_TS = CURRENT_TIMESTAMP;



V_RETRO_QUERY = ' INSERT INTO ' || P_DWH_SCHEMA || '.TCSM_TRT_CHARACS
' || 'WITH VIEW_CSM_TRT_RETRO AS 
' || '(SELECT 
' || '    VARCHAR_FORMAT(''' || P_REAL_CLOSING_DATE || ''',''DD/MM/YYYY'') REPORTING_DT,
' || '    ' || P_SCENARIO_ID || ' AS SCENARIO_ID,
' || '    ''' || P_ENTITY_ID || ''' AS ENTITY_ID,
' || '    TUW.RETLEGENTITY_CF AS LEGALENTITY_CF,
' || '    TUW.RETLEGENTITY_LL AS LEGALENTITY_LL,
' || '    NULL AS PARTLEGENTITY_CF,
' || '    NULL AS PARTLEGENTITY_LL,
' || '    TUW.RETLEBRANCH_CF AS LEBRANCH_CF,
' || '    TUW.RETLEBRANCH_LL AS LEBRANCH_LL,
' || '    NULL AS PARTLEBRANCH_CF,
' || '    NULL AS PARTLEBRANCH_LL,
' || '    TSUB.PRDSIT_CF AS PRDSIT_CF,
' || '    TUW.SSD_CF AS SSD_CF,
' || '    TSUB.SSD_LL AS SSD_LS,
' || '    RETRO.ESB_CF AS ESB_CF,
' || '    TESB.ESB_LL AS ESB_LS,
' || '    RETRO.RETCTR_NF AS CTR_NF,
' || '    RETRO.CTRPCPNAM_LL AS CTRPCPNAM_LL,
' || '    TUW.RETSEC_NF AS SEC_NF,
' || '    NULL AS SECLAB_LM,
' || '    ''EUR'' AS UOA_CUR,
' || '    RETRO.RETPCPCUR_CF AS TRT_CUR,
' || '    RETRO.RETPCPCUR_CF AS PCPCUR_CF,
' || '    TSUB.SSDCUR_CF AS SSDCUR_CF,
' || '    NULL AS UOA_NAME,
' || '	  CASE
' || '	  		WHEN TRIM(TIF.' || V_PREFIX_NORM || 'INIPRO_CF)= ''4'' THEN ''ONEROUS''
' || '	  		WHEN TRIM(TIF.' || V_PREFIX_NORM || 'INIPRO_CF)= ''5'' THEN ''NOT_ONEROUS''
' || '	  		WHEN TRIM(TIF.' || V_PREFIX_NORM || 'INIPRO_CF)= ''9'' THEN ''INTERNAL_RETRO''
' || '	  		ELSE ''''
' || '	  	END AS PROFIT_SIGN,
' || '		 CASE	WHEN TRIM(TIF.' || V_PREFIX_NORM || 'INIPRO_CF) IN (''4'',''5'',''9'') THEN ''Y''
' || '		 		ELSE ''N'' 
' || '		 	END AS PROFIT_SIGN_FLG,
' || '    RETRO.RETCTR_NF PROFIT_LVL,
' || '    TRIM(TIF.' || V_PREFIX_NORM || 'IFRSSEG1_CT) AS SEG_CODE,
' || '    TRIM(TIF.' || V_PREFIX_NORM || 'IFRSSEG1_LL ) AS SEG_LS,
' || '    TUW.LOB_CF AS LOB_CF,
' || '    TUW.LOB_HS AS LOB_HS,
' || '    TUW.LIFPRDLINR_CF AS LIFPRDLIN_CF,
' || '    TUW.LIFPRDLINR_LL AS LIFPRDLIN_LL,
' || '    TUW.LIFLOBR_CF AS LIFLOB_CF,
' || '    TUW.LIFLOBR_LL AS LIFLOB_LL,
' || '    TUW.USGAAP_CT AS USGAAP_CT,
' || '    TEC1.COLVAL_LM AS USGAAP_CT_LB,
' || '    CASE
' || '        WHEN TUW.BUSUNIT_CF IS NOT NULL THEN CAST(TUW.BUSUNIT_CF AS CHAR)
' || '        WHEN TUW.BUSUNIT_CF IS NULL THEN TUW.RETCTR_NF
' || '    END AS BUSUNIT_CF,
' || '    TUW.BUSUNIT_LM AS BUSUNIT_LM,
' || '    TUW.MRKUNT_NT AS MRKUNT_NT,
' || '    TUW.MRKUNT_LS AS MRKUNT_LS,
' || '    TUW.SUBMRK_NT AS SUBMRK_NT,
' || '    TUW.SUBMRK_LS AS SUBMRK_LS,
' || '    NULL AS CR_NF,
' || '    NULL AS CR_LM,
' || '    ISNULL(TIF.' || V_PREFIX_NORM || 'ANCO_NF, CASE
' || '													WHEN f.FLAG = 0 THEN FUWY_NF
' || '													WHEN f.FLAG = 1 THEN TUW.RTY_NF
' || '												END ) AS ANNUAL_COHORT,
' || '    FUWY_NF AS FRSSECUWY_NF,
' || '    TRE.RTY_NF AS CTRUWY_NF,
' || '    TUW.RTY_NF AS SECUWY_NF,
' || '    VARCHAR_FORMAT(RETRO.CTRINC_D,''DD/MM/YYYY'') AS CTRINC_D,
' || '    VARCHAR_FORMAT(RETRO.CTRINC_D,''DD/MM/YYYY'') AS SECINC_D,
' || '    VARCHAR_FORMAT(RETRO.CTRINC_D,''DD/MM/YYYY'') AS CTRFRSINC_D,
' || '    VARCHAR_FORMAT(RETRO.CTRINC_D,''DD/MM/YYYY'') AS SECFRSINC_D,
' || '    NULL AS CTRFRSPAYM_D,
' || '    NULL AS SECFRSPAYM_D,
' || '    NULL AS FRSPRICONER_D,
' || '    NULL AS TERM_D,
' || '    VARCHAR_FORMAT(TUW.CAN_DT,''DD/MM/YYYY'') AS CANCTR_D,
' || '    NULL AS SECCAN_D,
' || '    NULL AS CTRNEW_CT,
' || '    ''Y'' AS RETFLG_CF,
' || '    CASE
' || '        WHEN TUW.RETCTR_NF IN(SELECT RETCTR_NF FROM ' || P_BI_SCHEMA || '.TSSDACTR GROUP BY RETCTR_NF ) THEN ''Y''
' || '        ELSE ''N''
' || '    END AS INTOPEFL_CF,
' || '    NULL AS TERMPERM_CF,
' || '    ''N'' AS NEWORMODIF_CF,
' || '    NULL AS MODTYP_CF,
' || '    RETRO.RETCTRSTS_CT AS SECSTS_CT,
' || '    TEC.COLVAL_LM AS SECSTS_LS,
' || '    TRE.RETACCTYP_CT AS ACCADMTYP_CT,
' || '    RETRO.RETCTRSTS_CT AS SECACCSTS_CT,
' || '    TEC.COLVAL_LM AS SECACCSTS_LS,
' || '    TUW.NAT_CF AS NAT_CF,
' || '    TCT.CTRNATMNE_HD AS NAT_GD,
' || '    NULL AS ACCFRQ_CT,
' || '    TRE.LIFTRTTYP_CF AS LIFTRTTYP_CF,
' || '    TBA.COLVAL_LM AS LIFTRTTYP_LS,
' || '    NULL AS RETROTYP_CF,
' || '    NULL AS RETRO_RA_LO_CF,
' || '    NULL AS RENTYP_CT,
' || '    NULL AS CTROLDNBR_LM,
' || '    NULL AS PARSEC_NF,
' || '    TRE.ESTCRB_CT AS ESTCRB_CT,
' || '	  TUW.RETCTR_NF || ''_'' || TUW.RETSEC_NF 
' || '	  		|| ''_'' || ISNULL(TIF.' || V_PREFIX_NORM || 'ANCO_NF,
' || '	  					CASE WHEN f.FLAG = 0 THEN  FUWY_NF
' || '	  						WHEN f.FLAG = 1 THEN TUW.RTY_NF
' || '	  					END )AS INSURANCE_CONTRACT_GROUP_ID,
' || '    DISCOUNT_CURRENCY_CODE||''_''|| TRIM(RETI17ILLBUCK' || V_PREFIX_NORM || '_CT) 
' || '    	||''_Q''||CAST(QUARTER(LAST_DAY(RETRECOD_D -3 MONTH))*10000+YEAR(LAST_DAY(RETRECOD_D -3 MONTH)) AS VARCHAR(5)) RATEINDEX_CT,
' || '    2 AS COV_RTO,
' || '    0.04 AS COC_RTO,
' || '    LIKS.RETCTR_NF_LVL1 AS X_DIM_RETRO_PATH_ID,
' || '    CASE  WHEN RO.REPORTING_BASIS_ID = ''I17L'' THEN ''N''
' || '        	WHEN TUW.RETCTR_NF IN (SELECT RETCTR_NF FROM ' || P_BI_SCHEMA || '.TSSDACTR GROUP BY RETCTR_NF) THEN ''Y''
' || '          ELSE ''N''
' || '    	END AS INTERNAL_RETRO_FLG,
' || '    CASE
' || '        WHEN TRIM(TIF.' || V_PREFIX_NORM || 'IFRSTRA_CT) = ''1'' THEN ''FRA''
' || '        WHEN TRIM(TIF.' || V_PREFIX_NORM || 'IFRSTRA_CT) = ''2'' THEN ''MRA''
' || '        WHEN TRIM(TIF.' || V_PREFIX_NORM || 'IFRSTRA_CT) = ''3'' THEN ''FV''
' || '        WHEN TRIM(TIF.' || V_PREFIX_NORM || 'IFRSTRA_CT) = ''4'' THEN ''OTHERS''
' || '    END AS TRANSITION_APPROACH_CD,
' || '    ISNULL(RT.TRANSITION_FLG,RT_9999.TRANSITION_FLG) AS TRANSITION_FLG,
' || '    ISNULL(RT.TRANSITION_LOCKINDATE,RT_9999.TRANSITION_LOCKINDATE) AS TRANSITION_LOCKINDATE,
' || '    ISNULL(RT.TRANSITION_INPUT_CSM_AMT,RT_9999.TRANSITION_INPUT_CSM_AMT) TRANSITION_INPUT_CSM_AMT,
' || '    ISNULL(RT.DIRECT_TRANSITION_ACQ_COSTS_AMT,RT_9999.DIRECT_TRANSITION_ACQ_COSTS_AMT) DIRECT_TRANSITION_ACQ_COSTS_AMT,
' || '    NULL AS NPR_DEFAULT_INI_RAT,
' || '    NULL AS NPR_DEFAULT_CURRENT_RAT,
' || '    NULL AS NPR_RECOVERY_INI_RAT,
' || '    NULL AS NPR_RECOVERY_CURRENT_RAT,
' || '    NULL AS NPR_CALCULATION_FLG,
' || '    NULL AS EXP_ADJ_PREM_CSM_ALLOC_RAT,
' || '    NULL AS EXP_ADJ_RCOM_CSM_ALLOC_RAT,
' || '    1 AS EXP_ADJ_NDIC_CSM_ALLOC_RAT,
' || '	   ' || P_RUN_ID || ' AS RUN_ID,
' || '	   ''' || P_NORM_CODE || ''' AS NORM_CD,
' || '	   ''' || P_INTERVAL || ''' AS INTERVAL,
' || '        CASE
' || '            WHEN f.FLAG = 0 THEN ''N''
' || '            WHEN f.FLAG = 1 THEN ''Y''
' || '        END AS ICG_FLAG,
' || '    DISCOUNT_CURRENCY_CODE||''_''|| TRIM(RETI17ILLBUCK' || V_PREFIX_NORM || '_CT) 
' || '    	||''_Q''||QUARTER(''' || P_REAL_CLOSING_DATE || ''')||YEAR(''' || P_REAL_CLOSING_DATE || ''') FK_CC,
' || '    DISCOUNT_CURRENCY_CODE||''_''|| TRIM(RETI17ILLBUCK' || V_PREFIX_NORM || '_CT)  
' || '    	||''_Q''||CAST(QUARTER(LAST_DAY(RETRECOD_D -3 MONTH))*10000+YEAR(LAST_DAY(RETRECOD_D -3 MONTH)) AS VARCHAR(5))
' || '    	||''_Q''||QUARTER(''' || P_REAL_CLOSING_DATE || ''')||YEAR(''' || P_REAL_CLOSING_DATE || ''') FK_CF
' || 'FROM   ' || P_BI_SCHEMA || '.TUWRETSEC TUW
' || ' 		INNER JOIN ' || P_BI_SCHEMA || '.TCSM_REF_ORCHESTRATION RO
' || ' 			 ON RO.SAS_ENTITY = ''' || P_ENTITY_ID || '''
' || '		INNER JOIN  
' || '			(SELECT *  FROM 
' || '				(SELECT 
' || '					tmp.RETCTR_NF , 
' || '					tmp.RETSEC_NF , 
' || '					tmp.RTY_NF,
' || '					ROW_NUMBER() OVER ( PARTITION BY tmp.RETCTR_NF ,tmp.RETSEC_NF ORDER BY tmp.RTY_NF DESC) AS RANK_NM 
' || '				FROM ' || P_BI_SCHEMA || '.TUWRETSEC tmp 
' || '				LEFT JOIN ' || P_BI_SCHEMA || '.TRETSEC TRT ON
' || '    					TRT.RETCTR_NF = tmp.RETCTR_NF
' || '    					AND TRT.RTY_NF = tmp.RTY_NF
' || '    					AND TRT.RETSEC_NF = tmp.RETSEC_NF
' || '    					AND TRT.SSD_CF = tmp.SSD_CF
' || '    					AND TRT.SUPP_D = tmp.SUPP_D
' || '				LEFT JOIN ' || P_BI_SCHEMA || '.TRETCTR TRE ON
' || '    				TRE.RTY_NF = TRT.RTY_NF
' || '    				AND TRE.RETCTR_NF = TRT.RETCTR_NF
' || '    				AND TRE.SSD_CF = TRT.SSD_CF
' || '				WHERE TRT.SUPP_D = ''9999-12-31''
' || '    			AND TRE.RETCTRSTS_CT IN (3,19)
' || '    			AND tmp.LOB_CF IN (30,31)
' || '    			AND tmp.LIFPRDLINR_LL IS NOT NULL
' || '    			AND tmp.SSD_CF NOT IN (14,25,26)
' || '    			AND tmp.ASSFINANCE_CT<>2 
' || '    			AND tmp.END_D = ''9999-12-31-00.00.00.000000''
' || '    			AND tmp.SUPP_D = ''9999-12-31-00.00.00.000000''
' || ' 	  			AND TRE.ESTCRB_CT NOT IN (''D'',''S'',''U'',''R'')
' || '				)	WHERE RANK_NM = 1
' || '		) LAST_LINE ON 
' || '			TUW.RETCTR_NF = LAST_LINE.RETCTR_NF 
' || '			AND TUW.RETSEC_NF = LAST_LINE.RETSEC_NF 
' || 'LEFT JOIN (
' || '    SELECT
' || '        RETCTR_NF,
' || '        RTY_NF,
' || '        RETSEC_NF,
' || '        SSD_CF,
' || '        RETCTRSTS_CT,
' || '        CTRINCUWY_D,
' || '        CTRINC_D,
' || '        RETPCPCUR_CF,
' || '        CTRPCPNAM_LL,
' || '        ESB_CF
' || '    FROM   ' || P_BI_SCHEMA || '.TUWRETRO
' || '    GROUP BY
' || '        RETCTR_NF,
' || '        RTY_NF,
' || '        RETSEC_NF,
' || '        SSD_CF,
' || '        RETCTRSTS_CT,
' || '        CTRINCUWY_D,
' || '        CTRINC_D,
' || '        RETPCPCUR_CF,
' || '        CTRPCPNAM_LL,
' || '        ESB_CF )RETRO ON
' || '    TUW.RETCTR_NF = RETRO.RETCTR_NF
' || '    AND TUW.RTY_NF = RETRO.RTY_NF
' || '    AND TUW.RETSEC_NF = RETRO.RETSEC_NF
' || '    AND TUW.SSD_CF = RETRO.SSD_CF
' || 'INNER JOIN ' || P_BI_SCHEMA || '.TBANTECL TEC ON
' || '    RETRO.RETCTRSTS_CT = TEC.COLVAL_CT
' || '    AND TEC.COL_LS = ''RETCTRSTS_CT''
' || '    AND TEC.LAG_CF = ''E''
' || 'INNER JOIN ' || P_BI_SCHEMA || '.TBANTECL TEC1 ON
' || '    TUW.USGAAP_CT = TEC1.COLVAL_CT
' || '    AND TEC1.COL_LS = ''USGAAP_CT''
' || '    AND TEC1.LAG_CF = ''E''
' || 'INNER JOIN ' || P_BI_SCHEMA || '.TCTRNATL TCT ON
' || '    TCT.CTRNAT_CF = TUW.NAT_CF
' || '    AND TCT.LAG_CF = ''E''
' || 'INNER JOIN ' || P_BI_SCHEMA || '.TESB TESB ON
' || '    TESB.ESB_CF = TUW.ESB_CF
' || '    AND TESB.SSD_CF = TUW.SSD_CF
' || 'INNER JOIN ' || P_BI_SCHEMA || '.TSUBSID TSUB ON
' || '    TSUB.SSD_CF = TUW.SSD_CF
' || 'LEFT JOIN ' || P_BI_SCHEMA || '.TRETSEC TRT ON
' || '    TRT.RETCTR_NF = TUW.RETCTR_NF
' || '    AND TRT.RTY_NF = TUW.RTY_NF
' || '    AND TRT.RETSEC_NF = TUW.RETSEC_NF
' || '    AND TRT.SSD_CF = TUW.SSD_CF
' || '    AND TRT.SUPP_D = TUW.SUPP_D
' || 'LEFT JOIN ' || P_BI_SCHEMA || '.TRETCTR TRE ON
' || '    TRE.RTY_NF = TRT.RTY_NF
' || '    AND TRE.RETCTR_NF = TRT.RETCTR_NF
' || '    AND TRE.SSD_CF = TRT.SSD_CF
' || 'LEFT JOIN ' || P_BI_SCHEMA || '.TRETIFRS TIF ON
' || '    TIF.RETCTR_NF = TRE.RETCTR_NF
' || '    AND TIF.RTY_NF = TRE.RTY_NF
' || 'INNER JOIN SESSION.IFRS17_CSM_TRT_CHARACS_FLAG f ON
' || '    f.CTR_NF = TUW.RETCTR_NF
' || 'INNER JOIN (SELECT RETCTR_NF, RETSEC_NF,RTY_NF,RETI17ILLBUCK' || V_PREFIX_NORM || '_CT
' || '				FROM ' || P_BI_SCHEMA || '.TUWRETSECRA 
' || '				WHERE SUPP_D = ''9999-12-31'' AND END_D = ''9999-12-31''
' || '				GROUP BY RETCTR_NF, RETSEC_NF,RTY_NF,RETI17ILLBUCK' || V_PREFIX_NORM || '_CT) SR ON 
' || '		SR.RETCTR_NF = TUW.RETCTR_NF  
' || '		AND SR.RETSEC_NF = TUW.RETSEC_NF 
' || 'INNER JOIN (SELECT RET.RETCTR_NF, RET.RETSEC_NF ,MIN(RET.RTY_NF) FUWY_NF
' || '				FROM ' || P_BI_SCHEMA || '.TUWRETSEC RET
' || '				INNER JOIN SESSION.IFRS17_CSM_TRT_CHARACS_FLAG CTR_FLG
' || '					ON RET.RETCTR_NF= CTR_FLG.CTR_NF
' || '				GROUP BY RET.RETCTR_NF, RET.RETSEC_NF) TRT_FUWY
' || '	ON TUW.RETCTR_NF = TRT_FUWY.RETCTR_NF
' || '	AND TUW.RETSEC_NF = TRT_FUWY.RETSEC_NF
' || 'LEFT OUTER JOIN ' || P_BI_SCHEMA || '.TCSM_REF_TRANSITION RT ON
' || '		RT.INSURANCE_CONTRACT_GROUP = TUW.RETCTR_NF || ''_'' || TUW.RETSEC_NF 
' || '	  			  			  		|| ''_'' || ISNULL(TIF.' || V_PREFIX_NORM || 'ANCO_NF,
' || '	  	  								  		CASE WHEN f.FLAG = 0 THEN  FUWY_NF
' || '	  		  							  			WHEN f.FLAG = 1 THEN TUW.RTY_NF
' || '	  		  							  		END )
' || '		AND RT.REPORTING_DATE = VARCHAR_FORMAT(''' || P_REAL_CLOSING_DATE || ''',''DD/MM/YYYY'')
' || 'LEFT OUTER JOIN ' || P_BI_SCHEMA || '.TCSM_REF_TRANSITION RT_9999 ON
' || '    RT_9999.INSURANCE_CONTRACT_GROUP =  TUW.RETCTR_NF || ''_'' || TUW.RETSEC_NF 
' || '	  			  			  		|| ''_'' || ISNULL(TIF.' || V_PREFIX_NORM || 'ANCO_NF,
' || '	  	  								  		CASE WHEN f.FLAG = 0 THEN  FUWY_NF
' || '	  		  							  			WHEN f.FLAG = 1 THEN TUW.RTY_NF
' || '	  		  							  		END )
' || '      AND RT_9999.REPORTING_DATE=''31/12/9999''
' || 'INNER JOIN ' || P_BI_SCHEMA || '.TBANALL TBA ON
' || '    TBA.COLVAL_CT = TRE.LIFTRTTYP_CF
' || '    AND TBA.COL_LS = ''LIFTRTTYP_CF''
' || '    AND TBA.LAG_CF = ''E''
' || 'LEFT OUTER JOIN ' || P_BI_SCHEMA || '.DISCOUNT_CURRENCY_MAPPING DSCT ON 
' || '	(DSCT.CURRENCY_CODE = RETRO.RETPCPCUR_CF
' || '	AND DSCT.VALID_TO=''9999-12-31''
' || '	AND DSCT.SUPP_DATE=''9999-12-31''
' || '	AND DSCT.LOB_CODE = 30)
' || 'LEFT JOIN ' || P_BI_SCHEMA || '.TWRETRO_LINKS_FINAL LIKS ON
' || '    LIKS.RSSD_CF_LVL1 = TUW.SSD_CF
' || '    AND LIKS.RESB_CF_LVL1 = TUW.ESB_CF
' || '    AND LIKS.RETCTR_NF_LVL1 = TUW.RETCTR_NF
' || '    AND LIKS.RETSEC_NF_LVL1 = TUW.RETSEC_NF
' || '    AND LIKS.RTY_NF_LVL1 = TUW.RTY_NF
' || '    AND LIKS.RSSD_CF_LVL2 = TUW.SSD_CF
' || '    AND LIKS.ESB_CF_LVL2 = TUW.ESB_CF
' || '    AND LIKS.RETCTR_NF_LVL2 = TUW.RETCTR_NF
' || '    AND LIKS.RETSEC_NF_LVL2 = TUW.RETSEC_NF
' || '    AND LIKS.RTY_NF_LVL2 = TUW.RTY_NF
' || '    AND LIKS.RSSD_CF_LVL3 = TUW.SSD_CF
' || '    AND LIKS.ESB_CF_LVL3 = TUW.ESB_CF
' || '    AND LIKS.RETCTR_NF_LVL3 = TUW.RETCTR_NF
' || '    AND LIKS.RETSEC_NF_LVL3 = TUW.RETSEC_NF
' || '    AND LIKS.RTY_NF_LVL3 = TUW.RTY_NF
' || '    AND LIKS.RSSD_CF_LVL4 = TUW.SSD_CF
' || '    AND LIKS.ESB_CF_LVL4 = TUW.ESB_CF
' || '    AND LIKS.RETCTR_NF_LVL4 = TUW.RETCTR_NF
' || '    AND LIKS.RETSEC_NF_LVL4 = TUW.RETSEC_NF
' || '    AND LIKS.RTY_NF_LVL4 = TUW.RTY_NF
' || 'WHERE TRT.SUPP_D = ''9999-12-31''
' || '    AND TRE.RETCTRSTS_CT IN (3,19)
' || '    AND TUW.LOB_CF IN (30,31)
' || '    AND TUW.LIFPRDLINR_LL IS NOT NULL
' || '    AND TUW.SSD_CF NOT IN (14,25,26)
' || '    AND TUW.END_D = ''9999-12-31-00.00.00.000000''
' || '    AND TUW.SUPP_D = ''9999-12-31-00.00.00.000000''
' || ' 	  AND TRE.ESTCRB_CT NOT IN (''D'',''S'',''U'',''R'')
' || ' 	  AND (TUW.RTY_NF = LAST_LINE.RTY_NF OR f.FLAG = 1))
' || ',T_RATE_ALL AS (
' || 'SELECT
' || '    T_RETRO.REPORTING_DT,
' || '    CLOSING_D ,
' || '    RETFLG_CF,
' || '    T_RETRO.CTR_NF,
' || '    T_RETRO.SEC_NF,
' || '    T_RETRO.SECUWY_NF,
' || '    T_RETRO.SSD_CF,
' || '    TPL.RTO_NF,
' || '    CLISHONAM_LD,
' || '    RATING_CF,
' || '    NORME_CF,
' || '    DEFPROB_R,
' || '    RECOVRAT_R
' || 'FROM     VIEW_CSM_TRT_RETRO T_RETRO
' || 'INNER JOIN (
' || '    SELECT
' || '        DISTINCT RETCTR_NF,
' || '        RTY_NF,
' || '        SSD_CF,
' || '        RTO_NF
' || '    FROM ' || P_BI_SCHEMA || '.TPLACEMT
' || '    WHERE  PLCSTS_CT IN (16,19) )TPL ON
' || '    T_RETRO.CTR_NF = TPL.RETCTR_NF
' || '    AND T_RETRO.SECUWY_NF = TPL.RTY_NF
' || '    AND T_RETRO.SSD_CF = TPL.SSD_CF
' || 'LEFT JOIN (
' || '    SELECT
' || '        RTO_RATING.RTO_NF,
' || '        CLISHONAM_LD,
' || '        RATING_CF,
' || '        NORME_CF,
' || '        DEFPROB_R,
' || '        RECOVRAT_R,
' || '        CLOSING_D
' || '    FROM    (
' || '        SELECT
' || '            RTO_NF,
' || '            TCI.CLISHONAM_LD,
' || '            COALESCE(COLVAL_LS,''NR'') AS RATING_CODE
' || '        FROM ' || '            ' || P_BI_SCHEMA || '.TPLACEMT TPL
' || '        LEFT JOIN ' || P_BI_SCHEMA || '.TCLSTABI TCL ON
' || '            TCL.CLI_NF = TPL.RTO_NF
' || '        LEFT JOIN ' || P_BI_SCHEMA || '.TBANALL TBA ON
' || '            TBA.COLVAL_CT = CAST(TCL.ISICURRAT_CT AS VARCHAR)
' || '            AND TBA.COL_LS = ''ISICURRAT_CT''
' || '            AND TBA.LAG_CF = ''E''
' || '        LEFT JOIN ' || P_BI_SCHEMA || '.TCLIENT TCI ON
' || '            TCI.CLI_NF = TPL.RTO_NF
' || '        GROUP BY
' || '            RTO_NF,
' || '            CLISHONAM_LD,
' || '            COALESCE(COLVAL_LS,''NR'') ) RTO_RATING
' || '    LEFT JOIN ' || P_BI_SCHEMA || '.TRATINGSII TRA ON
' || '        TRA.RATING_CF = RTO_RATING.RATING_CODE
' || '        AND TRA.NORME_CF = ''ALLNO'' ) T_RATE ON
' || '    T_RATE.RTO_NF = TPL.RTO_NF
' || '    AND YEAR(CAST(T_RATE.CLOSING_D AS TIMESTAMP)) <= YEAR(TIMESTAMP_FORMAT(REPORTING_DT,''DD/MM/YYYY'')) )
' || ', MAX_ROW AS
' || ' (SELECT MAX(ROW_ID) MAX_ROW_ID
' || '  FROM ' || P_DWH_SCHEMA || '.TCSM_TRT_CHARACS 
' || ' 		WHERE REPORTING_DT = VARCHAR_FORMAT(''' || P_REAL_CLOSING_DATE || ''' , ''DD/MM/YYYY'') 
' || ' 			AND CLOSING_QUARTER_CODE = ''' || P_CLOSING_QUARTER || '''
' || ' 			AND SCENARIO_ID = ' || P_SCENARIO_ID || ' 
' || ' 			AND ENTITY_ID = ''' || P_ENTITY_ID || '''
' || ' 			AND RUN_ID   = ' || P_RUN_ID || '
' || ' 			AND NORM_CD  = ''' || P_NORM_CODE || ''' 
' || ' 			AND INTERVAL =''' || P_INTERVAL || ''' )
' || ' SELECT MAX_ROW.MAX_ROW_ID + ROW_NUMBER() OVER (ORDER BY REPORTING_DT) ,
' || ' CLOSING_QUARTER_CODE,
' || ' REPORTING_DT,
' || ' SCENARIO_ID,
' || ' ENTITY_ID,
' || ' TRIM(LEGALENTITY_CF) ,
' || ' TRIM(LEGALENTITY_LL) ,
' || ' TRIM(PARTLEGENTITY_CF) ,
' || ' TRIM(PARTLEGENTITY_CF) ,
' || ' TRIM(LEBRANCH_CF),
' || ' TRIM(LEBRANCH_LL),
' || ' TRIM(PARTLEBRANCH_CF),
' || ' TRIM(PARTLEBRANCH_LL), 
' || ' TRIM(PRDSIT_CF), 
' || ' TRIM(SSD_CF), 
' || ' TRIM(SSD_LS), 
' || ' TRIM(ESB_CF), 
' || ' TRIM(ESB_LS), 
' || ' TRIM(CTR_NF), 
' || ' TRIM(CTRPCPNAM_LL), 
' || ' TRIM(SEC_NF), 
' || ' TRIM(SECLAB_LM), 
' || ' TRIM(UOA_CUR), 
' || ' TRIM(TRT_CUR), 
' || ' TRIM(PCPCUR_CF), 
' || ' TRIM(SSDCUR_CF), 
' || ' TRIM(UOA_NAME), 
' || ' TRIM(PROFIT_SIGN), 
' || ' TRIM(PROFIT_SIGN_FLG), 
' || ' TRIM(PROFIT_LVL), 
' || ' TRIM(SEG_CODE), 
' || ' TRIM(SEG_LS), 
' || ' TRIM(LOB_CF), 
' || ' TRIM(LOB_HS), 
' || ' TRIM(LIFPRDLIN_CF), 
' || ' TRIM(LIFPRDLIN_LL), 
' || ' TRIM(LIFLOB_CF), 
' || ' TRIM(LIFLOB_LL), 
' || ' TRIM(USGAAP_CT), 
' || ' TRIM(USGAAP_CT_LB), 
' || ' TRIM(BUSUNIT_CF), 
' || ' TRIM(BUSUNIT_LM), 
' || ' TRIM(MRKUNT_NT), 
' || ' TRIM(MRKUNT_LS), 
' || ' TRIM(SUBMRK_NT), 
' || ' TRIM(SUBMRK_LS), 
' || ' TRIM(CR_NF), 
' || ' TRIM(CR_LM), 
' || ' TRIM(ANNUAL_COHORT), 
' || ' TRIM(FRSSECUWY_NF), 
' || ' TRIM(CTRUWY_NF), 
' || ' TRIM(SECUWY_NF), 
' || ' TRIM(CTRINC_D), 
' || ' TRIM(SECINC_D), 
' || ' TRIM(CTRFRSINC_D), 
' || ' TRIM(SECFRSINC_D), 
' || ' TRIM(CTRFRSPAYM_D), 
' || ' TRIM(SECFRSPAYM_D), 
' || ' TRIM(FRSPRICONER_D), 
' || ' TRIM(TERM_D), 
' || ' TRIM(CANCTR_D), 
' || ' TRIM(SECCAN_D), 
' || ' TRIM(CTRNEW_CT), 
' || ' TRIM(RETFLG_CF), 
' || ' TRIM(INTOPEFL_CF), 
' || ' TRIM(TERMPERM_CF), 
' || ' TRIM(NEWORMODIF_CF), 
' || ' TRIM(MODTYP_CF), 
' || ' TRIM(SECSTS_CT), 
' || ' TRIM(SECSTS_LS), 
' || ' TRIM(ACCADMTYP_CT), 
' || ' TRIM(SECACCSTS_CT), 
' || ' TRIM(SECACCSTS_LS), 
' || ' TRIM(NAT_CF), 
' || ' TRIM(NAT_GD), 
' || ' TRIM(ACCFRQ_CT), 
' || ' TRIM(LIFTRTTYP_CF), 
' || ' TRIM(LIFTRTTYP_LS), 
' || ' TRIM(RETROTYP_CF), 
' || ' TRIM(RETRO_RA_LO_CF), 
' || ' TRIM(RENTYP_CT), 
' || ' TRIM(CTROLDNBR_LM), 
' || ' TRIM(PARSEC_NF), 
' || ' TRIM(ESTCRB_CT), 
' || ' TRIM(INSURANCE_CONTRACT_GROUP_ID), 
' || ' TRIM(RATEINDEX_CT), 
' || ' TRIM(COV_RTO), 
' || ' TRIM(COC_RTO), 
' || ' TRIM(X_DIM_RETRO_PATH_ID), 
' || ' TRIM(INTERNAL_RETRO_FLG), 
' || ' TRIM(TRANSITION_APPROACH_CD), 
' || ' TRIM(TRANSITION_FLG), 
' || ' TRIM(TRANSITION_LOCKINDATE), 
' || ' TRIM(TRANSITION_INPUT_CSM_AMT), 
' || ' TRIM(DIRECT_TRANSITION_ACQ_COSTS_AMT), 
' || ' TRIM(NPR_DEFAULT_INI_RAT), 
' || ' TRIM(NPR_DEFAULT_CURRENT_RAT), 
' || ' TRIM(NPR_RECOVERY_INI_RAT), 
' || ' TRIM(NPR_RECOVERY_CURRENT_RAT), 
' || ' TRIM(NPR_CALCULATION_FLG), 
' || ' TRIM(EXP_ADJ_PREM_CSM_ALLOC_RAT), 
' || ' TRIM(EXP_ADJ_RCOM_CSM_ALLOC_RAT), 
' || ' TRIM(EXP_ADJ_NDIC_CSM_ALLOC_RAT), 
' || ' TRIM(RUN_ID), 
' || ' TRIM(NORM_CD), 
' || ' TRIM(INTERVAL), 
' || ' TRIM(ASOFDAY),
' || ' TRIM(ICG_FLAG),
' || ' TRIM(FK_CC),
' || ' TRIM(FK_CF)
' || '  FROM  
' || ' (
' || 'SELECT ''' || P_CLOSING_QUARTER || ''' CLOSING_QUARTER_CODE,
' || '    CAST(REPORTING_DT AS VARCHAR(10)) AS REPORTING_DT,
' || '    CAST(SCENARIO_ID AS SMALLINT) AS SCENARIO_ID,
' || '    CAST(ENTITY_ID AS VARCHAR(36)) AS ENTITY_ID,
' || '    CAST(LEGALENTITY_CF AS VARCHAR(5)) AS LEGALENTITY_CF,
' || '    CAST(LEGALENTITY_LL AS VARCHAR(32)) AS LEGALENTITY_LL,
' || '    CAST(PARTLEGENTITY_CF AS VARCHAR(5)) AS PARTLEGENTITY_CF,
' || '    CAST(PARTLEGENTITY_LL AS VARCHAR(32)) AS PARTLEGENTITY_LL,
' || '    CAST(LEBRANCH_CF AS VARCHAR(5)) AS LEBRANCH_CF,
' || '    CAST(LEBRANCH_LL AS VARCHAR(32)) AS LEBRANCH_LL,
' || '    CAST(PARTLEBRANCH_CF AS VARCHAR(5)) AS PARTLEBRANCH_CF,
' || '    CAST(PARTLEBRANCH_LL AS VARCHAR(32)) AS PARTLEBRANCH_LL,
' || '    CAST(PRDSIT_CF AS VARCHAR(4)) AS PRDSIT_CF,
' || '    SSD_CF,
' || '    CAST(SSD_LS AS VARCHAR(16)) AS SSD_LS,
' || '    ESB_CF,
' || '    CAST(ESB_LS AS VARCHAR(16)) AS ESB_LS,
' || '    CAST(CTR_NF AS VARCHAR(9)) AS CTR_NF,
' || '    CAST(CTRPCPNAM_LL AS VARCHAR(64)) AS CTRPCPNAM_LL,
' || '    SEC_NF,
' || '    CAST(SECLAB_LM AS VARCHAR(32)) AS SECLAB_LM,
' || '    UOA_CUR,
' || '    CAST(TRT_CUR AS CHAR(3)) AS TRT_CUR,
' || '    CAST(PCPCUR_CF AS CHAR(3)) AS PCPCUR_CF,
' || '    CAST(SSDCUR_CF AS CHAR(3)) AS SSDCUR_CF,
' || '    CAST(UOA_NAME AS VARCHAR(36)) AS UOA_NAME,
' || '    CAST(PROFIT_SIGN AS VARCHAR(36))AS PROFIT_SIGN,
' || '    PROFIT_SIGN_FLG,
' || '    CAST(PROFIT_LVL AS VARCHAR(36)) AS PROFIT_LVL,
' || '    CAST(SEG_CODE AS VARCHAR(30)) AS SEG_CODE,
' || '    CAST(SEG_LS AS VARCHAR(64)) AS SEG_LS,
' || '    CAST(LOB_CF AS VARCHAR(2)) AS LOB_CF,
' || '    CAST(LOB_HS AS VARCHAR(20)) AS LOB_HS,
' || '    CAST(LIFPRDLIN_CF AS VARCHAR(5)) AS LIFPRDLIN_CF,
' || '    CAST(LIFPRDLIN_LL AS VARCHAR(32)) AS LIFPRDLIN_LL,
' || '    CAST(LIFLOB_CF AS VARCHAR(5)) AS LIFLOB_CF,
' || '    CAST(LIFLOB_LL AS VARCHAR(32)) AS LIFLOB_LL,
' || '    USGAAP_CT,
' || '    CAST(USGAAP_CT_LB AS VARCHAR(32)) AS USGAAP_CT_LB,
' || '    CAST(BUSUNIT_CF AS VARCHAR(9)) AS BUSUNIT_CF,
' || '    CAST(BUSUNIT_LM AS VARCHAR(32)) AS BUSUNIT_LM,
' || '    MRKUNT_NT,
' || '    CAST(MRKUNT_LS AS VARCHAR(32)) AS MRKUNT_LS,
' || '    SUBMRK_NT,
' || '    CAST(SUBMRK_LS AS VARCHAR(26)) AS SUBMRK_LS,
' || '    CAST(CR_NF AS VARCHAR(10)) AS CR_NF,
' || '    CAST(CR_LM AS VARCHAR(5)) AS CR_LM,
' || '    ANNUAL_COHORT,
' || '    FRSSECUWY_NF,
' || '    CTRUWY_NF,
' || '	  SECUWY_NF,
' || '    CAST(CTRINC_D AS VARCHAR(10)) AS CTRINC_D,
' || '    CAST(SECINC_D AS VARCHAR(10)) AS SECINC_D,
' || '    CAST(CTRFRSINC_D AS VARCHAR(10)) AS CTRFRSINC_D,
' || '    CAST(SECFRSINC_D AS VARCHAR(10)) AS SECFRSINC_D,
' || '    CAST(CTRFRSPAYM_D AS VARCHAR(10)) AS CTRFRSPAYM_D,
' || '    CAST(SECFRSPAYM_D AS VARCHAR(10)) AS SECFRSPAYM_D,
' || '    CAST(FRSPRICONER_D AS VARCHAR(10))AS FRSPRICONER_D,
' || '    CAST(TERM_D AS VARCHAR(10)) AS TERM_D,
' || '    CAST(CANCTR_D AS VARCHAR(10)) AS CANCTR_D,
' || '    CAST(SECCAN_D AS VARCHAR(10)) AS SECCAN_D,
' || '    CAST(CTRNEW_CT AS VARCHAR(1)) AS CTRNEW_CT,
' || '    RETFLG_CF,
' || '    INTOPEFL_CF,
' || '    CAST(TERMPERM_CF AS VARCHAR(12)) AS TERMPERM_CF,
' || '    NEWORMODIF_CF,
' || '    MODTYP_CF,
' || '    SECSTS_CT,
' || '    CAST(SECSTS_LS AS VARCHAR(20)) AS SECSTS_LS,
' || '    ACCADMTYP_CT,
' || '    SECACCSTS_CT,
' || '    CAST(SECACCSTS_LS AS VARCHAR(16)) AS SECACCSTS_LS,
' || '    CAST(NAT_CF AS SMALLINT) AS NAT_CF,
' || '    CAST(NAT_GD AS VARCHAR(4)) AS NAT_GD,
' || '    ACCFRQ_CT,
' || '    CAST(LIFTRTTYP_CF AS VARCHAR(2)) AS LIFTRTTYP_CF,
' || '    CAST(LIFTRTTYP_LS AS VARCHAR(20)) AS LIFTRTTYP_LS,
' || '    CAST(RETROTYP_CF AS VARCHAR(17)) AS RETROTYP_CF,
' || '    CAST(RETRO_RA_LO_CF AS VARCHAR(38))AS RETRO_RA_LO_CF,
' || '    RENTYP_CT,
' || '    CAST(CTROLDNBR_LM AS VARCHAR(10)) AS CTROLDNBR_LM,
' || '    PARSEC_NF,
' || '    CAST(ESTCRB_CT AS VARCHAR(1)) AS ESTCRB_CT,
' || '    CAST(INSURANCE_CONTRACT_GROUP_ID AS VARCHAR(36)) AS INSURANCE_CONTRACT_GROUP_ID,
' || '	CAST(RATEINDEX_CT AS VARCHAR(32)) AS RATEINDEX_CT,
' || '	CAST(COV_RTO AS DECIMAL(8,2)) AS COV_RTO,
' || '	CAST(COC_RTO AS DECIMAL(8,2)) AS COC_RTO,
' || '	CAST(X_DIM_RETRO_PATH_ID AS  VARCHAR(9)) X_DIM_RETRO_PATH_ID,
' || '	CAST(INTERNAL_RETRO_FLG AS CHAR(1)) INTERNAL_RETRO_FLG,
' || '	CAST(TRANSITION_APPROACH_CD  AS VARCHAR(6))TRANSITION_APPROACH_CD,
' || '	TRANSITION_FLG,
' || '	TRANSITION_LOCKINDATE,
' || '	TRANSITION_INPUT_CSM_AMT,
' || '	DIRECT_TRANSITION_ACQ_COSTS_AMT,
' || '	NPR_DEFAULT_INI_RAT,
' || '	NPR_DEFAULT_CURRENT_RAT,
' || '	NPR_RECOVERY_INI_RAT,
' || '	NPR_RECOVERY_CURRENT_RAT,
' || '	NPR_CALCULATION_FLG  ,
' || '	EXP_ADJ_PREM_CSM_ALLOC_RAT ,
' || '	EXP_ADJ_RCOM_CSM_ALLOC_RAT ,
' || '	EXP_ADJ_NDIC_CSM_ALLOC_RAT ,
' || '	RUN_ID,
' || '	CAST(Norm_CD  AS  VARCHAR(7)) Norm_CD,
' || '	CAST(INTERVAL AS  VARCHAR(9)) INTERVAL,
' || '	TO_CHAR(SYSDATE, ''YYYYMMDD'') ASOFDAY,
' || '  ICG_FLAG,
' || '  FK_CC,
' || '  FK_CF
' || 'FROM  (
' || '    SELECT
' || '        REPORTING_DT ,
' || '        SCENARIO_ID ,
' || '        ENTITY_ID,
' || '        LEGALENTITY_CF ,
' || '        LEGALENTITY_LL ,
' || '        PARTLEGENTITY_CF ,
' || '        PARTLEGENTITY_LL ,
' || '        LEBRANCH_CF ,
' || '        LEBRANCH_LL ,
' || '        PARTLEBRANCH_CF ,
' || '        PARTLEBRANCH_LL ,
' || '        PRDSIT_CF ,
' || '        SSD_CF ,
' || '        SSD_LS ,
' || '        ESB_CF ,
' || '        ESB_LS ,
' || '        CTR_NF ,
' || '        CTRPCPNAM_LL ,
' || '        SEC_NF ,
' || '        SECLAB_LM ,
' || '        UOA_CUR ,
' || '        TRT_CUR ,
' || '        PCPCUR_CF ,
' || '        SSDCUR_CF ,
' || '        UOA_NAME ,
' || '        PROFIT_SIGN,
' || '        PROFIT_SIGN_FLG ,
' || '        PROFIT_LVL,
' || '        SEG_CODE ,
' || '        SEG_LS ,
' || '        LOB_CF ,
' || '        LOB_HS ,
' || '        LIFPRDLIN_CF ,
' || '        LIFPRDLIN_LL ,
' || '        LIFLOB_CF ,
' || '        LIFLOB_LL ,
' || '        USGAAP_CT ,
' || '        USGAAP_CT_LB ,
' || '        BUSUNIT_CF ,
' || '        BUSUNIT_LM ,
' || '        MRKUNT_NT ,
' || '        MRKUNT_LS ,
' || '        SUBMRK_NT ,
' || '        SUBMRK_LS ,
' || '        CR_NF ,
' || '        CR_LM ,
' || '        ANNUAL_COHORT ,
' || '        FRSSECUWY_NF ,
' || '        CTRUWY_NF ,
' || '        SECUWY_NF ,
' || '        CTRINC_D ,
' || '        SECINC_D ,
' || '        CTRFRSINC_D ,
' || '        SECFRSINC_D ,
' || '        CTRFRSPAYM_D ,
' || '        SECFRSPAYM_D ,
' || '        FRSPRICONER_D ,
' || '        TERM_D ,
' || '        CANCTR_D ,
' || '        SECCAN_D ,
' || '        CTRNEW_CT ,
' || '        RETFLG_CF ,
' || '        INTOPEFL_CF ,
' || '        TERMPERM_CF ,
' || '        NEWORMODIF_CF ,
' || '        MODTYP_CF ,
' || '        SECSTS_CT ,
' || '        SECSTS_LS ,
' || '        ACCADMTYP_CT ,
' || '        SECACCSTS_CT ,
' || '        SECACCSTS_LS ,
' || '        NAT_CF ,
' || '        NAT_GD ,
' || '        ACCFRQ_CT ,
' || '        LIFTRTTYP_CF ,
' || '        LIFTRTTYP_LS ,
' || '        RETROTYP_CF ,
' || '        RETRO_RA_LO_CF ,
' || '        RENTYP_CT ,
' || '        CTROLDNBR_LM ,
' || '        PARSEC_NF ,
' || '        ESTCRB_CT ,
' || '        INSURANCE_CONTRACT_GROUP_ID ,
' || '        RATEINDEX_CT ,
' || '        COV_RTO ,
' || '        COC_RTO ,
' || '        X_DIM_RETRO_PATH_ID,
' || '        INTERNAL_RETRO_FLG,
' || '        TRANSITION_APPROACH_CD,
' || '        TRANSITION_FLG,
' || '        TRANSITION_LOCKINDATE,
' || '        TRANSITION_INPUT_CSM_AMT,
' || '        DIRECT_TRANSITION_ACQ_COSTS_AMT,
' || '        NPR_DEFAULT_INI_RAT,
' || '        NPR_DEFAULT_CURRENT_RAT,
' || '        NPR_RECOVERY_INI_RAT,
' || '        NPR_RECOVERY_CURRENT_RAT,
' || '        NPR_CALCULATION_FLG,
' || '        EXP_ADJ_PREM_CSM_ALLOC_RAT,
' || '        EXP_ADJ_RCOM_CSM_ALLOC_RAT,
' || '        EXP_ADJ_NDIC_CSM_ALLOC_RAT,
' || '        RUN_ID,
' || '        Norm_CD,
' || '        INTERVAL,
' || '		  ICG_FLAG,
' || '        FK_CC,
' || '        FK_CF,
' || '        ROW_NUMBER () OVER (PARTITION BY REPORTING_DT,
' || '        CTR_NF,
' || '        SEC_NF,
' || '        SECUWY_NF,
' || '        SSD_CF
' || '    ORDER BY
' || '        DEFAULT_PROBABILITY_RATE_CURRENT*RECOVERY_RATE_CURRENT DESC) ROW_NUMBER_VALUE
' || '    FROM ' || '        (
' || '        SELECT
' || '            T_RETRO.REPORTING_DT ,
' || '            T_RETRO.SCENARIO_ID ,
' || '            T_RETRO.ENTITY_ID,
' || '            T_RETRO.LEGALENTITY_CF ,
' || '            T_RETRO.LEGALENTITY_LL ,
' || '            T_RETRO.PARTLEGENTITY_CF ,
' || '            T_RETRO.PARTLEGENTITY_LL ,
' || '            T_RETRO.LEBRANCH_CF ,
' || '            T_RETRO.LEBRANCH_LL ,
' || '            T_RETRO.PARTLEBRANCH_CF ,
' || '            T_RETRO.PARTLEBRANCH_LL ,
' || '            T_RETRO.PRDSIT_CF ,
' || '            T_RETRO.SSD_CF ,
' || '            T_RETRO.SSD_LS ,
' || '            T_RETRO.ESB_CF ,
' || '            T_RETRO.ESB_LS ,
' || '            T_RETRO.CTR_NF ,
' || '            T_RETRO.CTRPCPNAM_LL ,
' || '            T_RETRO.SEC_NF ,
' || '            T_RETRO.SECLAB_LM ,
' || '            T_RETRO.UOA_CUR ,
' || '            T_RETRO.TRT_CUR ,
' || '            T_RETRO.PCPCUR_CF ,
' || '            T_RETRO.SSDCUR_CF ,
' || '            T_RETRO.UOA_NAME ,
' || '            T_RETRO.PROFIT_SIGN ,
' || '            T_RETRO.PROFIT_SIGN_FLG ,
' || '            T_RETRO.PROFIT_LVL ,
' || '            T_RETRO.SEG_CODE ,
' || '            T_RETRO.SEG_LS ,
' || '            T_RETRO.LOB_CF ,
' || '            T_RETRO.LOB_HS ,
' || '            T_RETRO.LIFPRDLIN_CF ,
' || '            T_RETRO.LIFPRDLIN_LL ,
' || '            T_RETRO.LIFLOB_CF ,
' || '            T_RETRO.LIFLOB_LL ,
' || '            T_RETRO.USGAAP_CT ,
' || '            T_RETRO.USGAAP_CT_LB ,
' || '            T_RETRO.BUSUNIT_CF ,
' || '            T_RETRO.BUSUNIT_LM ,
' || '            T_RETRO.MRKUNT_NT ,
' || '            T_RETRO.MRKUNT_LS ,
' || '            T_RETRO.SUBMRK_NT ,
' || '            T_RETRO.SUBMRK_LS ,
' || '            T_RETRO.CR_NF ,
' || '            T_RETRO.CR_LM ,
' || '            T_RETRO.ANNUAL_COHORT ,
' || '            T_RETRO.FRSSECUWY_NF ,
' || '            T_RETRO.CTRUWY_NF ,
' || '            T_RETRO.SECUWY_NF ,
' || '            T_RETRO.CTRINC_D ,
' || '            T_RETRO.SECINC_D ,
' || '            T_RETRO.CTRFRSINC_D ,
' || '            T_RETRO.SECFRSINC_D ,
' || '            T_RETRO.CTRFRSPAYM_D ,
' || '            T_RETRO.SECFRSPAYM_D ,
' || '            T_RETRO.FRSPRICONER_D ,
' || '            T_RETRO.TERM_D ,
' || '            T_RETRO.CANCTR_D ,
' || '            T_RETRO.SECCAN_D ,
' || '            T_RETRO.CTRNEW_CT ,
' || '            T_RETRO.RETFLG_CF ,
' || '            T_RETRO.INTOPEFL_CF ,
' || '            T_RETRO.TERMPERM_CF ,
' || '            T_RETRO.NEWORMODIF_CF ,
' || '            T_RETRO.MODTYP_CF ,
' || '            T_RETRO.SECSTS_CT ,
' || '            T_RETRO.SECSTS_LS ,
' || '            T_RETRO.ACCADMTYP_CT ,
' || '            T_RETRO.SECACCSTS_CT ,
' || '            T_RETRO.SECACCSTS_LS ,
' || '            T_RETRO.NAT_CF ,
' || '            T_RETRO.NAT_GD ,
' || '            T_RETRO.ACCFRQ_CT ,
' || '            T_RETRO.LIFTRTTYP_CF ,
' || '            T_RETRO.LIFTRTTYP_LS ,
' || '            T_RETRO.RETROTYP_CF ,
' || '            T_RETRO.RETRO_RA_LO_CF ,
' || '            T_RETRO.RENTYP_CT ,
' || '            T_RETRO.CTROLDNBR_LM ,
' || '            T_RETRO.PARSEC_NF ,
' || '            T_RETRO.ESTCRB_CT ,
' || '            T_RETRO.INSURANCE_CONTRACT_GROUP_ID ,
' || '            T_RETRO.RATEINDEX_CT ,
' || '            T_RETRO.COV_RTO ,
' || '            T_RETRO.COC_RTO ,
' || '            T_RETRO.X_DIM_RETRO_PATH_ID,
' || '            T_RETRO.INTERNAL_RETRO_FLG,
' || '            T_RETRO.TRANSITION_APPROACH_CD,
' || '            T_RETRO.TRANSITION_FLG,
' || '            T_RETRO.TRANSITION_LOCKINDATE,
' || '            T_RETRO.TRANSITION_INPUT_CSM_AMT,
' || '            T_RETRO.DIRECT_TRANSITION_ACQ_COSTS_AMT,
' || '            T_RETRO.NPR_DEFAULT_INI_RAT,
' || '            T_RETRO.NPR_DEFAULT_CURRENT_RAT,
' || '            T_RETRO.NPR_RECOVERY_INI_RAT,
' || '            T_RETRO.NPR_RECOVERY_CURRENT_RAT,
' || '            T_RETRO.NPR_CALCULATION_FLG,
' || '            T_RETRO.EXP_ADJ_PREM_CSM_ALLOC_RAT,
' || '            T_RETRO.EXP_ADJ_RCOM_CSM_ALLOC_RAT,
' || '            T_RETRO.EXP_ADJ_NDIC_CSM_ALLOC_RAT,
' || '            T_RETRO.RUN_ID,
' || '            T_RETRO.Norm_CD,
' || '            T_RETRO.INTERVAL,
' || ' 			  T_RETRO.ICG_FLAG,
' || ' 			  T_RETRO.FK_CC,
' || ' 			  T_RETRO.FK_CF,
' || '            T_RATE_CURRENT_FINAL.RTO_NF ,
' || '            T_RATE_CURRENT_FINAL.RATING_CF ,
' || '            T_RATE_CURRENT_FINAL.ROW_NUMBER_VALUE ,
' || '            T_RATE_CURRENT_FINAL.CLOSING_D AS CLOSING_DATE_CURRENT ,
' || '            T_RATE_CURRENT_FINAL.DEFPROB_R AS DEFAULT_PROBABILITY_RATE_CURRENT ,
' || '            T_RATE_CURRENT_FINAL.RECOVRAT_R AS RECOVERY_RATE_CURRENT ,
' || '            COALESCE(T_RATE_INIT_FINAL.ROW_NUMBER_VALUE,T_RATE_INIT_2_FINAL.ROW_NUMBER_VALUE) ,
' || '            COALESCE(T_RATE_INIT_FINAL.CLOSING_D,T_RATE_INIT_2_FINAL.CLOSING_D) AS CLOSING_DATE_INIT ,
' || '            COALESCE(T_RATE_INIT_FINAL.DEFPROB_R,T_RATE_INIT_2_FINAL.DEFPROB_R) AS DEFAULT_PROBABILITY_RATE_INIT ,
' || '            COALESCE(T_RATE_INIT_FINAL.RECOVRAT_R,T_RATE_INIT_2_FINAL.RECOVRAT_R) AS RECOVERY_RATE_INIT,
' || '            ROW_NUMBER () OVER (PARTITION BY T_RETRO.REPORTING_DT,T_RETRO.CTR_NF,T_RETRO.SEC_NF,T_RETRO.SECUWY_NF,T_RETRO.SSD_CF 
' || '                ORDER BY T_RATE_CURRENT_FINAL.DEFPROB_R*T_RATE_CURRENT_FINAL.RECOVRAT_R DESC) ROW_NUM_VALUE
' || '        FROM    VIEW_CSM_TRT_RETRO T_RETRO
' || '        LEFT JOIN ( SELECT *,
' || '                        ROW_NUMBER () OVER (PARTITION BY REPORTING_DT,CTR_NF,SEC_NF,SECUWY_NF, SSD_CF,RTO_NF,CLISHONAM_LD,RATING_CF, NORME_CF 
' || '                            ORDER BY CLOSING_D DESC) ROW_NUMBER_VALUE
' || '                    FROM T_RATE_ALL
' || '                    WHERE RETFLG_CF = ''Y'') T_RATE_CURRENT_FINAL ON
' || '            T_RATE_CURRENT_FINAL.REPORTING_DT = T_RETRO.REPORTING_DT
' || '            AND T_RATE_CURRENT_FINAL.CTR_NF = T_RETRO.CTR_NF
' || '            AND T_RATE_CURRENT_FINAL.SEC_NF = T_RETRO.SEC_NF
' || '            AND T_RATE_CURRENT_FINAL.SECUWY_NF = T_RETRO.SECUWY_NF
' || '            AND T_RATE_CURRENT_FINAL.SSD_CF = T_RETRO.SSD_CF
' || '            AND T_RATE_CURRENT_FINAL.ROW_NUMBER_VALUE = 1
' || '        LEFT JOIN ( SELECT *,
' || '                        ROW_NUMBER () OVER (PARTITION BY REPORTING_DT,CTR_NF,SEC_NF,SECUWY_NF, SSD_CF,RTO_NF,CLISHONAM_LD,RATING_CF, NORME_CF 
' || '                            ORDER BY CLOSING_D DESC) ROW_NUMBER_VALUE
' || '                    FROM T_RATE_ALL
' || '                    WHERE CAST(CLOSING_D AS TIMESTAMP) = TIMESTAMP_FORMAT(REPORTING_DT,''DD/MM/YYYY'')) T_RATE_INIT_FINAL ON
' || '            T_RATE_INIT_FINAL.REPORTING_DT = T_RETRO.REPORTING_DT
' || '            AND T_RATE_INIT_FINAL.CTR_NF = T_RETRO.CTR_NF
' || '            AND T_RATE_INIT_FINAL.SEC_NF = T_RETRO.SEC_NF
' || '            AND T_RATE_INIT_FINAL.SECUWY_NF = T_RETRO.SECUWY_NF
' || '            AND T_RATE_INIT_FINAL.SSD_CF = T_RETRO.SSD_CF
' || '            AND T_RATE_INIT_FINAL.ROW_NUMBER_VALUE = 1
' || '        LEFT JOIN ( SELECT *,
' || '                        ROW_NUMBER () OVER (PARTITION BY REPORTING_DT,CTR_NF,SEC_NF,SECUWY_NF, SSD_CF,RTO_NF,CLISHONAM_LD,RATING_CF, NORME_CF 
' || '                            ORDER BY CLOSING_D DESC) ROW_NUMBER_VALUE
' || '                    FROM T_RATE_ALL
' || '                    WHERE CAST(CLOSING_D AS TIMESTAMP) <> TIMESTAMP_FORMAT(REPORTING_DT,''DD/MM/YYYY'') ) T_RATE_INIT_2_FINAL ON
' || '            T_RATE_INIT_2_FINAL.REPORTING_DT = T_RETRO.REPORTING_DT
' || '            AND T_RATE_INIT_2_FINAL.CTR_NF = T_RETRO.CTR_NF
' || '            AND T_RATE_INIT_2_FINAL.SEC_NF = T_RETRO.SEC_NF
' || '            AND T_RATE_INIT_2_FINAL.SECUWY_NF = T_RETRO.SECUWY_NF
' || '            AND T_RATE_INIT_2_FINAL.SSD_CF = T_RETRO.SSD_CF
' || '            AND T_RATE_INIT_2_FINAL.ROW_NUMBER_VALUE = 1) NPR_QUERY
' || '    WHERE ROW_NUM_VALUE = 1 ))
' || '    LEFT JOIN MAX_ROW ON 1=1';


EXECUTE IMMEDIATE V_RETRO_QUERY;


EXECUTE IMMEDIATE 'COMMIT;';


EXECUTE IMMEDIATE 'DROP TABLE SESSION.IFRS17_CSM_TRT_CHARACS_FLAG IF EXISTS';


EXECUTE IMMEDIATE 'COMMIT';


EXCEPTION WHEN OTHERS THEN L_ERR_CD := substr(SQLERRM,8,5);
L_ERR_MSG := SQLERRM;
RAISE EXCEPTION '% Error while executing SQL statement',L_ERR_MSG;
DROP TABLE SESSION.IFRS17_CSM_TRT_CHARACS_FLAG IF EXISTS;

RETURN L_ERR_CD;
END;


END_PROC;