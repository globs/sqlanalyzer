CREATE OR REPLACE
VIEW V_CONTROL_STATS_I17_ATTRIBUTE_PARENT (SSD_CF,
ESB_CF,
STAT_NAME,
STAT_VALUE,
BALSHRMTH_NF,
BALSHEY_NF) AS (
SELECT
	SSD_CF,
	ESB_CF,
	'I17_ATTRIBUTE_CTR' AS STAT_NAME,
	COUNT(DISTINCT CTR_NF) AS STAT_VALUE,
	BALSHRMTH_NF,
	BALSHEY_NF
FROM
	BI_<env>.TFULLGLT A
JOIN BI_<env>.TI17PRODUCT B ON
	A.NEWCOLS3_NF = B.I17PRDCOD_CT
WHERE
	CTR_NF IS NOT NULL
	AND CTR_NF != ''
	AND SUBSTRING(TRNCOD_CF, 8, 1) IN ('K', 'L')
GROUP BY
	SSD_CF,
	ESB_CF,
	BALSHRMTH_NF,
	BALSHEY_NF
UNION
SELECT
	SSD_CF,
	ESB_CF,
	'I17_ATTRIBUTE_RETCTR' AS STAT_NAME,
	COUNT(DISTINCT RETCTR_NF) AS STAT_VALUE,
	BALSHRMTH_NF,
	BALSHEY_NF
FROM
	BI_<env>.TFULLGLT A
JOIN BI_<env>.TI17PRODUCT B ON
	A.NEWCOLS3_NF = B.I17PRDCOD_CT
WHERE
	(CTR_NF IS NULL
	OR CTR_NF = '')
	AND SUBSTRING(TRNCOD_CF, 8, 1) IN ('K', 'L')
GROUP BY
	SSD_CF,
	ESB_CF,
	BALSHRMTH_NF,
	BALSHEY_NF
UNION
SELECT
	SSD_CF,
	ESB_CF,
	'I17_ATTRIBUTE_PORTFOLIO' AS STAT_NAME,
	COUNT(DISTINCT CTR_NF) AS STAT_VALUE,
	BALSHRMTH_NF,
	BALSHEY_NF
FROM
	BI_<env>.TFULLGLT A
JOIN BI_<env>.TI17PRODUCT B ON
	A.NEWCOLS3_NF = B.I17PRDCOD_CT
WHERE
	CTR_NF IS NOT NULL
	AND CTR_NF != ''
	AND SUBSTRING(TRNCOD_CF, 8, 1) IN ('K', 'L')
	AND PARIFRSSEG_CT IS NULL
GROUP BY
	SSD_CF,
	ESB_CF,
	BALSHRMTH_NF,
	BALSHEY_NF
UNION
SELECT
	SSD_CF,
	ESB_CF,
	'I17_ATTRIBUTE_PROFITABILITY' AS STAT_NAME,
	COUNT(DISTINCT CTR_NF) AS STAT_VALUE,
	BALSHRMTH_NF,
	BALSHEY_NF
FROM
	BI_<env>.TFULLGLT A
JOIN BI_<env>.TI17PRODUCT B ON
	A.NEWCOLS3_NF = B.I17PRDCOD_CT
WHERE
	CTR_NF IS NOT NULL
	AND CTR_NF != ''
	AND SUBSTRING(TRNCOD_CF, 8, 1) IN ('K', 'L')
	AND PARINIPRO_CF IS NULL
GROUP BY
	SSD_CF,
	ESB_CF,
	BALSHRMTH_NF,
	BALSHEY_NF
UNION
SELECT
	SSD_CF,
	ESB_CF,
	'I17_ATTRIBUTE_TRANSITION' AS STAT_NAME,
	COUNT(DISTINCT CTR_NF) AS STAT_VALUE,
	BALSHRMTH_NF,
	BALSHEY_NF
FROM
	BI_<env>.TFULLGLT A
JOIN BI_<env>.TI17PRODUCT B ON
	A.NEWCOLS3_NF = B.I17PRDCOD_CT
WHERE
	CTR_NF IS NOT NULL
	AND CTR_NF != ''
	AND SUBSTRING(TRNCOD_CF, 8, 1) IN ('K', 'L')
	AND PARIFRSTRA_CT IS NULL
GROUP BY
	SSD_CF,
	ESB_CF,
	BALSHRMTH_NF,
	BALSHEY_NF
UNION
SELECT
	SSD_CF,
	ESB_CF,
	'I17_ATTRIBUTE_RETRO_PORTFOLIO' AS STAT_NAME,
	COUNT(DISTINCT RETCTR_NF) AS STAT_VALUE,
	BALSHRMTH_NF,
	BALSHEY_NF
FROM
	BI_<env>.TFULLGLT A
JOIN BI_<env>.TI17PRODUCT B ON
	A.NEWCOLS3_NF = B.I17PRDCOD_CT
WHERE
	(CTR_NF IS NULL
	OR CTR_NF = '')
	AND SUBSTRING(TRNCOD_CF, 8, 1) IN ('K', 'L')
	AND PARIFRSSEG_CT IS NULL
GROUP BY
	SSD_CF,
	ESB_CF,
	BALSHRMTH_NF,
	BALSHEY_NF
UNION
SELECT
	SSD_CF,
	ESB_CF,
	'I17_ATTRIBUTE_RETRO_PROFITABILITY' AS STAT_NAME,
	COUNT(DISTINCT RETCTR_NF) AS STAT_VALUE,
	BALSHRMTH_NF,
	BALSHEY_NF
FROM
	BI_<env>.TFULLGLT A
JOIN BI_<env>.TI17PRODUCT B ON
	A.NEWCOLS3_NF = B.I17PRDCOD_CT
WHERE
	(CTR_NF IS NULL
	OR CTR_NF = '')
	AND SUBSTRING(TRNCOD_CF, 8, 1) IN ('K', 'L')
	AND PARINIPRO_CF IS NULL
GROUP BY
	SSD_CF,
	ESB_CF,
	BALSHRMTH_NF,
	BALSHEY_NF
UNION
SELECT
	SSD_CF,
	ESB_CF,
	'I17_ATTRIBUTE_RETRO_TRANSITION' AS STAT_NAME,
	COUNT(DISTINCT RETCTR_NF) AS STAT_VALUE,
	BALSHRMTH_NF,
	BALSHEY_NF
FROM
	BI_<env>.TFULLGLT A
JOIN BI_<env>.TI17PRODUCT B ON
	A.NEWCOLS3_NF = B.I17PRDCOD_CT
WHERE
	(CTR_NF IS NULL
	OR CTR_NF = '')
	AND SUBSTRING(TRNCOD_CF, 8, 1) IN ('K', 'L')
	AND PARIFRSTRA_CT IS NULL
GROUP BY
	SSD_CF,
	ESB_CF,
	BALSHRMTH_NF,
	BALSHEY_NF);