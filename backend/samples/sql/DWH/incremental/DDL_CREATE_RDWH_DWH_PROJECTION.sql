SET SQL_COMPAT='DB2'; 

DROP TABLE DWH_PROJECTION IF EXISTS;

CREATE TABLE DWH_PROJECTION (
   CONTRACT_NUMBER      CHAR(9)                     NOT NULL,
   UNDERWRITING_YEAR    SMALLINT                    NOT NULL,
   SECTION_NUMBER       SMALLINT                    NOT NULL,
   UNDERWRITING_ORDER   SMALLINT,
   ENDORSEMENT_NUMBER   SMALLINT,
   POLICY_UW_YEAR       SMALLINT,
   CLOSING_DATE         DATE                        NOT NULL,
   VALUATION_DATE       DATE                        NOT NULL,
   BUSINESS_MATURITY_ID SMALLINT                    NOT NULL,
   REPORTING_BASIS_ID   SMALLINT                    NOT NULL,
   ASSUMED_CONTRACT_NUMBER CHAR(9),
   ASSUMED_SECTION_NUMBER SMALLINT,
   POSITION_ID          INTEGER                     NOT NULL,
   LEVEL_OF_ANALYSIS_ID INTEGER                     NOT NULL,
   SCENARIO_TYPE_ID     INTEGER                     NOT NULL,
   SCENARIO_PARAMETER   DECIMAL(10,6)               NOT NULL,
   SPLIT_TYPE_ID        SMALLINT,
   CURRENCY_CODE        CHAR(3)                     NOT NULL,
   PROJECTION_YEAR      SMALLINT                    NOT NULL,
   PROJECTION_MONTH     SMALLINT                    NOT NULL,
   PROJECTION_DATE      DATE                        NOT NULL,
   HASH_KEY             VARBINARY(64)               NOT NULL
      GENERATED ALWAYS AS (HASH(NVL(CONTRACT_NUMBER,'0')||'-'
      ||NVL(UNDERWRITING_YEAR,'0')||'-'
      ||NVL(SECTION_NUMBER,'0')||'-'
      ||NVL(UNDERWRITING_ORDER,'0')||'-'
      ||NVL(ENDORSEMENT_NUMBER,'0')||'-'
      ||NVL(POLICY_UW_YEAR,'0')||'-'
      ||NVL(VARCHAR_FORMAT(CLOSING_DATE, 'YYYYMMDD'),'0')||'-'
      ||NVL(BUSINESS_MATURITY_ID,'0')||'-'
      ||NVL(REPORTING_BASIS_ID,'0')||'-'
      ||NVL(ASSUMED_CONTRACT_NUMBER,'0')||'-'
      ||NVL(ASSUMED_SECTION_NUMBER,'0')||'-'
      ||NVL(SPLIT_TYPE_ID,'0')||'-'
      ||NVL(POSITION_ID,'0')||'-'
      ||NVL(LEVEL_OF_ANALYSIS_ID,'0')||'-'
      ||NVL(SCENARIO_TYPE_ID,'0')||'-'
      ||NVL(SCENARIO_PARAMETER,'0')||'-'
      ||NVL(CURRENCY_CODE,'0')||'-'
      ||NVL(PROJECTION_YEAR,'0')||'-'
      ||NVL(PROJECTION_MONTH, '0'), 2) ),
   HASH_KEY_FULL        VARBINARY(64)               NOT NULL,
   HASH_KEY_DELTA       VARBINARY(64)               NOT NULL,
   PIVOT_KEY            VARBINARY(64)               NOT NULL,
   VALID_FROM           TIMESTAMP                   NOT NULL,
   VALID_TO             TIMESTAMP                   NOT NULL,
   SUPP_DATE            TIMESTAMP                   NOT NULL,
   PERIOD_TYPE_ID       SMALLINT                    NOT NULL,
   AMOUNT               DECFLOAT                    NOT NULL,
   CREATED_BY           VARCHAR(64)                 NOT NULL,
   CREATED_REQUEST_ID   BIGINT                      NOT NULL,
   MODIFIED_REQUEST_ID  BIGINT,
   DELETED_REQUEST_ID   BIGINT,
   MATURITY             SMALLINT                    NOT NULL       GENERATED ALWAYS AS ( MONTHS_BETWEEN (PROJECTION_DATE,VALUATION_DATE)),
   CONSTRAINT PK_DWH_PROJECTION PRIMARY KEY (HASH_KEY, VALID_FROM)  
)
 in TBS_<env>  DISTRIBUTE BY hash(HASH_KEY);

COMMENT ON TABLE DWH_PROJECTION IS
'IPDS Projection delivered by the Modelling Engines';

COMMENT ON COLUMN DWH_PROJECTION.CONTRACT_NUMBER IS
'Numéro de contrat';

COMMENT ON COLUMN DWH_PROJECTION.UNDERWRITING_YEAR IS
'Accounting Type = 2  --> Underwriting Year = Policy Underwriting Year
Accounting Type =  1 --> Policy Year is null and Underwriting Year is th
e most recent Underwriting Year';

COMMENT ON COLUMN DWH_PROJECTION.SECTION_NUMBER IS
'Numéro de la section';

COMMENT ON COLUMN DWH_PROJECTION.UNDERWRITING_ORDER IS
'Numéro d''ordre exercice de souscription';

COMMENT ON COLUMN DWH_PROJECTION.ENDORSEMENT_NUMBER IS
'Numéro d''avenant';

COMMENT ON COLUMN DWH_PROJECTION.POLICY_UW_YEAR IS
'If the contract is marked as accounting type  (SECACCSTS_CT = 1) the Po
licy UW Year has to be set equal the Treaty Section UW Year
else the Policy UW Year should be mandatory';

COMMENT ON COLUMN DWH_PROJECTION.CURRENCY_CODE IS
'Currency code';

COMMENT ON COLUMN DWH_PROJECTION.PROJECTION_DATE IS
'concatination of the last day of the month plus the projection month an
d projection year';

COMMENT ON COLUMN DWH_PROJECTION.SUPP_DATE IS
'Date when the record is deleted. ';

ALTER TABLE DWH_PROJECTION
   ADD CONSTRAINT FK_PROJECTION_CRITERIA_BUSINESS_MATURITY FOREIGN KEY 
(BUSINESS_MATURITY_ID)
      REFERENCES DWH_BUSINESS_MATURITY (ID)
      ON DELETE RESTRICT
      NOT ENFORCED;

ALTER TABLE DWH_PROJECTION
   ADD CONSTRAINT FK_PROJECTION_CRITERIA_REPORTING_BASIS FOREIGN KEY 
(REPORTING_BASIS_ID)
      REFERENCES DWH_REPORTING_BASIS (ID)
      ON DELETE RESTRICT
      NOT ENFORCED;

ALTER TABLE DWH_PROJECTION
   ADD CONSTRAINT FK_PROJECTION_LEVEL_OF_ANALYSIS FOREIGN KEY 
(LEVEL_OF_ANALYSIS_ID)
      REFERENCES DWH_LEVEL_OF_ANALYSIS (ID)
      ON DELETE RESTRICT
      NOT ENFORCED;

ALTER TABLE DWH_PROJECTION
   ADD CONSTRAINT FK_PROJECTION_PERIOD_TYPE FOREIGN KEY (PERIOD_TYPE_ID)

      REFERENCES DWH_PERIOD_TYPE (ID)
      ON DELETE RESTRICT
      NOT ENFORCED;

ALTER TABLE DWH_PROJECTION
   ADD CONSTRAINT FK_PROJECTION_POSITION FOREIGN KEY (POSITION_ID)
      REFERENCES DWH_POSITION (ID)
      ON DELETE NO ACTION
      NOT ENFORCED;

ALTER TABLE DWH_PROJECTION
   ADD CONSTRAINT FK_PROJECTION_SCENARIO_TYPE FOREIGN KEY 
(SCENARIO_TYPE_ID)
      REFERENCES DWH_SCENARIO_TYPE (ID)
      ON DELETE RESTRICT
      NOT ENFORCED;

ALTER TABLE DWH_PROJECTION
   ADD CONSTRAINT FK_PROJECTION_SPLIT_TYPE FOREIGN KEY (SPLIT_TYPE_ID)
      REFERENCES DWH_SPLIT_TYPE (ID)
      ON DELETE RESTRICT
      NOT ENFORCED;