SET SQL_COMPAT='DB2'; 

DROP TABLE DTM_PROJECTION_FACT IF EXISTS;

CREATE TABLE DTM_PROJECTION_FACT (
   CONTRACT_NUMBER          CHAR(9)         NOT NULL,
   UNDERWRITING_YEAR        SMALLINT        NOT NULL,
   SECTION_NUMBER           SMALLINT        NOT NULL,
   UNDERWRITING_ORDER       SMALLINT        ,
   ENDORSEMENT_NUMBER       SMALLINT        ,
   POLICY_UW_YEAR           SMALLINT        ,
   CLOSING_DATE             DATE            NOT NULL,
   VALUATION_DATE           DATE            NOT NULL,
   BUSINESS_MATURITY_ID     SMALLINT        NOT NULL,
   REPORTING_BASIS_ID       SMALLINT        NOT NULL,
   ASSUMED_CONTRACT_NUMBER  CHAR(9)         ,    
   ASSUMED_SECTION_NUMBER   SMALLINT        ,   
   POSITION_ID              INTEGER         NOT NULL,
   LEVEL_OF_ANALYSIS_ID     INTEGER         NOT NULL,
   SCENARIO_TYPE_ID         INTEGER         NOT NULL,
   SCENARIO_PARAMETER       DECIMAL(10,6)   NOT NULL,
   CURRENCY_CODE            CHAR(3)         NOT NULL,
   SPLIT_TYPE_ID            SMALLINT        ,   
   PROJECTION_YEAR          SMALLINT        NOT NULL,
   PROJECTION_MONTH         SMALLINT        NOT NULL,
   PROJECTION_DATE          DATE            NOT NULL,
   PERIOD_TYPE_ID           SMALLINT        NOT NULL,
   ORIGINAL_PERIOD_TYPE_ID  SMALLINT        , 
   AMOUNT                   DECFLOAT        NOT NULL,
   MATURITY                 SMALLINT        NOT NULL GENERATED ALWAYS AS ( MONTHS_BETWEEN (PROJECTION_DATE,VALUATION_DATE)),
   IS_IPDS                  BOOLEAN         NOT NULL,
   IS_COMPOSITE             BOOLEAN         NOT NULL,
   IS_DELTA                 BOOLEAN         NOT NULL,
   IS_CSM                   BOOLEAN         NOT NULL,
   HASH_KEY                 VARBINARY(64)   NOT NULL,
   VALID_FROM               TIMESTAMP       NOT NULL,
   VALID_TO                 TIMESTAMP       NOT NULL,
   PIVOT_KEY                VARBINARY(64)   NOT NULL,
   SUPP_DATE                TIMESTAMP       NOT NULL,
   CREATED_REQUEST_ID       BIGINT          NOT NULL,
   MODIFIED_REQUEST_ID      BIGINT          ,
   DELETED_REQUEST_ID       BIGINT          ,
   AOC_RULE_CD              VARCHAR(4)      ,
   CONSTRAINT PK_DTM_PROJECTION_FACT PRIMARY KEY (HASH_KEY, VALID_FROM) 
 
)
 in TBS_<env>  DISTRIBUTE BY hash(HASH_KEY);

COMMENT ON TABLE DTM_PROJECTION_FACT IS
'Calculated Position for the Projection delivered by the Modelling engines';

COMMENT ON COLUMN DTM_PROJECTION_FACT.CONTRACT_NUMBER IS
'Numéro de contrat';

COMMENT ON COLUMN DTM_PROJECTION_FACT.UNDERWRITING_YEAR IS
'Accounting Type = 2  --> Underwriting Year = Policy Underwriting Year
Accounting Type =  1 --> Policy Year is null and Underwriting Year is the most recent Underwriting Year';

COMMENT ON COLUMN DTM_PROJECTION_FACT.SECTION_NUMBER IS
'Numéro de la section';

COMMENT ON COLUMN DTM_PROJECTION_FACT.UNDERWRITING_ORDER IS
'Numéro d''ordre exercice de souscription';

COMMENT ON COLUMN DTM_PROJECTION_FACT.ENDORSEMENT_NUMBER IS
'Numéro d''avenant';

COMMENT ON COLUMN DTM_PROJECTION_FACT.POLICY_UW_YEAR IS
'If the contract is marked as accounting type  (SECACCSTS_CT = 1) the Policy UW Year has to be set equal the Treaty Section UW Year else the Policy UW Year should be mandatory';

COMMENT ON COLUMN DTM_PROJECTION_FACT.CURRENCY_CODE IS
'Currency code';

COMMENT ON COLUMN DTM_PROJECTION_FACT.PROJECTION_DATE IS
'concatination of the last day of the month plus the projection month and projection year';

COMMENT ON COLUMN DTM_PROJECTION_FACT.SUPP_DATE IS
'Date when the record is deleted. ';

ALTER TABLE DTM_PROJECTION_FACT
   ADD CONSTRAINT FK_DTM_PROJECTION_BUSINESS_MATURITY FOREIGN KEY 
(BUSINESS_MATURITY_ID)
      REFERENCES DWH_BUSINESS_MATURITY (ID)
      ON DELETE RESTRICT
      NOT ENFORCED;

ALTER TABLE DTM_PROJECTION_FACT
   ADD CONSTRAINT FK_DTM_PROJECTION_LEVEL_OF_ANALYSIS FOREIGN KEY 
(LEVEL_OF_ANALYSIS_ID)
      REFERENCES DWH_LEVEL_OF_ANALYSIS (ID)
      ON DELETE RESTRICT
      NOT ENFORCED;

ALTER TABLE DTM_PROJECTION_FACT
   ADD CONSTRAINT FK_DTM_PROJECTION_PERIOD_TYPE FOREIGN KEY 
(PERIOD_TYPE_ID)
      REFERENCES DWH_PERIOD_TYPE (ID)
      ON DELETE RESTRICT
      NOT ENFORCED;

ALTER TABLE DTM_PROJECTION_FACT
   ADD CONSTRAINT FK_DTM_PROJECTION_REPORTING_BASIS FOREIGN KEY 
(REPORTING_BASIS_ID)
      REFERENCES DWH_REPORTING_BASIS (ID)
      ON DELETE RESTRICT
      NOT ENFORCED;

ALTER TABLE DTM_PROJECTION_FACT
   ADD CONSTRAINT FK_DTM_PROJECTION_SCENARIO_TYPE FOREIGN KEY 
(SCENARIO_TYPE_ID)
      REFERENCES DWH_SCENARIO_TYPE (ID)
      ON DELETE RESTRICT
      NOT ENFORCED;

ALTER TABLE DTM_PROJECTION_FACT
   ADD CONSTRAINT FK_DTM_PROJECTION_SPLIT_TYPE FOREIGN KEY 
(SPLIT_TYPE_ID)
      REFERENCES DWH_SPLIT_TYPE (ID)
      ON DELETE RESTRICT
      NOT ENFORCED;
