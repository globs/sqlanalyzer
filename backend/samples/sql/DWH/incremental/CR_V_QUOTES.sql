SET SQL_COMPAT='NPS';

DROP VIEW V_QUOTES;

CREATE OR REPLACE VIEW V_QUOTES AS
SELECT
    CAST(SCENARIO_ID AS SMALLINT) AS SCENARIO_ID,
    CAST(QUOTE_DT AS CHAR(10)) AS QUOTE_DT,
    CAST(QUOTE_ID AS CHAR(36)) AS QUOTE_ID,
    CAST(MATURITY_DT AS CHAR(10)) AS MATURITY_DT,
    QUOTE_RT,
    CAST(RISK_FACTOR_CATEGORY_CD AS CHAR(36)) AS RISK_FACTOR_CATEGORY_CD,
    CAST(ENTITY_CD AS CHAR(36)) AS ENTITY_CD,
    CURRENCY_CD,
    CAST(RATEINDEX_CT AS CHAR(20)) AS RATEINDEX_CT
FROM
    (
    SELECT
        SCENARIO_ID,
        QUOTE_DT,
        QUOTE_ID,
        MATURITY_DT,
        QUOTE_RT,
        RISK_FACTOR_CATEGORY_CD,
        ENTITY_CD,
        CURRENCY_CD,
        RATEINDEX_CT
    FROM
        (
        SELECT
            X.*
        FROM
            (
            SELECT
                NULL AS SCENARIO_ID,
                VARCHAR_FORMAT(c.EXC_D,
                'DD/MM/YYYY') AS QUOTE_DT,
                'SPOT' || '_' || c.SSDCUR_CF || '_' || c.CUR_CF AS QUOTE_ID,
                NULL AS MATURITY_DT,
                c.EXC_R AS QUOTE_RT,
                'FX' AS RISK_FACTOR_CATEGORY_CD,
                'SGL' AS ENTITY_CD,
                NULL AS CURRENCY_CD,
                NULL AS RATEINDEX_CT
            FROM
                (
                SELECT
                    DISTINCT a.EXC_D,
                    a.CUR_CF,
                    b.SSDCUR_CF,
                    a.EXC_R
                FROM
                    BI_<env>.TBOCURQUOT2 a
                INNER JOIN BI_<env>.TSUBSID b ON
                    a.SSD_CF = b.SSD_CF
                WHERE
                    EXC_CT = 'C'
                   
) c ) X ) d
UNION ALL
    SELECT
        NULL AS SCENARIO_ID,
        VARCHAR_FORMAT(ECONOMIC_RATE.VALID_FROM, 'DD/MM/YYYY') AS QUOTE_DT,
        'SGL_CURVE' || '_' || ECONOMIC_RATE.CURRENCY_CODE ||
        CASE
            WHEN LENGTH(CAST(ECONOMIC_RATE.MATURITY AS VARCHAR(10)))= 1 THEN '_0' || ECONOMIC_RATE.MATURITY
            ELSE '_' || ECONOMIC_RATE.MATURITY
        END || 'Y' AS QUOTE_ID,
        CASE WHEN ECONOMIC_RATE.MATURITY_TYPE_ID = 1 THEN varchar_format(ECONOMIC_RATE.VALID_FROM + ECONOMIC_RATE.MATURITY YEAR, 'DD/MM/YYYY') END AS MATURITY_DT,
        ECONOMIC_RATE.RATE AS QUOTE_RT,
        'IR' AS RISK_FACTOR_CATEGORY_CD,
        'SGL' AS ENTITY_CD,
        ECONOMIC_RATE.CURRENCY_CODE AS CURRENCY_CD,
        ECONOMIC_RATE.ECONOMIC_DATA_AS_OF_DATE AS RATEINDEX_CT
    FROM DWH_ECONOMIC_RATE ECONOMIC_RATE
    INNER JOIN DWH_PARAMETER_TYPE PARAMETER_TYPE ON PARAMETER_TYPE.ID=ECONOMIC_RATE.PARAMETER_TYPE_ID AND PARAMETER_TYPE.CODE = 'YC'
    WHERE  DATE(ECONOMIC_RATE.VALID_TO) = '9999-12-31'
    AND ECONOMIC_RATE.MATURITY_TYPE_ID = 1
    AND ECONOMIC_RATE.LOB_CODE = 30
);