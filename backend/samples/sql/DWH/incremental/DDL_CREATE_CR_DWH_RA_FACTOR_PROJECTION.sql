DROP TABLE DWH_RA_FACTOR_PROJECTION IF EXISTS;

CREATE TABLE DWH_RA_FACTOR_PROJECTION (
   REPORTING_BASIS_ID   SMALLINT,
   CLOSING_DATE         DATE             
      NOT NULL,
   SEGMENT_TYPE_ID      SMALLINT,
   SEGMENT_CODE         VARCHAR(16),
   SUBSIDIARY_CODE      SMALLINT,
   SUBLEDGER_CODE       SMALLINT,
   LOB_CODE             CHAR(2),
   GUARANTEE_CODE       CHAR(3),
   SOB_CODE             CHAR(2)               
      NOT NULL,
   TOP_CODE             CHAR(3)               
      NOT NULL,
   COUNTRY_OF_RISK_CODE CHAR(3),
   CEDENT_NUMBER        INTEGER,
   LEVEL_OF_ANALYSIS_ID INTEGER,
   CALCULATED_POSITION_ID INTEGER,
   TERM_TYPE_ID         SMALLINT,
   COVER_TYPE_ID        SMALLINT,
   BUSINESS_MATURITY_ID SMALLINT,
   BASIS_TYPE_ID        SMALLINT,
   ACTUARIAL_MODEL_TYPE_ID SMALLINT,
   IS_PRESENT_VALUE     BOOLEAN,
   LIFE_TREATY_TYPE_CODE VARCHAR(5),
   FINANCING_TYPE_CODE  VARCHAR(5),
   IAS39_CODE           SMALLINT,
   USGAAP_CODE          SMALLINT,
   TYPE_OF_BUSINESS_CODE SMALLINT,
   BUSINESS_MATURITY_FLAG VARCHAR(4),
   IFRS17_PORTFOLIO     VARCHAR(40),
   IFRS17_SUB_PORTFOLIO VARCHAR(40),
   TRANSITION_MODE      VARCHAR(20),
   INITIAL_PROFITABILITY VARCHAR(20),
   PROJECTION_YEAR      SMALLINT              
      NOT NULL,
   PROJECTION_PERIOD    SMALLINT              
      NOT NULL,
   PERIOD_TYPE_ID       SMALLINT              
      NOT NULL,
   FACTOR               DECFLOAT,
   HASH_KEY             VARBINARY(64)         
      NOT NULL,
   VALID_FROM           TIMESTAMP             
      NOT NULL,
   VALID_TO             TIMESTAMP             
      NOT NULL,
   PIVOT_KEY            VARBINARY(64),
   SUPP_DATE            TIMESTAMP,
   CREATED_REQUEST_ID   BIGINT,
   MODIFIED_REQUEST_ID  BIGINT,
   DELETED_REQUEST_ID   BIGINT,
   CONSTRAINT PK_DWH_RA_FACTOR_PROJECTION PRIMARY KEY (HASH_KEY, 
VALID_FROM)  
)
 in TBS_<env>  DISTRIBUTE BY hash(HASH_KEY);

COMMENT ON COLUMN DWH_RA_FACTOR_PROJECTION.SEGMENT_CODE IS
'Code of the segmentation is the short label of the segmenation';

COMMENT ON COLUMN DWH_RA_FACTOR_PROJECTION.SUBSIDIARY_CODE IS
'Code filiale';

COMMENT ON COLUMN DWH_RA_FACTOR_PROJECTION.SUBLEDGER_CODE IS
'Code Ã©tablissement';

COMMENT ON COLUMN DWH_RA_FACTOR_PROJECTION.SOB_CODE IS
'Code SOB';

COMMENT ON COLUMN DWH_RA_FACTOR_PROJECTION.TOP_CODE IS
'TOP code';

COMMENT ON COLUMN DWH_RA_FACTOR_PROJECTION.TYPE_OF_BUSINESS_CODE IS
'CASE WHEN TCONTR.RSKCOMPRM_B is true THEN 82 WHEN TCONTR.RSKCOMPRM_B is
 false THEN 80 END ';

COMMENT ON COLUMN DWH_RA_FACTOR_PROJECTION.IFRS17_PORTFOLIO IS
'mapped to GRPIFRSSEG_CT from TSECIFRS and TRETIFRS
';

COMMENT ON COLUMN DWH_RA_FACTOR_PROJECTION.IFRS17_SUB_PORTFOLIO IS
'mapped to GRPIFRSSEG1_CT from TSECIFRS and TRETIFRS
';

COMMENT ON COLUMN DWH_RA_FACTOR_PROJECTION.TRANSITION_MODE IS
'GRPINIPRO_CF from TSECIFRS and TRETIFRS';

COMMENT ON COLUMN DWH_RA_FACTOR_PROJECTION.INITIAL_PROFITABILITY IS
'mapped to GRPINIPRO_CF from TSECIFRS and TRETIFRS
';

ALTER TABLE DWH_RA_FACTOR_PROJECTION
   ADD CONSTRAINT FK_PARAMETER_BUSINESS_MATURITY FOREIGN KEY 
(BUSINESS_MATURITY_ID)
      REFERENCES DWH_BUSINESS_MATURITY (ID)
      ON DELETE RESTRICT
      NOT ENFORCED;

ALTER TABLE DWH_RA_FACTOR_PROJECTION
   ADD CONSTRAINT FK_RA_FACTOR_PROJECTION_POSITION FOREIGN KEY 
(CALCULATED_POSITION_ID)
      REFERENCES DWH_POSITION (ID)
      ON DELETE RESTRICT
      NOT ENFORCED;

ALTER TABLE DWH_RA_FACTOR_PROJECTION
   ADD CONSTRAINT FK_RA_PROJECTION_ACTUARIAL_MODEL_TYPE FOREIGN KEY 
(ACTUARIAL_MODEL_TYPE_ID)
      REFERENCES DWH_ACTUARIAL_MODEL_TYPE (ID)
      ON DELETE RESTRICT
      NOT ENFORCED;

ALTER TABLE DWH_RA_FACTOR_PROJECTION
   ADD CONSTRAINT FK_RA_PROJECTION_BASIS_TYPE FOREIGN KEY 
(BASIS_TYPE_ID)
      REFERENCES DWH_BASIS_TYPE (ID)
      ON DELETE RESTRICT
      NOT ENFORCED;

ALTER TABLE DWH_RA_FACTOR_PROJECTION
   ADD CONSTRAINT FK_RA_PROJECTION_COVER_TYPE FOREIGN KEY 
(COVER_TYPE_ID)
      REFERENCES DWH_COVER_TYPE (ID)
      ON DELETE RESTRICT
      NOT ENFORCED;

ALTER TABLE DWH_RA_FACTOR_PROJECTION
   ADD CONSTRAINT FK_RA_PROJECTION_PERIOD_TYPE FOREIGN KEY 
(PERIOD_TYPE_ID)
      REFERENCES DWH_PERIOD_TYPE (ID)
      ON DELETE RESTRICT
      NOT ENFORCED;

ALTER TABLE DWH_RA_FACTOR_PROJECTION
   ADD CONSTRAINT FK_RA_PROJECTION_PROJECTION_BY_LOA FOREIGN KEY 
(LEVEL_OF_ANALYSIS_ID)
      REFERENCES DWH_LEVEL_OF_ANALYSIS (ID)
      ON DELETE RESTRICT
      NOT ENFORCED;

ALTER TABLE DWH_RA_FACTOR_PROJECTION
   ADD CONSTRAINT FK_RA_PROJECTION_REPORTING_BASIS FOREIGN KEY 
(REPORTING_BASIS_ID)
      REFERENCES DWH_REPORTING_BASIS (ID)
      ON DELETE RESTRICT
      NOT ENFORCED;

ALTER TABLE DWH_RA_FACTOR_PROJECTION
   ADD CONSTRAINT FK_RA_PROJECTION_SEGMENT_TYPE FOREIGN KEY 
(SEGMENT_TYPE_ID)
      REFERENCES DWH_SEGMENT_TYPE (ID)
      ON DELETE RESTRICT
      NOT ENFORCED;

ALTER TABLE DWH_RA_FACTOR_PROJECTION
   ADD CONSTRAINT FK_RA_PROJECTION_TERM_TYPE FOREIGN KEY (TERM_TYPE_ID)

      REFERENCES DWH_TERM_TYPE (ID)
      ON DELETE RESTRICT
      NOT ENFORCED;
